hey there how's it going everybody in this video we'll be learning how to use email to allow users to reset their passwords so first we'll show how we can generate a secure timesensitive token to ensure that only a specific user can reset their password and then we'll see how we can send an email with that reset password information so let's go ahead and get started so first let's look at how we can generate a secure timesensitive token that we can use to make sure that only someone who has access to the user's email can reset their password so to do this we'll be using the package called it's dangerous which should have been installed when we installed flask so let's open up our command line and see how this is going to work so I'm going to open a Python terminal here and now I'm gonna do a long import here so I'm gonna say from it's dangerous and that's all one word import and this import is timed JSON web signature and you have to get this camel casing correctly as well serial Lizer and we'll import that just simply as a serial Lizer so if I spelled that correctly then we shouldn't get any errors and now we're going to use this serializer and pass in a secret key and an expiration time in seconds so to do that I can say s is equal to serializer and we will pass in a secret key of just secret for now and then a time expiration time of 30 seconds and now to generate a token we can use the dump s method and I'm going to send in a payload that will just be our user ID so we can say token is equal to s dot dump s and we'll pass in a payload that is a dictionary and that dictionary will be our user ID so we'll set a user ID and we'll just pass this in as 1 for now because we're just looking at an example and now we're gonna want to decode this to utf8 or else it will be in bytes so I will say decode and decode that with utf8 and run that so now we have a token with an expiration of 30 seconds so if I look at this token then we can see it's a long random string of characters now to check if this is a valid token then we can use the load s method and as long as it's been less than 30 seconds then this should give us our payload so I'll say s dot load s and pass in that token and we can see that we got that payload of the user ID of 1 now if we were to wait longer than 30 seconds then this token will be expired so if I waited a bit and then tried to rerun this so now I'm going to try to reload this token and if it has been more than 30 seconds then we get an error that says that the signature is expired so that's good because it allows us to handle expirations and tokens without needing to put all of that in a database and make things more complicated than they need to be so now let's open up our database models and I'm gonna add some methods to our user model that creates and validates these tokens for us so if we open up our project and navigate to our models dot py file here and I already have this open then I'm going to go down to our user model and actually first let's import the same classes that we used in the command line so I'm just going to grab that import so that I don't have to type it all out again and paste this in to the top of our models py file so we can see that we are importing this timed JSON web signature serializer as serializer now we're also going to need our apps secret key so let's import app from our package and we're already importing DB and login manager from our flash blog package so let's just include app on to the end of that okay so now within our user model now I'm going to create some methods here that make it easier to create these tokens so I'm gonna create one method called get underscore reset underscore token and we will take in self and expires underscore seconds for how many seconds until it expires and I'll pass in 1800 for now and 1800 seconds is just 30 minutes so now let's go inside of our method here and we will create a serializer object so we'll say s equals serializer and now we pass in our secret key so in our example in the command line we just used the string secret but now we're actually going to use our app secret key so we'll say app dot config and access that secret underscore key and now we need our seconds and expiration time so that will be expires seconds which again the default is 1800 or 30 minutes and now we can return a token created with this serializer so we can say returned and now we need to create our token so like we saw before this is s dot dump s and now we need to pass in a payload and again we're going to use a user ID for this payload and the user ID that we are going to use is the instance of this user so that'll be self dot ID and again now we can decode this into utf8 and so I will pass that in now if you are unfamiliar with methods or what this self variable here is then I would suggest watching my objectoriented series where I go over all of that in detail I won't touch on those object oriented specifics in this flask series so we saw everything here before in our command line we're simply setting this up with our secret key and an expiration time and which by default is 30 minutes and then we're returning that token which is created by the dump s method and it also contains a payload of the current user ID so now let's put a method in place that verifies a token so I can come down here and say def verify underscore reset token and then we will take in a token as an argument and now we'll create a serializer object again with this secret key but we don't need to pass in the expires seconds this time now we could get an exception when we try to load this token the token could be invalid or the time could have expired or anything like that so we'll put this in a try except block so we will try to get the user ID by saying s dot load s and load that token and we'll try to get the user ID out of that and remember that user ID comes from the payload that we passed in now if that does not run smoothly and we get an exception then we will catch that exception and we will simply just return none from this method and if we are able to get this user ID without throwing an exception then let's just return the user with that ID so we'll say return user dot query dot get and we will get the user with that user ID so again we have this verify reset token that takes a token as an argument and just creates a serializer and then tries to load that token if we get an exception it returns none if we don't get an exception then it returns the user with that user ID now one more thing here is we can see that this method doesn't do anything with the instance of this user so for example it never uses that self variable and again I go over this and my objectoriented series but when you have a method like this we need to tell Python that this is a static method and we can do that with a simple decorator just by creating a static method right above the method name basically we're just telling Python not to expect that self parameter as an argument and we're only going to be accepting this token as an argument okay so now we have a way to generate and validate tokens so now let's actually create the routes for a user to reset their password and also see how to send an email with a link that they can use to do that so first of all we're going to need two new forms for our routes and these are going to be extremely simple forms so let's open up our forms dot py file and I'll come down here to the bottom of this file to create a new form so first we're going to want a form when they first go to the reset password page where they can submit their email for their account where the instructions for resetting their password will be sent so I'll create a form here called request reset form so we can say class request reset form and remember this is going to import from flask form just like our other forms and inside here we're just going to want one email field and a submit button so I can actually just copy this email field from one of our other forms here and paste it in and now we also want a submit button so I will grab another submit button here and paste it in but the label that we want for this is going to be request password reset and let's also validate that an account exists for this email address now if we don't have an account for this address then they haven't forgot their password they just haven't created an account and this is going to be similar to the validation that we do upon registration so let's just grab that from the registration form so if I go up to our registration form and copy this validate email and paste it in to our request form here except the difference here is going to be instead of checking if the email already exists we want to check if the email doesn't exist so instead of saying if user here when we filter by this email we want to say if user is none and now let's also change the validation message as well so instead of saying that this email is taken we can say there is no account with that email you must register first okay and we're also going to want a form for when they actually do reset their password and that will be a form with two password fields where they can type their new password and then confirm that password and this is similar to the password fields when they first created their account so I'll grab those from the registration form and then we'll paste those in and a bit so I will grab these two forms here and paste those into a new form that we are about to create so I will create a new form here and we'll call this class reset password form and then this will inherit from flask form like we've seen before and now I'm going to paste in those two fields the password and the confirm password field and we're also going to want a submit button so I will grab that from one of our other forms here and paste this in but we want to change the label here for this submit button and we will just change this to reset password okay so now we need to create the routes and the templates that will handle these so first let's do the routes so I'm going to open up routes top py file here and I'll come down actually first we need to import those new forms that we just created so right after our post form I will import the request reset form and I will also import the reset password' form now if your imports ever get extremely long and you want to break them up onto multiple lines then you can put them within parentheses here and then simply just break them up on multiple lines so I can break that there and save that and now that is fitting on the screen there so now let's go down to the bottom to create our new routes and our first route here will be where they actually enter their email address where the reset password information should be sent so let me get a another route here as a starting point so I will just grab one of these so I'll grab the new post route here and paste this in at the bottom so first of all the login required won't be required here so I'll take that out now the URL for this route we will set that equal to reset underscore password for methods we want both get and posts so that's good now for the function name instead of reset password let's actually call this reset request because we're going to have another route that is reset password' as well where they're actually going to change their password but this is going to be the route where they're just putting in their email for us to send that information and this is going to be another route where we want the user to be logged out in order to get to this page so we'll put in the same check here that we put into our login route so if we go up to our login route and see what that was I know there's a lot here then that was this line here so if current user is authenticated then just return a redirect to the home URL so we can paste that in to our new route to make sure that they're logged out before they reset their password and now let's create our form so we will say form is equal to and that is the request reset form and now we can render a template so I will grab this line up here and just as a starting point so we'll say render template now that we haven't created this template yet but we will create it in just a second and we will call this reset underscore request dot HTML and we want to pass in a title here so we'll say the title is equal to reset password and we also want to pass the form that we are using into that template as well so we'll say form is equal to form and since we've done this a few times now it should be coming kind of familiar how we do this and pass these forms to these templates okay so now let's create this template that we just rendered here so I will in my templates folder right click and do a new file and we'll say reset request dot HTML and these templates are going to be very similar to some of the templates that we currently have with forms so I'm going to open up the code from the login template and use that as a starting point and then change what I need so I'm going to copy all of the code from the login template and paste it into our reset request dot HTML template so now we have the code from our login Simplot and now let's change this to be what we need for our request reset so first I will scroll up and change the legend so here we have the legend on the line seven so instead of login I want this to be reset password and within this form we only have an email and a submit field so the first field that we have from our login form is already set to email so let's just keep that and everything else we can get rid of so I'll get rid of the form group for the password and I will also get rid of this div for the form check so we can get rid of that as well and we can keep the submit button there and we can also remove the text here for asking if they have forgot their password because that is going to be the route that we're currently on and we can also remove this div where it's asking if they need an account okay so that should be good for our request reset form and again if you are following along and think that you may have missed something then I do have the final versions of all these files for each video that you can download and the link to that is in the description section below okay so that is good for creating the route where the user will request to reset their password now let's create the route where the user will actually reset their password so I will go back to our routes here and now we'll create a route where the user actually resets their password now to make sure it's actually them we need to make sure that the token that we gave them and the email is active and we'll get that token from the URL so by sending them an email with a link containing this token we will know that it's them when they navigate to this route so I'll keep this route similar to the one that I just created but I'll also accept a token so I'm going to copy what we have here and paste it in and also get that section to make sure that they are logged out so I will paste that in here now this route is going to be similar to the one before except we are going to also accept a token as a parameter so the URL here will be forged slash reset underscore password forged slash and then we will accept a token as a parameter there and we also need to pass that in to our function and now we need to rename our function name here so let's call this reset token so that we're sure which route this is sooooo reset request will be the route where they enter their email to request a password reset and reset token will be where they actually reset their password with the token active so now at this point when they go to this URL we'll try to verify the token from the URL using the user method that we created just a minute ago so down here we can say the user is equal to user dot verify underscore reset token and we can pass in that token from the URL and just reminder if we look at our models not py file here this verify reset token just takes in a token as an argument and if it is valid then it will return the user with that user ID and remember that user ID was the payload that we passed in to the initial token so that is how that works so if we don't get a user back here then it means that our token is either invalid or it is expired so we can put in a conditional here and we could say if user is none or we could say if not user however you want to do it we can say if user is none then let's flash a message to our user that says that is an invalid token and just so they know it can be expired as well we can say invalid or expired token and then we can pass in a class here or a category that we're going to use as a class and we'll pass that in as a bootstrap warning class which is a yellow outlined alert and if they have an invalid or expired token then we will just return them back to that reset request page so we'll do a return for a redirect and that redirect will be the URL for whoops and that URL for will be for the reset request but if we make it past this conditional here then it means that the token was valid and that we were able to get that user so they we can display the form for the user to update their password so we will come down here and say the form is equal to reset password form and then we'll render a template for them to actually reset their password so I'll say return render template and I'll just copy the code from this rendered template here since it's so similar and paste this in but instead of this being the reset request dot HTML we will set this equal to reset token dot HTML will keep the title as reset password and the form we will pass in as well which will be this reset password form okay so now let's create this reset token template so I will copy that and create a new file and our templates I'll call this reset token dot HTML and this is going to be similar to our reset request form so I will just copy that from the reset request template and then paste that in the reset token template so we'll leave this legend as it is at reset password and now we don't have an emailed field anymore we only have the password and the password confirmation fields so I'll replace this email field and I'll do a multiselect here to make sure that I get all of these in your editor you could do a find and replace to replace this so I will change all of those emails over to a password field and now I'm going to copy this entire div for this form group and now I want to add in the confirm password field as well so I'm going to select all of the password fields in this div and that field we called confirm underscore password and save that ok and after we have a password field and a confirm password field there then everything else should be the same so we'll leave the submit button there and everything else is good ok so now we have to be able to handle what happens when we submit these forms that we've just created and these forms will submit back to the same route that they were rendered from and we're used to seeing that by now so let's go a validate on submit conditional to our routes to handle these forms being submitted so within our reset request route right after we create our form we'll handle this if the form was submitted and validated so we can do our normal conditional of if form dot validate on submit then at this point they have submitted an email into our form so now let's grab the user for that email so we'll say user is equal to user dot query dot filter by and we want to filter this by the email is equal to form email dot data and now that'll put the query together and now we just need to specify that we just want the first user with that email okay so after we have that user we're going to want to send this user and email with their token that they can use to reset their password so now we need to learn how to send emails so for now I'm just going to create a function that will leave empty while we talk about what we need to send emails so I'm going to create a function right above here that is called send reset email and we will take in a user as an argument to that function and for now I'm just going to put in a pass statement here and we will fill out the logic for that in just a second so now in our validate on submit conditional I'm going to say send reset email and pass in that user and now we can send a flash message here and in our message we'll just say an email has been sent with instructions to reset your password and then we will pass in a class of info which is kind of a blue alert button and after we send them that email to reset their password then we'll just redirect them back to the login page so I'll say return redirect and we want to redirect them to the URL for login okay so now we need to actually fill out this logic and learn how to actually send this email now to do this we're going to use another flask extension and this one is called flask mail and we can install this with pip so if we open our terminal here I'm going to exit out of our Python interpreter and we can install this simply by saying pip install flask male and once that's installed let's pull up the double underscore an it dot PI file in our package since that's currently where everything is initialized and configured so I will open up this an it dot PI file and within here let's import that extension so we'll say from flask underscore male import male and now we need to also set some constants here so this is going to be how our app actually knows how to send mail so we're going to need a mail server a mail port whether to use TLS and also a username and password for that server now I'm going to be using Gmail in this example but if you have another one then you can use that as well and if you want to use Gmail and don't have an account then you can create an account and use the same constants with your username and password that I use in this video so for these constants I'm going to come down here below our login manager and now I'm gonna say app dot config and set these config variables so the first one is going to be mail underscore server and we will set that equal to SMTP dot goggle mail.com now I will copy and paste this line the next configuration variable here will be mail port we will set the mail port equal to 587 and lastly we're going to have a configuration variable here of mail underscore use underscore TLS and we will set that equal to true now for the username and password I'm not going to actually type those out here for obvious reasons because I don't want anyone to have access to my email so for this information I put this in an environment variable and I have a video on using environment variables to hide sensitive information for things like this so if you don't know how to do this then I would give that video a watch I show how to do it for both Mac Linux and Windows so first to use the environment variables I need to import the OS module so at the top of our module here I'm going to import OS and now I can set these variables by changing this to male username and that username is going to be an environment variable so I'm going to say Oh s dot environment it and I set that as an environment variable that is just equal to email underscore user and I will do the same thing here for my email password so I'll say app config mail password and that has to be spelled all the way out and for my environment variable here I only did an email underscore pass okay and once we have these five configurations set then we can initialize our extension and we can initialize our extension just like we've done the others so I'll say mail is equal to mail and we'll pass in the app to initialize that okay so now that we have all of that set let's open back up our routes dot py file and now we're going to need our mail instance that we just created in our anit dot pi file so let's go import that so here at the top of our file where we're importing everything else from our package we can add that on to our import so from flask blog import mail and we're also going to want to send an email message so we need to import the message class from flask mail as well so down here at the bottom I'm going to say from flask underscore mail import message okay so now let's go down to our send email function that we just created down here close to the bottom this is getting a little large so let's fill in this function to send the user and email with the reset token so first let's get that token using the method that we added earlier to our user model so we can say token is equal to user dot get underscore reset token and if we look at our models we can see that that takes also an argument for the seconds to expire but it has a default there as well so we're just going to leave that as the default and not pass anything else in and now we want to send the email with the URL with the reset token so we can create our email using the message class that we just imported so we can say MSG for message is equal to message and first this is going to be the subject line so we can say password reset request and now we can specify the sender now I'm just going to set a sender equal to no reply at demo dotcom now you want to be careful here not to spoof a sender because if you pretend to be somebody that you're not then you're gonna end up in the spam folder so try to have something that's coming from your domain or something that's actually coming from your email address okay and now we can pass in the recipients so I will do recipients are equal to and now this is going to be a list of recipients but we're just going to have one here and that is going to be the user dot email and let me break these up onto multiple lines here so that we can see everything and I will put that on another line as well okay okay so now for the actual body of our message I'm going to use a multiline string for that and I'm going to use F strings but again if you're not using Python 3.6 or higher then you'll need to use string formatting here so to do this I'm going to say message dot body and I'll set this equal to a multiline string and you can do that with three quote marks there and now I'll just pass in a message that says to reset your password visit the following link and then on the next line here I am going to pass in the value for URL for now we only want one curly brace here because this is an F string and I forgot to add that F there so when we're passing these variables into an F string we only have one curly brace it's not the two curly braces that were used to seeing in these Jinja two templates so I'll say URL for and this will be the URL for the reset underscore token route and we want the token to be equal to the token that we got up here from this user now we need to add in one more argument here and this is going to be underscore external and we're going to set this equal to true and now just to continue our message here I will write at the bottom of this email if you did not make this request then simply ignore this email and no changes will be made and then I'll just bring this back here to the baseline there now when you're working with a multiline string like this then you do need to bring this text back to the baseline here because if you tab these over then those tabs will actually show up in the screen or in the string so you want to make sure that these are back at the baseline now the reason that we're using this external equal to true here is in order to get an absolute URL rather than a relative URL because relative URLs are fine within our application and that's what it normally returns but the link in the email needs to have the full domain now depending on how complex your email message is you can actually use the Jinja two templates to piece these messages together as well now I didn't feel like this message was long enough to need to do that here but perhaps if your message is complicated enough that that's something that you'll want to do so if anyone wants to see where we use templates to create these message bodies then maybe we can tackle that in a future video okay so we're almost done here so now we just need to handle the form submission when they actually changed their password and this will be very similar to how we set their password when they first registered their account so I'm gonna go to the register route and I'm gonna grab a bit of code from there so if I go up to the register route where is it at here it is then I'm just gonna grab this entire if form validate on submit conditional all the way down to the return statement and now let's paste this below if I go down to our reset token route let's paste this below where we are creating that form so if I paste that in there then there are only going to be a couple of differences here so first of all we already have the user from where we verified the token so we can remove this line where we're getting the user and again that's because we have the user up here already and also instead of adding this user to the database like we did in the register route we're instead just going to edit their password and set it to this new hashed password so we can remove this DB session dot add part and instead just say user dot password is equal to this hashed password and it's just hashing that password from our form password dot data which we do have a password field in this reset password form so that'll work so then whenever it does this DB session commit then it will commit the changes to that user's password and lastly let's just update this flash message so instead of saying your account has been created let's say your password has been updated and then leave the part where it says you are now able to log in and then redirect them to the login page so that's good okay so last quick step before we run our application and test all this out we need to actually add a link to the reset past Paige in our application now if you remember back to one of our earlier videos we put a forgot password link on the login page but the link didn't actually go anywhere and this is usually where you'll find the links to reset your passwords is somewhere in the login area so let's go set that location to our reset request route so that was within our login template and I have my login template open here and that was towards the bottom of our page so if we look at the bottom of the page then we can see here on line 43 is where we have that forgot password link and I will change that from being a filler to our actual URL so I will put in the double curly braces and say URL four and we want the URL for the reset underscore request route okay so we didn't really get to look at our application at any of the inbetween steps in this video and that's because a lot of this process really all depends on all these different parts but that should be the last change that we just made to this template so now let's start up our application and test all of this out and if we did everything correctly then this should work so let's start our application so I'll go back to our command line here and do a Python run dot pi and we didn't get any errors so that's good and our debug server is running then now we can test out whether or not this works so if we go to our login page here then we can see that we have our forgot password link here now that should be beside the login button it's not a big deal but if I open up the login template this forgot password small tag here should actually be inside this form group right beside our submit button and that will put that actually beside at the button so if I save that and reload the page then we can see that now that's beside the login button so if I click on the forgot password link then it takes us to our reset password route and we can put in our email and request a password reset so I'm going to require a password reset for Cory M Schaefer at gmail.com so I will request that password reset we can see that we got a notice alert here that says an email has been sent with instructions to reset your password so I actually have my gmail pulled up in another Chrome window here so if we check this and refresh this then we're not getting any messages yet so let's see if something is wrong here so let's pull back up our application and go to our routes where we are sending this email so let me look in this send reset email function here and okay I can already see what the problem is here I made a dumb mistake we created the message and everything but we didn't actually send it so we need to use that mail variable that we imported from our double underscore and knit dot PI file and we need to use that to actually send the message so we'll say mail dot sinned and we will pass in that message that we created that we want to send okay so sorry about that okay so now let's go back to our application and see if that is working now so our development server is still running and I will pull up our flask app and send this again so I'll do forgot password and type in that same account that I signed up to this application with request password reset okay so we can see that we got the same alert that an email has been sent with our instructions so now I have my gmail pulled up here and we can see that that already came through so we got this password reset request email if I open this up then we can see that it says to reset your password visit the following link and we have this huge token here on the end so if I click on that then since our token was valid we can see that we are now here to our reset password form but if this token wasn't valid or if this token was expired because it was older than 30 minutes which was the expiration time that we put on this token then it would redirect us back to I believe the reset password route so if I was to change one character up here then we can see that it redirected us back to this request password reset form and says that that is an invalid or expired token so now I'm just going to hit the back button to go back to the valid token and now since we have a valid token we should be able to reset our password so my password was testing and now I'm just going to set it to password which is never a good idea but just an example so reset password and now we can see that we got an alert that says your password has been updated I spelled that wrong sorry about the typos but now let's see if we can log in with our new password so Cory M Shafer at gmail.com and I changed my password password okay so I was able to log in with that new password and we can see that I have access to my account and everything now I'm just going to go back and change that small little typo that I had there and that was within our reset password link and I'll say your password has been updated instead of update but other than that the functionality worked well we got our email and we're able to reset our password with our valid token okay so I think that is going to do it for this video I hope that now you have a good idea for how you can handle resetting passwords and also how to send mail through a flask application and in the next video we will clean up our application a little bit by learning how to organize different parts and to flask blueprints and also how to move our configuration variables into one single place but if you have any questions about what we covered in this video then feel free to ask in the comment section below and I'll do my best to answer those and if you enjoy these tutorials and would like to support them then there are several ways you can do that the easiest way is to simply like the video and give it a thumbs up and also a huge help to share these videos with anyone who you think would find them useful and if you have the means you can contribute through patreon and there's a link to that page in the description section below be sure to subscribe for future videos and thank you all for watching you you