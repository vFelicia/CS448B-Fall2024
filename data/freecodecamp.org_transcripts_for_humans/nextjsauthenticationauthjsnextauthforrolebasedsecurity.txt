With timestamps:

00:00 - this course is your ultimate guide to
00:01 - mastering the world of role-based
00:04 - authentication in nextjs using OJs this
00:08 - course provides you with the most
00:10 - up-to-date coverage on the latest
00:12 - features of nextjs guiding you through
00:14 - the implementation of authentication on
00:17 - both server rendered and client rendered
00:20 - pages and it shows you how to leverage
00:22 - out of the box oof providers like Google
00:25 - and GitHub as well as creating your own
00:28 - custom authentication provider using
00:30 - mongodb Jacob lower teaches this course
00:33 - he is a popular instructor on topics
00:34 - related to nextjs let's start learning
00:38 - what is up freec code Camp it's Jake
00:40 - lower again here to show you another
00:43 - nextjs video in this one we're going to
00:45 - cover authentication we're going to show
00:47 - you simply how to put authentication in
00:50 - your nextjs application so we're going
00:52 - to spin up a blank application and then
00:55 - we're going to spin up authentication
00:58 - immediately in that application we're
01:00 - going to use buil-in oo providers of OJs
01:04 - like GitHub and Google that we all use
01:06 - and then in the end we're also going to
01:07 - show you how to roll your own login
01:10 - system using mongod DB we're going to
01:13 - also investigate ro-based authentication
01:16 - as well so you'll be able to give admin
01:18 - roles and different things like that
01:20 - we're going to cover how you can secure
01:22 - server side Pages as well as client side
01:24 - pages to cover all your authentication
01:27 - needs in this one video if you like
01:29 - these type of videos they come out on my
01:31 - Channel first Clarity coders check that
01:34 - out as well as our website Clarity
01:36 - coders dcom let's not waste any more
01:38 - time and Jump Right In All right so here
01:41 - we are in Visual Studio code I'm not
01:42 - going to do a lot of setup you can watch
01:44 - one of my other videos for exactly how
01:46 - you can get some of this installed make
01:48 - sure you have no JS have some
01:50 - familiarization with nextjs projects
01:52 - would probably be helpful I also used a
01:54 - couple extensions that'll show really
01:56 - quick this es7 plus react redex code
02:00 - Snippets it's very useful I'm going to
02:02 - use it a lot in this video so you can go
02:05 - ahead and download that prettier as well
02:07 - for formatting code uh you can see the
02:09 - others in here that I use feel free to
02:11 - freeze and install those if you would
02:13 - like let's go ahead and spin up this
02:17 - project so I'm going to open up a new
02:19 - terminal you can code along with me I
02:21 - really feel that's the best way to learn
02:23 - so that's how I like to do these
02:24 - tutorials and let's do MPX create next
02:28 - app we'll go ahead and click yes to
02:32 - proceed we can call this project
02:37 - our next off tutorial or whatever you
02:41 - would like I'm not going to use
02:43 - typescript so you're you're able to
02:46 - convert this typescript if you'd like
02:47 - I'm going to select no I would recommend
02:49 - if you're following along to do the same
02:51 - I'm going to use eslint Tailwind yes
02:54 - Source directory I'm going to say no app
02:56 - router yes and would you like to
03:00 - customize the default Alias no so we'll
03:03 - let that spin up this project and then
03:05 - we have should have some boiler plate to
03:06 - work with great so now we have our
03:09 - project spun up you can see where it
03:11 - created the project file I want you to
03:13 - go ahead and open up that folder and
03:14 - then we'll continue on from there so if
03:16 - you're using visual studio code you can
03:18 - do file open folder and then pop open
03:21 - that window and you should end up with
03:23 - something that looks like this so now we
03:26 - have our project folder open I'm going
03:27 - to do one more install here so I've
03:29 - opened another terminal let's go ahead
03:31 - and install next off CU we're obviously
03:34 - going to use that so we'll do mpm I next
03:38 - dash
03:41 - off and then let's take a quick look at
03:43 - our package.json here you can see my
03:46 - exact dependencies you can copy these if
03:49 - you want them to work perfectly so you
03:51 - can see I'm using
03:53 - 13.5.3 any version above this should be
03:56 - okay um if not try installing with this
04:00 - exact version and that could help uh
04:03 - same with
04:05 - nexo now let's get to cutting down this
04:08 - app a little bit let's expand the app
04:11 - folder let's go out to our Global
04:14 - CSS let's delete all of this in here and
04:19 - then I will save we only really are
04:22 - going to use two things let's go ahead
04:24 - and set it up just so we're done with it
04:25 - so we'll do at layer base bam we can do
04:29 - an H1 which we're going to use just to
04:32 - make things look a little more like
04:35 - we're used to we'll do font bold text-
04:39 - 3XL just for the correct text sizing
04:42 - just so it looks a little better then
04:44 - we'll also do an a tag we'll do at apply
04:48 - let's do
04:49 - underline and
04:51 - font bold and again this will just help
04:55 - kind of visualize what we're doing as
04:57 - we're doing it nothing too crazy here
05:01 - and then let's open up our page I'm
05:03 - going to go ahead and contr a and just
05:05 - delete all this out and this is where my
05:08 - extension is going to come in handy I'm
05:09 - going to do rafc a lot that's that code
05:13 - snippet one that I showed you and then
05:15 - control shift L and this can just be our
05:18 - homepage so I'm going to change all
05:20 - these at once nothing crazy here and we
05:23 - can close that close our Styles we
05:26 - should be actually done with those
05:28 - honestly let's rename this to page. jsx
05:32 - just so it's consistent there and then
05:34 - let's create all of our other Pages for
05:36 - our application I'm going to Showcase
05:38 - some different types of authentication
05:40 - on some different types of pages so
05:41 - that's why we have multiple so let's do
05:44 - new folder here we are going to have a
05:47 - member page so this is a private
05:50 - protected page for only people who have
05:52 - signed up so we'll do a member folder
05:55 - and then a new file in here that we'll
05:57 - call page. jsx and then on that member
06:03 - page we can do
06:05 - rafc just like before control shift L
06:09 - and we will do member and then let's add
06:12 - in H1 tags
06:16 - here and this is going to be our
06:20 - member server session so remember if we
06:24 - don't add Ed client up above our import
06:27 - statements it's going to render the p p
06:29 - on the server side so this is going to
06:31 - show you how we can protect a server
06:34 - side page on our
06:37 - application so let's create a new folder
06:39 - and then as you probably could guess
06:41 - we're going to do a client member page
06:44 - so let's create a client member folder
06:47 - and then I'm just going to copy this
06:49 - page paste it in here we'll close this
06:52 - one out to make sure that we're using
06:54 - the right one and then you'll see this
06:56 - is our client member page so let's let's
06:59 - use a member cant session for this one
07:04 - and then of course to ensure that this
07:07 - is rendered on the client side we have
07:10 - to explicitly tell that we want to use
07:13 - the client side so I'm showing you this
07:15 - this shouldn't be your default you
07:16 - should never just default to rendering a
07:19 - page on the client side but there are
07:21 - certainly occasions where you'll have to
07:23 - so this is our example of that we are
07:26 - also going to have a denied page so most
07:32 - of the time we're going to Route people
07:34 - to a login if they have't authenticated
07:37 - but what if they have authenticated and
07:38 - they just don't have permissions in
07:41 - role-based
07:42 - authentication in that scenario we're
07:44 - going to direct them towards a denied
07:46 - page so let's just create another folder
07:49 - at that application Level for denied
07:51 - we'll create a new page. jsx inside of
07:56 - this here we can do rafc
08:00 - contrl shift L we'll do
08:06 - denied we'll use H1 tags for
08:10 - this again just because make it look a
08:14 - little better there and then we will do
08:18 - a tiny bit of styling now this is this
08:21 - is a stretch when we're calling this
08:24 - styling but let's say text-
08:27 - red- 400 so this will just be a red
08:30 - denied that we send people to if they
08:32 - don't have the correct authentication
08:34 - for our page and then let's do one other
08:38 - so this is going to
08:40 - be eventually our page that's protected
08:42 - by roles so only an admin eventually
08:45 - we'll be able to go to this page so
08:47 - let's create a create user folder and
08:53 - then inside of that let's create a new
08:57 - file called page.
09:01 - jsx and then r a
09:04 - c control shift
09:06 - L and we will call this create
09:12 - user we'll say only
09:15 - admins now this is eventually it's not
09:18 - going to work like that out of the gate
09:19 - but we have our structure in place I
09:22 - think that's most of the pages that
09:24 - we're going to need in this project as
09:27 - well so we should good there let's
09:30 - create another
09:32 - folder so let's say new folder we're
09:34 - going to use uh open parentheses and
09:37 - then
09:39 - components o
09:42 - compon like
09:44 - that and then new file let's do our
09:48 - navigation. jsx I'm going to use a
09:51 - capital N with this this will just be
09:54 - our navigation bar up top that we can
09:56 - get set up now we can do our normal
10:00 - rafc that all looks pretty
10:03 - good now instead of here we're going to
10:06 - do a little more coding this time to get
10:07 - this set up and then we should be good
10:09 - to go let's do a header let's also do
10:11 - nav
10:13 - tags so for our header let's do class
10:17 - name we're not going to do we're going
10:19 - to do almost no styling but BG gray 600
10:25 - and then text Gray 100
10:30 - should be good and then on the nav side
10:34 - let's do class name is
10:38 - flex justify
10:41 - between items
10:48 - Center width is
10:51 - full let's do a px of 10 and finally a
10:56 - py of four that should be
11:00 - good let's close out of this terminal
11:03 - window for now just so it's a little
11:04 - less distracting and we'll go inside our
11:07 - nav tags here so for the first div let's
11:10 - just do my site and then for the second
11:14 - div and our only other component in here
11:17 - let's do a class name of
11:21 - flex gap of
11:24 - 10 that should be good then we're going
11:27 - to add in some links
11:30 - make sure you're doing the import as
11:31 - well so I'm going to tab complete here
11:33 - and that should do the
11:35 - import you'll see that it did import
11:38 - link from next link we need an href for
11:41 - this so we already created our homepage
11:44 - it's at
11:46 - slash we can call this
11:50 - home let's copy this so we got home we
11:54 - got create user member only client let's
11:58 - do a public page page so we got home
12:01 - then next let's do our create user
12:05 - page now remember eventually this will
12:08 - only
12:10 - be for admins so we'll do create
12:14 - user let's do our client member
12:21 - page so again this should be protected
12:23 - you have to be logged in you don't have
12:25 - to be an
12:26 - admin let's do our member
12:30 - page this is almost the exact same thing
12:33 - except it's rendered on the server
12:34 - instead of on the client
12:36 - side and then let's do a public page
12:40 - which is completely
12:41 - unprotected we'll do public
12:45 - here that looks pretty good now we can
12:48 - go ahead and go into our layout JS we're
12:51 - almost ready to get into nextjs this is
12:54 - the last tiny bit of setup here so let's
12:57 - delete out the Google fonts we don't
12:59 - care about that we don't care
13:02 - about
13:04 - that and then make sure you kill the
13:08 - reference to the Google fonts as well
13:11 - should be good and cleaned up you can
13:12 - change this if you'd like we're not
13:14 - worried about it here we got our HTML we
13:17 - got our
13:19 - body let's do a class name of
13:22 - BG gray 100 so this is just the
13:26 - background let's import our nav ation
13:30 - let's do nav like that make sure you do
13:32 - the import here so I'm going to tab
13:34 - you'll see it imported our component
13:36 - from above we can self close so slash
13:39 - and then our greater than sign and then
13:43 - let's just wrap this in a div as well
13:46 - this these children here just so we can
13:48 - do one other tiny bit of
13:50 - formatting div this class name let's do
13:54 - a margin of two on it should be good to
13:57 - go okay so we did some coding we got the
13:59 - structure set up we're going to work in
14:01 - next off next let's open our terminal
14:05 - just make sure this runs let's do mpm
14:08 - runev we got no errors that is a good
14:12 - sign let's check it out in the browser
14:14 - we're going going to go to local hoston
14:18 - 3000 dang look at us web development who
14:22 - says I can't style applications this is
14:24 - beautiful you can tell what page we're
14:26 - on by the our little reference that page
14:29 - so you see we have a create user client
14:32 - member
14:34 - member and our public page we didn't do
14:37 - anything with the public page let's fix
14:39 - that up and let's just check real quick
14:42 - we should have a denied one as well yes
14:45 - so we are all good there let's make a
14:47 - quick change to the public page just so
14:49 - we can reference that we're on it oh I
14:52 - didn't route to it at all did I yeah not
14:55 - found I didn't create the public page so
14:58 - new full folder let's do public inside
15:02 - here new file page. jsx
15:07 - rafc control shift L let's do
15:10 - public delete that
15:13 - out put our H1
15:16 - tags just like we did for the others I
15:19 - didn't for the create user because we're
15:20 - going to do something else that we're
15:21 - actually going to create users towards
15:23 - the latter half of this okay so we
15:26 - should be all good we got all of our
15:28 - pages we don't have any authentication
15:30 - set up whatsoever but we're going to get
15:33 - into that next let's go ahead and jump
15:36 - into that so we know we need to create
15:39 - an API folder and that's going to be
15:42 - what next off looks for so let's create
15:46 - API folder inside of that we need to
15:50 - create another folder called op inside
15:53 - of that so I'm right clicking on off
15:55 - here new folder I'm going to use square
15:59 - brackets and then inside of those square
16:01 - brackets I'm going to do dot dot dot
16:03 - three dots next off and then inside of
16:07 - this you'll typically see one of two
16:09 - things so you might have a route well
16:11 - you need to have a route. JS and you
16:13 - might have an options. JS which are
16:15 - going to lay out the options of your
16:18 - project so we're going to follow that
16:20 - format so let's create a new file and
16:24 - let's do route.
16:26 - JS and then in the same name folder so
16:29 - inside that next off off folder we're
16:31 - going to create options. JS as well
16:35 - let's start with the route. JS just so
16:37 - we don't forget it is the simpler of the
16:40 - two because we're going to import in our
16:42 - options so let's do an import I'm going
16:45 - to close out my terminal just because
16:46 - it's distracting let's do import next
16:51 - off tab auto complete you can see I'm
16:53 - getting next Das off SL next I don't
16:57 - know that I want that let's delete out
16:59 - the slash next let's just do next off
17:02 - from next
17:03 - o and let's do import options plural
17:09 - from SL options so this is going to
17:13 - import our file from our other directory
17:16 - Zu const Handler equals next
17:20 - off options and then we're going to
17:25 - export Handler as get
17:30 - Handler as
17:32 - post now this is straight from the next
17:35 - off or aujs documentation so we're just
17:38 - setting this up basically how they have
17:41 - it set
17:42 - up I'm going to close out of these other
17:45 - tabs I actually think we're done with
17:47 - route. js2 I'll close out of that and
17:49 - now we can set up our options here so
17:52 - this options file is going to be where
17:54 - you import and set up how you want
17:57 - people to be able to authenticate with
17:59 - your application so we're going to start
18:01 - with two and these are builtin providers
18:04 - by next off so we don't have to do or we
18:07 - don't have to do very much setup with
18:09 - them so let's do
18:12 - import get Hub
18:16 - Provider
18:18 - from next-
18:21 - off/ providers
18:25 - slash
18:27 - GitHub
18:28 - let's copy that paste it
18:32 - below let's do this is a capital
18:35 - G Google
18:38 - provider and we're going to do the same
18:40 - thing except at the end it's going to be
18:43 - Google as well then let's do export
18:46 - const options
18:50 - equals
18:52 - providers colon square brackets so here
18:55 - we can add an array of the different
18:57 - providers that we'd like to use in our
19:00 - case we want to use the
19:04 - GitHub
19:06 - provider parentheses curly
19:09 - brackets and then inside of here we can
19:12 - set up anything that we would like for
19:15 - our GitHub so we can add extra roles we
19:17 - can add extra features or we can leave
19:19 - it as plain Jane as we want and just
19:22 - ship it that way but we are going to
19:26 - show you how you can add rolls as well
19:28 - while we're doing this so let's go ahead
19:30 - and add in a profile and we're going to
19:33 - be passed a profile back for we're going
19:35 - to get a profile back then we can do
19:38 - curly brackets and inside of here we can
19:41 - add extra logic so let's say
19:43 - console.log let's log out our profile
19:47 - let's make sure we know what it is too
19:48 - so we can say
19:50 - profile
19:53 - of
19:54 - GitHub and then we can log that now we
19:58 - want to add extra stuff to our session
20:02 - so one thing that we can do we can add
20:05 - extra logic that allows us to give
20:08 - specific roles to specific users now my
20:12 - user that we can use in this that I'm
20:13 - going to sign up for the application
20:15 - with is Jake Clarity coders
20:22 - docomo role is going to be GitHub user
20:25 - so let's do let user roll
20:29 - equal
20:31 - GitHub user so this is going to be the
20:33 - role for everybody but me but I'm going
20:36 - to say
20:38 - if my profile exists and it has an email
20:44 - and that email is equal to
20:47 - Jake Clarity coders dcom and you want to
20:51 - use your email here an email that you
20:53 - can actually test this at your current
20:55 - location to give yourself admin rights
20:57 - to to our test application so Sub in
20:59 - your email here so if our email equals
21:04 - Jake at Clarity go.com or whatever your
21:07 - email is then our user Ro is going to be
21:10 - upgraded to admin then we will return
21:13 - our new profile we're going to do dot
21:16 - dot dot so everything that was in the
21:18 - profile before we want to still be in
21:20 - the profile however we want a new role
21:24 - of our user role and that's it you see I
21:28 - controlled s there it got the formatting
21:30 - all right thank you prettier this is our
21:33 - GitHub provider so let's copy this so
21:36 - we're copying
21:38 - everything on the GitHub provider and
21:41 - let's paste it
21:43 - below and then let's set up our
21:46 - Google provider so for this one we're
21:50 - going to handle things pretty close to
21:53 - the same the only thing we don't want
21:54 - any extra logic so let's change this and
21:57 - let's say this is is our Google profile
21:59 - and you don't have to log these out this
22:01 - is just so you can see what's on them
22:02 - and that sort of thing so we're going to
22:04 - console.log that out no special roles
22:07 - for this and one small change with the
22:10 - Google profile we need an ID field and
22:12 - the Google profile does not provide one
22:15 - so let's set our ID equal to
22:18 - profile. sub this is going to be the
22:20 - idid that they pass back make sure to
22:23 - add a comma after this as well so we
22:26 - should be set up there as well now for
22:28 - each of these we have to have a client
22:31 - ID and a client secret that we're going
22:33 - to set up with these providers so we can
22:34 - utilize them in our application so on
22:38 - the level of the profile here after that
22:40 - profile we're going to hit enter here
22:42 - and for our GitHub one we're going to
22:45 - have a
22:46 - client ID colon and we're going to set
22:49 - it equal to process. EnV
22:54 - dog
22:55 - hubor ID let's copy this now these are
22:59 - environmental variables that we're going
23:01 - to set up that are not set up yet so
23:04 - this is going to be our
23:06 - client
23:07 - secret and this will be GitHub unor
23:13 - secret make sure to put commas after
23:15 - these and then we can copy them and down
23:19 - here on the Google one so we're after
23:20 - the profile we're going to add these in
23:23 - here except this will
23:26 - be a Google
23:31 - ID and a Google
23:34 - secret perfect so now these are set up
23:39 - that is looking good and we're going to
23:41 - make one more change out of the box here
23:45 - to ensure that we have our Ro available
23:48 - for us in this application we're going
23:50 - to set up some custom
23:52 - callbacks and this will essentially add
23:55 - our roll to the Token so we can utilize
23:58 - it in our programs so notice I'm after
24:01 - the square bracket comma I'm going to
24:03 - enter some callbacks here we are going
24:05 - to do
24:07 - async
24:11 - JWT parentheses curly brackets we're
24:14 - going to get a token and we're going to
24:16 - get a
24:18 - user and from that we can say if we have
24:21 - a
24:23 - user let's say the token. roll is equal
24:27 - to the US user. roll so this will allow
24:30 - us to add that token add that Ro onto
24:33 - our token so we can utilize it on the
24:36 - server side however we also want to be
24:38 - able to utilize this on the client side
24:41 - as well so we will do async
24:45 - session and here we can use
24:48 - session and our
24:52 - token and here we're going to
24:53 - essentially do the same thing we're
24:55 - going to
24:56 - say if
24:59 - we have a
25:01 - session.
25:04 - user let's set session. user. roll equal
25:09 - to token. roll and this will allow us to
25:12 - use it there then of course we need to
25:16 - return our session so we have it and
25:18 - then up here as I have forgotten let's
25:21 - also return our
25:23 - token and of course comma here awesome
25:27 - awesome so now we should have this set
25:29 - up so we got our providers set up we got
25:33 - our sessions set up everything looks
25:35 - great there now we need to set up our
25:39 - provider on the provider side so let's
25:41 - create a new file and this is going to
25:42 - be at the base level so it should be at
25:46 - the same level as your Tailwind config
25:49 - or the readme or whatever let's set up a
25:51 - new file let's go Dov
25:55 - dolal in here we can set up our
25:57 - environmental
25:59 - variables so remember they're going to
26:01 - look like this we want to utilize the
26:03 - same verbiage here so let's do Google
26:07 - ID Google secret like that and these are
26:10 - going to have equals
26:15 - afterwards we're also going to need a
26:18 - GitHub
26:19 - ID and a
26:22 - GitHub secret as well so we're going to
26:24 - set both of these up
26:26 - now all right so now if you are logged
26:30 - into your GitHub account you can go to
26:33 - github.com
26:35 - setting apps from here we're going to
26:39 - select oo
26:41 - apps and then we can
26:43 - create a new oo
26:47 - app we can name it whatever we would
26:50 - like so we can
26:51 - do next off video
26:56 - tutorial
26:58 - we can set up a homepage for it so we're
27:00 - going to do HTTP colon localhost colon
27:06 - 3000 and then we also need to utilize a
27:09 - callback URL so we're going to copy that
27:11 - paste it down below here it's going to
27:13 - be
27:15 - 3000i off callback SL GitHub you need to
27:22 - type it exactly like I did here and then
27:24 - we can register our
27:26 - application now now from here we're
27:28 - going to get a client ID and a client
27:29 - secret ensure that you do not use mine
27:32 - that won't work and make sure you don't
27:34 - have anything weird any spaces or
27:36 - whatever so we're going to copy this
27:38 - client
27:39 - ID and remember this is GitHub don't get
27:42 - them confused so we're going to do our
27:44 - client ID there and then let's generate
27:48 - a new client secret you might have to
27:53 - authenticate I'm going to copy that
27:55 - secret and then paste that as well so we
27:59 - now have our GitHub provider set up
28:01 - that's really it it's relatively easy
28:04 - and then we're going to do the same
28:06 - thing on the Google side of things so
28:08 - you're going to go to Google's developer
28:11 - console so it's console.
28:14 - developers.google.com and then from here
28:16 - we can go to
28:24 - credentials and we can create
28:26 - credentials and we're going to do an oo
28:29 - client
28:32 - ID we can say web application I don't
28:34 - know if it really matters we'll do
28:37 - a next off video
28:44 - tutorial don't miss this so we need an
28:47 - authorized redirect URI let's add that
28:52 - as you can guess it is HTTP col
28:56 - localhost colon 3000 SL API
29:01 - SLO SL
29:05 - callbacks call back rather slash
29:09 - gooogle API off call back Google let's
29:13 - go ahead and
29:14 - create so here you can see our client ID
29:19 - and our client secret let's go ahead and
29:22 - grab those so let's grab our client
29:26 - ID
29:32 - paste that
29:37 - in and let's do the same with the secret
29:39 - so we'll grab that and paste that in as
29:44 - well awesome so we should be all set up
29:47 - to authenticate with our application
29:49 - with whatever user we would like however
29:53 - we don't currently have any
29:56 - Authentication set up on the individual
29:59 - pages so we don't really have a way of
30:02 - knowing if we're authenticated or not
30:04 - and we also don't have a way to log into
30:06 - our application yet so let's go ahead
30:08 - and set that up first so inside of
30:27 - get
30:29 - server session down here tab complete
30:32 - from next off and then we can utilize
30:36 - that to see if we have an ongoing
30:38 - session right now at the moment so what
30:40 - we can do is right in here we can say
30:44 - const session equals
30:48 - await get server session and then we
30:52 - need to pass in our options so you see
30:55 - I'm going to autocomplete here but these
30:56 - are inside our API a blah blah blah that
30:59 - whole directory you can see it imported
31:02 - correctly and it's mad because I'm using
31:04 - an async function so I up here need to
31:09 - add a sync perfect so now we should have
31:13 - a session if we have a session which we
31:16 - don't right now because we haven't
31:18 - logged in so after the public
31:21 - page let's add curly brackets and let's
31:24 - check to see if we have a session so if
31:26 - we have a session we want to add in a
31:29 - link and we want the hre to equal and
31:33 - this is going to be our log out
31:36 - functionality remember if we have a
31:38 - session we're logged in let's do slash
31:41 - API SL off slash sign
31:46 - out and I'm going to add this so I'm
31:49 - going to add question mark call back
31:53 - Capital
31:54 - URL a capital u and then lowercase RL
31:59 - equals slash so this means when we sign
32:03 - out it's automatically going to send us
32:05 - back to the root of our directory let's
32:08 - close that link tag and we can call this
32:10 - log out now we're doing conditional
32:13 - rendering here so it's only going to
32:15 - render this again if we have a session
32:18 - so now we need to handle if we don't
32:20 - have a session which is what we
32:21 - currently have so let's do colon and
32:24 - then let's paste this in I'll save it so
32:26 - it wraps and you guys can see a little
32:28 - better so if we don't have a session
32:31 - then we want to be able to log in so
32:34 - we're going to go to the same page we're
32:36 - going to go to API
32:38 - SLO sign in this time so now we should
32:42 - be able to tell if we have a session
32:44 - because we'll either have a log in or a
32:46 - log out button we should not have both
32:49 - hopefully so let's go ahead and check
32:51 - this out so now back on our site so we
32:54 - have our site here loaded up you'll see
32:56 - we we do have a log in button we do not
32:59 - have a log out button which makes sense
33:01 - right because
33:03 - we do not currently have a session let's
33:06 - hit log in you'll see we get this nice
33:09 - built in now you can customize this
33:11 - that's not what we're going to cover in
33:12 - this tutorial but you can customize this
33:14 - but you see we got our two providers
33:15 - that we're able to log in with now
33:18 - remember if I log in with GitHub I am
33:20 - authenticated with my Jake at Clarity
33:23 - coder so that's going to be assigned in
33:25 - admin the other one will be a normal
33:29 - session it won't be my admin session so
33:31 - let's authenticate with GitHub you're
33:34 - going to have to authorize the first
33:35 - time you do it and you'll get redirected
33:37 - back to your application if this didn't
33:40 - happen correctly double check that you
33:43 - added that call back URL correctly to
33:46 - GitHub and likewise when you test it
33:48 - with Google the same way there you're
33:49 - going to have to make sure that you have
33:51 - a valid session there as well so now
33:55 - you'll notice that I did log in that did
33:57 - work
33:58 - correctly but I still have my login
34:00 - options so it's not showcasing a session
34:03 - at the moment so we did have the
34:05 - terminal still open you can see what our
34:07 - issue is it's throwing all kinds of
34:09 - Errors so what it's saying here more or
34:12 - less is that we haven't provided a token
34:14 - for our session so we have no secret in
34:17 - order to verify that this person is
34:19 - correctly signed in with our application
34:22 - and they didn't just create some bogus
34:24 - session themselves so what we need to do
34:27 - is inside ourv dolo we need to add a
34:31 - next off secret here so this is going to
34:34 - be called all capitals let's do next
34:39 - oore secret and we will set this equal
34:42 - to and then we're going to create one
34:44 - now you can type in random characters
34:46 - here and that would be fine but we want
34:49 - to make sure that we have a certain
34:52 - level of security here so open up your
34:54 - terminal if you don't you can kill your
34:55 - session if you're running it still from
34:57 - before and let's generate that secret so
35:00 - let's do open
35:01 - SSL Rand base 64 and we want 32 and then
35:08 - here you can see we generated a nice
35:10 - little secret don't use mine just create
35:13 - your own and then we have our next off
35:16 - secret here so we should be good now
35:19 - once you have that we can go ahead and
35:21 - spin up our server again so let's do mpm
35:23 - run
35:25 - Dev so now back on our site if you get
35:29 - any weirdness make sure you're shutting
35:31 - down your server turning it back on you
35:33 - can also try reloading this page and one
35:35 - other thing that I have to do from time
35:37 - to time when I'm playing around with
35:39 - cookies sessions and things like that
35:41 - hit control shift I if you're on Chrome
35:44 - and here you can go to the application
35:47 - Tab and under local storage session
35:51 - storage and cookies you can clear those
35:53 - out and that will sometimes help if it's
35:56 - cash in and air anything like that
35:58 - that's happened in the past I didn't
35:59 - have it this time but just so you know
36:02 - you can go through that
36:04 - process obviously we don't have a
36:06 - session right because we didn't have
36:07 - that next off Secret in here so that
36:09 - aired out so let's go ahead and try and
36:11 - log in again you can do it with whatever
36:12 - provider you would like I'm going to try
36:14 - with my GitHub
36:17 - again and you'll see that now we have a
36:19 - log out so we do have a session here
36:21 - which is awesome so if we go we don't
36:25 - have any protected page is right now at
36:27 - the moment so you can see our client
36:29 - member our server session we can still
36:32 - get to we can obviously still get to
36:34 - public let's go ahead and try and log
36:36 - out sign out and that goes back to the
36:39 - home directory and I have my log in so
36:40 - everything looks good but nothing is
36:42 - protected so let's get into protecting
36:45 - our routes we're going to do this in
36:47 - three ways right now so I'm going to
36:49 - quickly show you how to protect a server
36:51 - side page a client side page and then
36:54 - with our create user we're going to
36:56 - protect it with with middleware for
36:57 - right now and then we'll expand that to
37:00 - protect it to make sure you're an admin
37:02 - on top so let's go to it's really not
37:05 - that difficult let's go to Our member
37:07 - page first remember this is our member
37:10 - server side session so let's take a look
37:15 - here and we can set up a session so
37:18 - we're going to need to check to see if
37:20 - there is a session so we need to make
37:21 - sure you're logged in so session equals
37:24 - a wait get server session we'll do the
37:28 - Auto Import so I'm going to tab here and
37:31 - then I'm going to spit in our options
37:33 - remember let's tab complete here so it
37:36 - did those two Imports for us this also
37:38 - needs to be a sync that looks great then
37:43 - below here what happens if we don't have
37:45 - a session so if we don't have a session
37:48 - in this case so if there is no
37:52 - session then let's do a
37:55 - redirect and slide down so let's use the
37:58 - one from next navigation make sure
38:01 - you're looking at the redirect from next
38:02 - navigation we'll import that and we can
38:05 - redirect to SL API slof SL sign in
38:11 - question call back Capital
38:15 - URL equals SL member so what this is
38:18 - going to do it's going to redirect us to
38:20 - the login it's going to leave the call
38:22 - back URL so if they do log in they'll
38:25 - come back to this member page P so
38:27 - that's going to be a nice look nice and
38:29 - easy look so below here let's do just a
38:32 - little more let's add a P tag and let's
38:37 - say inside of here let's do curly
38:39 - brackets so if we're here we do have a
38:41 - session so let's say session question
38:44 - mark. user question mark. email so we'll
38:49 - spit out the email let's do that again
38:53 - and this time let's say roll so remember
38:55 - inside of our options on all these we're
38:58 - setting up a role of some sort so for
39:01 - our Google provider we are not setting
39:03 - up one so that's going to cause an error
39:06 - I'm going to minimize
39:09 - this so here we're setting up a user
39:13 - roll on our GitHub side of GitHub user
39:15 - unless you're me Jake at Clarity coders
39:18 - and then you're going to get an admin
39:20 - roll on the Google one we didn't so
39:23 - luckily we didn't try to O off with that
39:25 - if you did I'm sorry
39:27 - and we can paste in let user roll and
39:30 - let's say Google user paste that down
39:33 - there and now this should be working as
39:35 - well we'll test out Google just to make
39:37 - sure it works here down the road um but
39:39 - for right now that should be good and on
39:43 - the member page we should be protected
39:46 - now let's try it so let's go to our
39:50 - application you see we can go to public
39:53 - if we try to go to member it asks us to
39:56 - log in now make sure you're not already
39:57 - logged in um in this case let's do
40:00 - something different let's sign in with
40:01 - Google just to make sure that works
40:03 - since I did just find out that it
40:04 - probably isn't for you guys pick a
40:08 - Google account and you can see that our
40:09 - member session it has my email address
40:13 - and Google user there as well great so
40:17 - that works let's go to our client
40:19 - session now let's protect this it's
40:21 - going to be a little different because
40:23 - this is rendered the JavaScript is
40:25 - rendered on the client session on my
40:28 - client browser so we can't use the
40:31 - server side get that we were using
40:32 - before and I'll show you why before we
40:35 - go there I'm going to copy these two P
40:37 - tags let's go to our client member
40:41 - page we can paste them below so this
40:44 - will be if we have a session let's do
40:48 - get server
40:51 - session so if we do that you can see
40:53 - that we get all kinds of crazy errors
40:56 - well part of it's probably because I use
40:58 - this let's control slash I'll just
41:00 - comment this out for right now and then
41:03 - let's navigate to that page we'll go to
41:06 - create user and then I'm going to go
41:07 - back to client member session so now if
41:09 - we actually try to use get server
41:12 - session to get our session so let's do
41:14 - const session equals
41:17 - await get server
41:20 - session pass in our
41:25 - options
41:26 - you see we need to do an async
41:28 - function so let's do async and we save
41:32 - it we can uncomment
41:35 - this save that and let's go to our
41:39 - client member and you'll see we get an
41:41 - error a sync AWA is not yet supported in
41:44 - client components okay so we see our
41:46 - problem there that's why we can't do it
41:47 - the same so we can't do it in this
41:50 - format which is fine we have other
41:53 - options here so instead of of this so
41:57 - let's do
41:58 - import use
42:02 - session and we're going to do
42:04 - from next off SL
42:09 - react so this is going to be how we grab
42:12 - our session and then here we can grab
42:18 - const we're going to set data equal to
42:22 - session we're going to do equals use
42:25 - session
42:27 - parentheses curly
42:28 - brackets required equals
42:32 - true and then on
42:36 - unauthenticated so what do we want to do
42:38 - when we're unauthenticated we want to
42:40 - redirect make sure you're using next
42:42 - navigation again for your import
42:45 - redirect and we're going to do something
42:47 - very similar to what we did on the other
42:48 - page so we're going to do slash API SLO
42:52 - SL sign in question call back Capital
42:57 - URL equals SL
43:01 - client
43:02 - member just like that so we're good and
43:05 - if we control save this you'll notice
43:07 - that we're getting new errors right Ed
43:09 - session must be wrapped in a session
43:12 - provider member so this is a little
43:16 - complicated so the use session needs a
43:19 - session
43:20 - provider however the session provider
43:24 - has to be a client component as well so
43:27 - let's create a new file inside of our
43:29 - components and we will call this o
43:34 - provider.
43:35 - JS and this is going to use
43:40 - clients we are going to
43:43 - import
43:45 - session Provider from next o react so
43:49 - you'll see it did the Auto Import for me
43:51 - and we're going to do const off provider
43:57 - equals we're going to pass in our
44:01 - children then inside of here we're going
44:03 - to return our session
44:06 - provider
44:08 - and don't worry
44:10 - kids putting you right back in there we
44:13 - need to export default off provider like
44:18 - that so now we have our session provider
44:20 - in a client component so we're good to
44:22 - go there and we can go back to our
44:24 - layout page and here's where we need to
44:27 - wrap this bad boy to get our session on
44:30 - the client side now remember this is
44:32 - only if you need to do authentication on
44:34 - the client side if you want to do it on
44:35 - server side we're good
44:37 - already so here let's utilize our
44:42 - off provider this should be coming from
44:46 - components
44:48 - directory and then we're going to wrap
44:50 - this around our children div
44:54 - here like so now I don't have to wrap my
44:58 - nav in it because I'm not using client
45:00 - side on that you could certainly it
45:03 - might even be better actually to wrap
45:05 - this around your entire body just in
45:07 - case we can do that I didn't need to for
45:10 - mine but you might down the road so we
45:13 - can wrap this off provider I believe
45:16 - around the whole body like that and that
45:18 - should function as well and then if you
45:19 - have any client rendering here on the
45:21 - nav side you can do that now again shy
45:24 - away from client side rendering if you
45:26 - can but if you have to um you can go
45:29 - that route so now we have an off
45:30 - provider here so our client member
45:33 - should have a session now um and it
45:36 - should you should need to be
45:37 - authenticated so let's go back to this
45:41 - let's just go back to Local Host you'll
45:43 - see we got home uh we are logged in so
45:46 - if you go to the member you can see that
45:48 - we're still my email a Google user if I
45:52 - go to client member now you'll see it
45:55 - has the the
45:56 - same both member server session and
46:00 - client session are the same I'm both
46:02 - authenticated form now if I log
46:05 - out and I go to client member it is
46:08 - protected now so that is good okay
46:11 - what's middleware so if we don't want to
46:14 - protect our Pages inside of each page we
46:17 - can set up mid middleware on our project
46:20 - and that will allow us to add
46:22 - authentication rules in one spot that we
46:25 - can easily find so let's create a new
46:27 - file this is going to be on the same
46:28 - location ASV dolo and let's call it
46:31 - middleware
46:33 - DJs we can do
46:36 - export and then
46:38 - default this is not what we're going to
46:40 - stick with but we can do export default
46:43 - from next off SL middleware so this
46:48 - right now will protect everything so
46:51 - everything on our page will be protected
46:53 - then we can export
46:56 - config equals let's do a matcher and
47:00 - then we can pass in an array of URLs
47:03 - that we want to test and here we can
47:05 - protect create
47:07 - user okay so right now we have it set up
47:10 - so our create user should be protected
47:12 - now you can see that's a lot easier than
47:14 - adding it on the page or anything like
47:16 - that and if we go here let's go ahead
47:20 - and log in just with my Gmail so
47:22 - remember I'm a regular user right now
47:25 - okay now back back to our application
47:27 - let's see if our create user is now
47:29 - protected so you'll remember we're still
47:31 - logged in so make sure you're
47:32 - authenticated if you're not you can tell
47:34 - because you have your printout here
47:36 - let's go to create
47:38 - user and you'll see that I can get to it
47:42 - now I'm not on my admin account but we
47:43 - haven't done that yet so it's just
47:45 - protected from normies so let's go ahead
47:48 - and log out sign out and now we don't
47:52 - have any session so if I go to member it
47:55 - tries to loog Lo me in if I go to create
47:58 - user now it tries to log me in so that
48:01 - is great so we've successfully protected
48:03 - this with middleware however we still
48:06 - are not protecting it from normal users
48:10 - we only want this to be admin so let's
48:12 - make that change let's go ahead and log
48:16 - out and then we'll go back to our code
48:19 - here so we're going to do some new
48:22 - Imports so let's say with off I'll tab
48:25 - here you can see my import that I'm
48:27 - going to get with o above and let's also
48:30 - do next
48:33 - response and this is coming from next
48:36 - server now we should have all of our
48:38 - Imports We need oh my gosh I was on the
48:42 - wrong
48:43 - page don't do that so let's leave our
48:46 - create user alone if you had that open I
48:49 - apologize let's close out of all of
48:51 - these I don't make that mistake again
48:59 - so we're back on our
49:01 - middleware page so on our middleware
49:03 - page we're going to do those same two
49:05 - Imports that we just did so we're going
49:07 - to do with off and next response so
49:10 - let's save that and you can see that we
49:12 - got our two Imports done and then we're
49:14 - going to make some changes to this file
49:17 - I'm going to leave the matcher on here
49:19 - because I only want this to apply to
49:21 - that page I'm going to delete this out
49:23 - and start fresh so I'm going to do X
49:25 - Port
49:27 - default with off now inside of this I
49:31 - want to create a function for my
49:34 - middleware and I'm going to get a
49:37 - request when I visit a page and we can
49:40 - console log out some information here
49:43 - that might help you with future requests
49:45 - or things that you want to do custom
49:47 - wise so let's
49:48 - console.log let's do our request. next
49:54 - url. PATH name name so this will show
49:56 - you what our path is so if you're trying
49:58 - to do some logic here that may help and
50:01 - then let's also use or at least log out
50:07 - next request. next off. token. roll and
50:14 - that could help us do some
50:15 - troubleshooting as well now let's
50:17 - actually Implement our logic so remember
50:19 - again you can you can do any
50:21 - customization you want here um anything
50:23 - that makes sense with you but this is
50:25 - what we're going to do to protect this
50:27 - one create user page and make it only
50:31 - admins so let's say if in here we want
50:34 - to use our path name so let's copy this
50:38 - we're going to say if request. paath
50:40 - name so if we add other paths it might
50:41 - not you know might have different logic
50:43 - or whatever so let's say if it
50:46 - starts
50:50 - with create user and we want one other
50:55 - test here and we want to make sure our
51:03 - roll does not
51:07 - equal admin then let's do curly brackets
51:11 - let's save this just so it formats I'll
51:14 - fix that okay so here's our logic here's
51:16 - our if statement so we want to say if
51:19 - we're going to the create user page and
51:21 - you're not the admin so if you're not
51:24 - the admin and you're trying to go there
51:26 - let's just return next
51:30 - response.
51:34 - rewrite let's do a new
51:37 - URL and we'll go to the denied
51:43 - page
51:44 - request.url so what we're going to do is
51:48 - we're going to send them to that denied
51:49 - page we created earlier now we could
51:51 - send them to a login page but they're
51:53 - already logged in this is for if they
51:56 - don't have the correct role so they
51:58 - shouldn't probably shouldn't be able to
52:01 - just log into a different account so if
52:03 - that is the case we're going to send
52:04 - them to the deny page if not this will
52:07 - continue on and they will be authorized
52:11 - so let's add a comma here let's do call
52:15 - backs colon curly brackets let's say
52:19 - they are
52:22 - authorized if they have a token
52:28 - and that token is not null so we want to
52:30 - make sure they have some sort of
52:33 - a some sort of a token here we actually
52:36 - need to wrap this in curly brackets as
52:39 - well I believe I'm going to highlight
52:41 - this wrap it in curly brackets and save
52:44 - and you should have something that looks
52:45 - like this so now we have our callback
52:48 - function set up we have our middleware
52:52 - all set up actually so we should be good
52:55 - let's take a look let's go back to our
52:57 - project we got all kinds of Errors let's
53:00 - refresh So currently it does not look
53:04 - like we're logged in let's go ahead and
53:06 - log in with a non-admin account so if we
53:09 - log in with our Google account in my
53:11 - case yours might be different we go to
53:14 - member you can see that our role is
53:16 - Google user if we go to create user
53:20 - you'll see that now we get a denied
53:22 - let's log back out and this time I'm
53:25 - going to log in with
53:27 - GitHub you'll see that I do have an
53:30 - admin session here which is great and if
53:32 - I go to create user you can see that I
53:35 - do in fact get to the create user page
53:38 - so we should be good there so what we
53:40 - have now is we have ooth provider set up
53:44 - for GitHub and Google and we have
53:45 - role-based authentication for both
53:47 - server rendered pages and client
53:49 - rendered Pages as well as ro-based
53:54 - Authentication so we are good there now
53:57 - you might be asking yourself well what
53:59 - if I have a database already or what if
54:01 - I want to create a database of users
54:04 - that allows people to either use their
54:06 - email or pick a username and a password
54:08 - and set that up that isn't covered in a
54:11 - lot of these tutorials because it's a
54:12 - little more advanced and you have to
54:14 - factor in things like validating email
54:16 - or whatever it might be but I'm going to
54:18 - show you how you can set that up connect
54:20 - it to a database relatively quickly and
54:23 - get it at least spun up and in place we
54:26 - are not going to cover validating emails
54:28 - so you need to keep that in the back of
54:30 - your mind that this is more like a
54:32 - username not necessarily an email
54:34 - address I can pick Jake gmail.com even
54:36 - though that is not my email address
54:39 - let's go ahead and
54:42 - kill our
54:45 - terminal and then we'll do the remaining
54:49 - Imports for this project so let's do
54:54 - mpmi mongod
54:58 - DB
55:00 - mpmi
55:04 - mongus and MPI
55:07 - B
55:10 - Crypt awesome now we got that set up
55:14 - let's go ahead and sign up for a mongod
55:16 - DB Atlas database now this is
55:23 - free so if you have haven't used it
55:25 - already go ahead and sign up for a
55:28 - mongod DB Atlas account you should come
55:31 - to a page like this you can
55:33 - authenticate with very similar providers
55:35 - to what we're setting up you can see how
55:37 - popular they are so I'm going to go
55:39 - ahead and log into
55:41 - mine now if this is your first time you
55:44 - might get some popups wanting to spin up
55:45 - a database right away blah blah blah you
55:47 - can skip all that hopefully eventually
55:49 - you'll come to a page like this and what
55:52 - we want to do is up in in at least right
55:55 - now in the top left is to create a new
55:59 - project we're going to call this next
56:02 - off video tutorial in my case I'm the
56:06 - project owner let's create our
56:09 - project then once you get that created
56:11 - we can create a deployment so let's do
56:15 - create you can do the free
56:18 - tier and then hit create you're going to
56:21 - want to set up a username and password
56:24 - here so on the next screen it gives you
56:25 - an option to set up a username and
56:27 - password note these down so inside your
56:30 - EnV you can note these down I have admin
56:33 - and then a password below so if I go
56:35 - back to my
56:37 - code inside. EnV let's just paste these
56:40 - in here for right now let's say admin
56:42 - and then our
56:43 - password you'll want to add your current
56:46 - IP address as well so we're going to add
56:50 - that ah I forgot to hit create user Make
56:54 - sure you hit create create
56:56 - user and then finish and
56:58 - close go to
57:00 - overview and now you should have your
57:02 - database set up so we're going to go
57:04 - ahead and hit connect if you don't have
57:06 - this there should be a connect button
57:09 - somewhere or you might have to let
57:11 - provisioning finish so once that's
57:13 - finished you can hit connect we're going
57:15 - to hit drivers and then we're going to
57:17 - copy this string down here now back in
57:20 - our code we're going to paste that
57:23 - string in here pretty long you'll notice
57:25 - it already has admin switch that out for
57:27 - your username if you didn't use admin I
57:30 - did so I'm not going to change it and
57:32 - then we're going to copy our password
57:34 - and paste in our password use your
57:37 - password not mine obviously and then
57:40 - here we're going to call this in all
57:43 - caps mongod dbor
57:48 - urii we're going to set that equal to
57:51 - this
57:52 - string if we slide to the back I'm going
57:54 - to delete this back half so after the
57:57 - question mark and I'm just going to call
57:59 - this app DB like that that should be it
58:03 - so our EnV is set up there that looks
58:06 - good we can go ahead and close out of
58:09 - that now let's create a new folder so in
58:13 - parenthesis we're going to say
58:16 - models inside of here we're going to
58:18 - create a new file called capital u
58:22 - user.js so we're going to find what a
58:25 - user looks like in our system so we're
58:27 - going to import
58:28 -  and curly brackets scheme a from
58:35 - mongus and we're going to use mongus doc
58:40 - connect process.
58:43 - env. mongod
58:49 - dbor mongus do promise with a capital P
58:54 - equals
58:55 - global.
58:57 - promise then let's do
59:00 - const user
59:02 - schema equals new
59:06 - schema do curly
59:09 - brackets so let's just have a name and
59:11 - that's a string an email and that's a
59:15 - string a password you guessed it that's
59:19 - a string after this curly bracket let's
59:22 - do parentheses this is something I
59:23 - always do with my models let's do
59:26 - timestamps equals true this handles the
59:29 - create at and updated at dates so it's
59:31 - there for you if you ever need it and
59:34 - then let's create our user model so cons
59:36 - user equals mongus
59:39 - models. user or so this is if it's
59:43 - already defined or we use mongus
59:50 - dood and create the user from our user
59:55 - schema and let's export that so export
60:00 - default
60:03 - user spell default correct that looks
60:07 - good okay so we got our model we got our
60:09 - database set up now all we need to do is
60:11 - create our API for creating a user and
60:13 - then I'll show you how you can verify
60:15 - against your existing users as well so
60:19 - all we have left to do is to create the
60:21 - front-end form that can submit a new
60:23 - user then we'll create the API to add a
60:26 - user to our database when someone
60:28 - submits the form and then we'll add the
60:30 - credentials provider and show you how to
60:33 - validate that password let's create our
60:36 - user form now this is a little unique
60:39 - because we want this form to use client
60:41 - side rendering because a form interacts
60:45 - with the user with the JavaScript so you
60:46 - might have validation on the front end
60:48 - or whatever it might be
60:51 - user form. jsx X inside of our
60:56 - components
60:57 - directory and then on this user form we
61:00 - are going to use
61:02 - client we're going to import use router
61:06 - from next navigation not next router
61:10 - this mixes me up sometimes so let's
61:13 - change that to
61:15 - navigation then we're going to import
61:19 - react
61:21 - and use state
61:25 - from
61:27 - react
61:28 - const user form
61:33 - equals recreate our function like
61:37 - that and then at the bottom we'll export
61:41 - I didn't use my short keys I wondered
61:42 - what was weird about
61:44 - this export user form see I can do it
61:47 - guys all right then inside this we are
61:52 - going to have a con router equals use
61:58 - router we have a const form data this is
62:02 - where we're going to store all of our
62:04 - form data and we'll have a set form
62:08 - data we'll set that equal to use
62:12 - state with curly brackets inside so our
62:15 - form data is just going to be an empty
62:17 - object originally then we'll do const
62:21 - error message so we're not going to do
62:23 - much here
62:25 - but I will check to see if that user
62:28 - already that email is already in our
62:31 - database and then we can send a
62:32 - duplicate user type of error response
62:35 - back so we have an error message and a
62:37 - set error message equals use State this
62:42 - will just be a blank string to start out
62:44 - that makes
62:45 - sense we need to handle our change in
62:49 - our form and if you've done this before
62:52 - it's pretty straightforward we're coding
62:53 - it so it's it's pretty Dynamic doesn't
62:55 - really matter what our form values
62:58 - are I always do const value equals e.
63:03 - target.
63:05 - value copy that and I'll do
63:09 - const name equals e. target. name and
63:15 - then I will do set form
63:17 - data I'm going to pass in the previous
63:21 - state we
63:23 - want another set of parentheses there
63:26 - and then open curly brackets that looks
63:29 - better so when we change our state so
63:32 - this is anytime the state changes we're
63:34 - going to say previous state we're going
63:36 - to expand that so it's going to take
63:37 - everything from the previous state
63:39 - before and we're only going to overwrite
63:41 - the one change that we're making so
63:43 - whatever field on our form we're
63:45 - changing and whatever value we're
63:47 - setting it to we're going to override it
63:49 - with and that's our handle change that's
63:52 - it now from here we can do a
63:55 - const handle
63:57 - submit this equals an
64:00 - async
64:02 - function we're going to do e.
64:07 - prevent
64:09 - default we're going to reset our airor
64:11 - message so if we previously had a airor
64:14 - message we're going to set it back to
64:17 - blank at the start of submitting our
64:19 - form basically starting with a clean
64:23 - slate we're going to get a response from
64:25 - our own API that we haven't created yet
64:28 - so we're going to do con response equals
64:30 - a weit fetch then we're going to do API
64:34 - slash users with a capital u remember
64:38 - we're creating this in just a moment
64:42 - parenthesis nope sorry comma and then
64:44 - curly
64:45 - brackets we'll do our method equals post
64:49 - we're going to create a new user our
64:52 - body is going to equal json.stringify
64:56 - we're going to pass in the form data
64:59 - just like
65:02 - that we'll do content type and that
65:10 - equals application
65:13 - sljs okay almost done believe it or not
65:17 - so we're going to check to see if our
65:20 - response has an air so if our response
65:23 - does not equal
65:26 - okay then we want to get what the actual
65:29 - error was we're going to pass back an
65:31 - error here so we'll wait our
65:34 - response.
65:36 - Json and then we will set airor
65:40 - message to whatever was in our
65:43 - response. message and we'll show you how
65:46 - we're going to set that in just a moment
65:47 - so we're going to pass back some sort of
65:49 - an error we're going to catch it here
65:51 - and then we're going to set our error
65:52 - message this is only for an error
65:55 - remember we'll add an else so otherwise
65:59 - we want to do router.
66:03 - refresh and router. push and we'll push
66:07 - to the root directory so this is just
66:08 - going to send us back home and that's it
66:12 - so pretty straightforward nothing crazy
66:15 - here let's continue on and here we're
66:18 - going to do a
66:21 - return and let's do open and close let's
66:24 - do form tags inside of those our form is
66:28 - going to be pretty straightforward we're
66:30 - going to do onsubmit and we've done all
66:32 - the leg work now we're going to do
66:35 - handle submit that we already created
66:38 - our method equals
66:41 - post and our class name just a few
66:44 - Styles here going to equal
66:47 - Flex Flex call let's save this just so
66:50 - it
66:52 - formats and that's my prettier extension
66:55 - that helps me do that Flex Flex call Gap
66:59 - three let's do a width of a half let's
67:03 - do inside of this let's do H1 let's say
67:07 - create new
67:10 - user then below that we can start
67:12 - creating our inputs don't worry they're
67:14 - going to be very short let's do a label
67:18 - and that label is going to be full name
67:22 - then we'll have an input let's say input
67:24 - our ID equals
67:27 - name our name equals
67:30 - name on
67:32 - change equals handle change like
67:38 - so let's make it required equals
67:43 - true add another my closing tags there
67:46 - and then I also need a
67:49 - value which
67:52 - equals form
67:54 - data. name saving that so it formats
67:59 - beautiful and last but not least let's
68:02 - do a class name and we're going to copy
68:04 - this so M2 BG of slate
68:08 - 400 rounded watch any of my videos I'm
68:11 - not very good at styling so I just round
68:13 - corners like crazy I'm going to copy the
68:16 - label and the input paste it below this
68:20 - one is going to be our email
68:25 - so let's do email for an
68:28 - ID email for the
68:31 - name change the form data. email here as
68:35 - well everything else looks good so that
68:38 - should be good to
68:40 - go let's copy all of it
68:43 - again paste it
68:47 - below let's do password ID of
68:52 - password email form
68:55 - data and this actually has a type of
68:59 - password let's add that in these
69:02 - probably should have a type as well
69:03 - let's do a type equal to text for our
69:10 - email and also for our
69:13 - name okay that should be good to go
69:16 - there the last piece is our submit
69:18 - button so let's do
69:20 - input the type equals submit MIT the
69:25 - value will equal create
69:29 - user and the class name let's stylist
69:32 - just a tiny bit blue 300 with a
69:36 - hover
69:38 - of BG
69:41 - blue
69:43 - 100 self-closing tag so we'll do slash
69:46 - like
69:48 - that slide over so you can see again so
69:50 - we got our input button in the form we
69:52 - got the form you might have wondered why
69:53 - I wrap these all in closing tags
69:55 - remember the whole return has to be
69:58 - wrapped in some sort of tags and I'm
70:00 - actually going to do something below the
70:01 - form here so that's why I did that let's
70:04 - do p tags and then inside of here let's
70:07 - just print out our air message now this
70:10 - will print out a blank string um when
70:13 - there is no error but that's not a big
70:15 - deal to me so we're going to leave that
70:16 - there and then we'll change it to text
70:19 - red 500 this looks good
70:24 - think we're pretty good there should
70:26 - have closed out of that terminal a long
70:27 - time ago we got our user form created
70:30 - let's create the API so inside this API
70:34 - directory you see we have API off and
70:37 - then next off inside of API so I'm going
70:40 - to rightclick on API I'm going to create
70:43 - a new folder and inside this new folder
70:46 - I'm going to call it
70:48 - users and inside of that user folder I'm
70:53 - going to create cre a new file called
70:55 - route. JS now we're only going to do one
70:58 - function in here just to show you how a
71:01 - post would work I'm going to pull in
71:04 - next response from next server I'm going
71:07 - to use our user model so I'm going to
71:10 - pull that in as well you can see how it
71:11 - does it up here with the at symbol tab
71:14 - that now we got our user model and then
71:16 - finally we have to do a encrypt before
71:20 - we store it so we want to do import B
71:24 - Crypt from
71:27 - bcrypt now remember this you know we're
71:30 - not validating an email so in my mind
71:32 - this is like I run a company and I'm
71:35 - inputting a user that I know has access
71:37 - to that email address and that sort of
71:39 - thing you wouldn't want to do this in
71:41 - like a SAS application without
71:42 - validating the email address because
71:44 - someone could steal someone's email
71:46 - address that they don't have access to
71:48 - so let's export a
71:52 - sync
71:54 - function
71:56 - post and we're going to get a
71:59 - request let's do this all in a try catch
72:04 - and for our catch let's
72:07 - console.log our error that might help us
72:10 - if we make a mistake I'm sure we won't
72:13 - let's return um next response.
72:18 - Json in here we're going to use that
72:21 - message so we're going to use
72:24 - message and then
72:28 - err also return the error that looks
72:32 - good got a comma here another set of
72:34 - curly brackets let's also do a status of
72:37 - 500 if something goes
72:39 - wrong okay that looks good now our Tri
72:43 - block we're going to grab our body so
72:45 - we're going to const body equals
72:48 - await request. Json so we're going to
72:51 - pull off the information we're going to
72:53 - do const user data equals body.
72:58 - form
73:00 - data let's
73:02 - confirm that our data exists the fields
73:05 - that we need so we want to say
73:09 - if we do not have user
73:13 - data. email or if we do not have user
73:21 - data. password
73:24 - so if we don't have those fields we are
73:27 - going to return a message so we want to
73:30 - copy this we'll paste it in
73:32 - here we're going to say a status of
73:36 - 400 and then our message can be let's
73:42 - not send the error our message can be
73:46 - all fields
73:50 - are required so this shouldn't happen
73:53 - because we're sending it with that one
73:55 - form but down the road you change
73:57 - something now you'll know if you're
73:59 - getting information missing
74:01 - information so let's check for duplicate
74:04 - emails now so let's do a const we'll
74:08 - call it duplicate equals a wait we're
74:10 - going to use our model from above so
74:12 - user find
74:14 - one so we're going to see if we can find
74:17 - any
74:18 - email that has our you user data. email
74:24 - do
74:26 - lean and
74:29 - execute now we can check so if there is
74:33 - a
74:34 - duplicate then we want to send another
74:38 - response and we're doing kind of
74:40 - meaningful responses here too right so
74:43 - that's uh that's kind of a cool setup
74:45 - that we have going we can do a status of
74:49 - 409 and we can
74:52 - do
74:55 - duplicate email now it's probably worth
74:57 - noting here that we're also you might
74:59 - want to be careful and make sure that
75:02 - you're using um that you're checking all
75:04 - your emails case insensitive so you
75:06 - might want to lowercase all of them
75:08 - before you add them to the database or
75:11 - something like that because right now
75:13 - you could have unique emails that just
75:15 - have capitalization differences or
75:17 - whatever it might be so keep that in
75:21 - mind CL this that looks better so now
75:26 - for here we know we don't have a
75:27 - duplicate user we know we have all the
75:30 - fields we need let's create our
75:34 - hash password equals await
75:38 - bcrypt
75:40 - do and then we're going to pass in user
75:44 - data.
75:46 - password you can do as many salt rounds
75:48 - as you want I always see 10 so you
75:50 - probably shouldn't use 10 but that's
75:53 - what what we'll use const and then user
75:57 - data. password so now I'm overwriting
75:59 - the plain text password with our new
76:01 - hash password here so now our user data
76:05 - contains our hash password we shouldn't
76:07 - be saving plain text passwords and we
76:09 - can await user.
76:13 - create and we can pass in our user data
76:18 - dang was longer than what I thought but
76:20 - we got her
76:21 - done so we create created the user data
76:24 - let's copy a response we still want to
76:26 - send a response our
76:30 - message delete this can be user
76:35 - created and our status can probably be
76:41 - 2011 awesome so this should be all we
76:45 - need to create a
76:48 - user so let's go ahead we've done a lot
76:51 - let's go ahead and test that
76:54 - make sure user gets created successfully
76:56 - and then we can try and authenticate
76:57 - with that user after we add the
76:59 - credential provider which we haven't
77:01 - done either so mpm run
77:05 - Dev okay so we got our website here I
77:09 - got to see who I'm logged in as I am
77:12 - logged in as an admin so if you've added
77:14 - this authentication and it's Ro based
77:16 - you have to have admin now to go to
77:18 - create user if you haven't done this you
77:21 - can assign admin to someone else
77:24 - else I'm going to go to create user this
77:26 - is only admins duh because I didn't
77:28 - update that so back on our create user
77:32 - page instead of only admins let's render
77:36 - our user form see it did the import for
77:40 - me self closing
77:45 - tags that is pretty who says I can't
77:48 - style okay so let's create a new user
77:53 - Bob
77:55 - Bobby
77:56 - Bob
78:00 - bob.com password test of
78:04 - course and create
78:07 - user kind of looks like it worked Google
78:10 - does not like my password it's been used
78:12 - in a security breach so that's worth
78:15 - noting um but it looks like it worked
78:18 - okay so let's go back to our
78:21 - database and I will click on
78:24 - database now we didn't name our
78:27 - collection so it's probably going to
78:28 - give a test collection which is fine oh
78:30 - no we did appdb we have a user you can
78:33 - see we do have a user now awesome so we
78:35 - have Bob Bobby Bob bob.com and a nice
78:39 - hashed password so one step left here we
78:43 - have to be able to authenticate with
78:44 - Bobby now so let's log out we don't have
78:47 - a credential provider at all so we can't
78:49 - log in with a username and password
78:51 - let's change that
78:53 - so we're going to open up options let's
78:56 - go ahead I'm going to shut down this
78:57 - terminal just because I'll forget it's
79:00 - running and then we'll be on the wrong
79:01 - thing and close out all these just for
79:03 - you
79:04 - guys so below our Google provider let's
79:08 - do
79:11 - a credentials
79:15 - provider yeah let's do a manual import
79:18 - though let's copy this
79:20 - one delete off the Google let's do
79:25 - credentials provider just being careful
79:28 - so I spell things correctly can cause
79:30 - some weird errors and then this isn't
79:33 - Google this is credentials with a lower
79:36 - case
79:37 - C okay so now we should have a
79:39 - credentials provider to use down here
79:42 - let's use that credentials provider
79:46 - let's do parentheses and then curly
79:49 - brackets so inside of here we need to
79:52 - First tell our credentials provider what
79:54 - they're going to use to log in so let's
79:56 - call
79:58 - it
80:01 - credentials then let's set our
80:05 - credentials equal to they're going to
80:07 - enter an email could be a username could
80:10 - be whatever you
80:11 - want labels going to be this is just
80:14 - like filling out the form honestly
80:16 - they're just going to generate it for us
80:19 - so we can label it
80:21 - email we can say the type is
80:26 - text and the
80:28 - placeholder
80:31 - is your
80:36 - email put a coma below
80:39 - that I'm going to copy
80:41 - this change this to
80:47 - password and we'll say we want a
80:49 - password and then your password
80:55 - and the type I bet we can put password
80:57 - here too let's try that so we got a form
81:02 - that it's going to create when we try to
81:03 - log in with credentials provider of
81:05 - email and password and then we have to
81:09 - explicitly tell it how we're going to
81:11 - authenticate so we could say
81:17 - async
81:19 - authorize you're going to get
81:21 - credentials and then we'll do curly
81:23 - brackets okay the one thing that I
81:25 - recommend here right away is when you're
81:26 - creating your authentication put it in a
81:29 - try catch block because if you don't
81:31 - nexo is going to spit you out a generic
81:33 - error on the login form that would be
81:35 - meant for the end user we don't want
81:38 - that so at the end of this if we don't
81:41 - return a user if at no point in this try
81:44 - catch do we are we
81:47 - successful at the very end we want to
81:50 - return null which means means they're
81:53 - not going to be
81:54 - authenticated and then inside of here
81:57 - inside of the air let's just do
82:00 - console.log and then we'll do air for
82:02 - that one so now we should get an air if
82:05 - we mess up while we're creating it right
82:07 - now that sort of thing so what we can do
82:10 - is then we can use
82:12 - const
82:14 - found user so the first thing we need to
82:17 - do is based on the email someone tries
82:19 - to log in with we need to see if it
82:21 - exists so we're going to do user which
82:24 - we're going to import so I'm going to
82:25 - Tab and it's going to do the import at
82:27 - the
82:29 - top see we got our
82:31 - model so we're going to wait user. find
82:36 - one we're going to pass in email or
82:40 - we're going to look for an email that
82:42 - has that is from
82:43 - credentials.
82:46 - email same as before we can do lean
82:51 - Dot EXC like that so this should find
82:56 - the user now if it doesn't so if we have
83:01 - a found user we can move on to the next
83:04 - step if it doesn't find a user it's
83:07 - going to go down to this return null and
83:09 - we're going to just give that air that
83:11 - the credentials are incorrect we don't
83:12 - want to give too much information you
83:14 - know we don't want to say oh we couldn't
83:16 - find that email address or whatever so
83:18 - we're just going to say that the
83:20 - credentials provided were not valid
83:22 - regardless of if it's a bad email bad
83:24 - password whatever so inside a found
83:27 - user then for your sake our sake we can
83:31 - say the
83:32 - user exists you want to remove this
83:35 - after you're done testing we do const
83:38 - match so now we're going to test to see
83:40 - if we have a good password so let's
83:42 - bcrypt remember it's an encrypted
83:44 - password and they're obviously going to
83:47 - type the plain text one so we'll do
83:50 - bcrypt do compare
83:53 - we're going to compare credentials.
83:55 - password
83:57 - to the found user. password it looks
84:02 - something like this bp. compare so this
84:04 - is going to use our salt and compare it
84:08 - we need to import that as well so we're
84:10 - going to
84:11 - import bcrypt
84:14 - from
84:17 - bcrypt we're real close now guys so if
84:22 - we have a match so if match so if our
84:26 - passwords do match then we can console.
84:32 - log good pass again this is just for us
84:35 - remove it after you're done and I also
84:38 - want to delete from our found
84:42 - user the dot password we don't really
84:46 - need that anymore so I'm not even going
84:48 - to keep it
84:49 - around and then we can give our found
84:53 - user a roll just like everyone else and
84:57 - this equals just a reminder I know I've
84:59 - overstated this but this is an
85:02 - unverified email user and then only if
85:05 - all that's successful we return our
85:10 - found user that should be it guys
85:14 - so that looks pretty
85:17 - good let's open up our
85:21 - terminal mpm
85:25 - runev that looks good remember I'm not
85:27 - logged in right now so and I don't want
85:31 - to be because I'm just going to test my
85:34 - credentials let's hope I can remember
85:35 - this so it's Bob bob.com
85:40 - lowercase and then test lowercase sign
85:44 - in with
85:45 - credentials you see it looks like it's
85:47 - good so if I go to client member you can
85:50 - see Bob bob.com unverified
85:54 - email and then create user it's denied
85:58 - I'm not an admin so that makes sense
86:00 - awesome this looks great this is
86:02 - functioning let me know if anything's
86:05 - missing from this video in the comments
86:06 - and I'll certainly make a followup
86:08 - adjusting and giving you whatever you
86:10 - would like to see remember inside this
86:12 - authentication you can do whatever you
86:15 - want so you could even hardcode these
86:17 - somewhere these users somewhere if you
86:18 - wanted to give out secret passwords to
86:20 - your application or whatever it is is be
86:23 - careful play around uh see what it's
86:25 - like before you go a full production app
86:28 - let me know in the comments any other
86:30 - videos you want programming applications
86:32 - anything you want to see that you
86:33 - haven't seen around let me know I'll
86:36 - create it if you haven't been to the
86:37 - website check it out we have a cyborg
86:41 - blog as well it has posts that are half
86:44 - human half me we're creating articles
86:47 - doing reviews thanks for watching and
86:50 - until next time keep
86:53 - coding

Cleaned transcript:

this course is your ultimate guide to mastering the world of rolebased authentication in nextjs using OJs this course provides you with the most uptodate coverage on the latest features of nextjs guiding you through the implementation of authentication on both server rendered and client rendered pages and it shows you how to leverage out of the box oof providers like Google and GitHub as well as creating your own custom authentication provider using mongodb Jacob lower teaches this course he is a popular instructor on topics related to nextjs let's start learning what is up freec code Camp it's Jake lower again here to show you another nextjs video in this one we're going to cover authentication we're going to show you simply how to put authentication in your nextjs application so we're going to spin up a blank application and then we're going to spin up authentication immediately in that application we're going to use builin oo providers of OJs like GitHub and Google that we all use and then in the end we're also going to show you how to roll your own login system using mongod DB we're going to also investigate robased authentication as well so you'll be able to give admin roles and different things like that we're going to cover how you can secure server side Pages as well as client side pages to cover all your authentication needs in this one video if you like these type of videos they come out on my Channel first Clarity coders check that out as well as our website Clarity coders dcom let's not waste any more time and Jump Right In All right so here we are in Visual Studio code I'm not going to do a lot of setup you can watch one of my other videos for exactly how you can get some of this installed make sure you have no JS have some familiarization with nextjs projects would probably be helpful I also used a couple extensions that'll show really quick this es7 plus react redex code Snippets it's very useful I'm going to use it a lot in this video so you can go ahead and download that prettier as well for formatting code uh you can see the others in here that I use feel free to freeze and install those if you would like let's go ahead and spin up this project so I'm going to open up a new terminal you can code along with me I really feel that's the best way to learn so that's how I like to do these tutorials and let's do MPX create next app we'll go ahead and click yes to proceed we can call this project our next off tutorial or whatever you would like I'm not going to use typescript so you're you're able to convert this typescript if you'd like I'm going to select no I would recommend if you're following along to do the same I'm going to use eslint Tailwind yes Source directory I'm going to say no app router yes and would you like to customize the default Alias no so we'll let that spin up this project and then we have should have some boiler plate to work with great so now we have our project spun up you can see where it created the project file I want you to go ahead and open up that folder and then we'll continue on from there so if you're using visual studio code you can do file open folder and then pop open that window and you should end up with something that looks like this so now we have our project folder open I'm going to do one more install here so I've opened another terminal let's go ahead and install next off CU we're obviously going to use that so we'll do mpm I next dash off and then let's take a quick look at our package.json here you can see my exact dependencies you can copy these if you want them to work perfectly so you can see I'm using 13.5.3 any version above this should be okay um if not try installing with this exact version and that could help uh same with nexo now let's get to cutting down this app a little bit let's expand the app folder let's go out to our Global CSS let's delete all of this in here and then I will save we only really are going to use two things let's go ahead and set it up just so we're done with it so we'll do at layer base bam we can do an H1 which we're going to use just to make things look a little more like we're used to we'll do font bold text 3XL just for the correct text sizing just so it looks a little better then we'll also do an a tag we'll do at apply let's do underline and font bold and again this will just help kind of visualize what we're doing as we're doing it nothing too crazy here and then let's open up our page I'm going to go ahead and contr a and just delete all this out and this is where my extension is going to come in handy I'm going to do rafc a lot that's that code snippet one that I showed you and then control shift L and this can just be our homepage so I'm going to change all these at once nothing crazy here and we can close that close our Styles we should be actually done with those honestly let's rename this to page. jsx just so it's consistent there and then let's create all of our other Pages for our application I'm going to Showcase some different types of authentication on some different types of pages so that's why we have multiple so let's do new folder here we are going to have a member page so this is a private protected page for only people who have signed up so we'll do a member folder and then a new file in here that we'll call page. jsx and then on that member page we can do rafc just like before control shift L and we will do member and then let's add in H1 tags here and this is going to be our member server session so remember if we don't add Ed client up above our import statements it's going to render the p p on the server side so this is going to show you how we can protect a server side page on our application so let's create a new folder and then as you probably could guess we're going to do a client member page so let's create a client member folder and then I'm just going to copy this page paste it in here we'll close this one out to make sure that we're using the right one and then you'll see this is our client member page so let's let's use a member cant session for this one and then of course to ensure that this is rendered on the client side we have to explicitly tell that we want to use the client side so I'm showing you this this shouldn't be your default you should never just default to rendering a page on the client side but there are certainly occasions where you'll have to so this is our example of that we are also going to have a denied page so most of the time we're going to Route people to a login if they have't authenticated but what if they have authenticated and they just don't have permissions in rolebased authentication in that scenario we're going to direct them towards a denied page so let's just create another folder at that application Level for denied we'll create a new page. jsx inside of this here we can do rafc contrl shift L we'll do denied we'll use H1 tags for this again just because make it look a little better there and then we will do a tiny bit of styling now this is this is a stretch when we're calling this styling but let's say text red 400 so this will just be a red denied that we send people to if they don't have the correct authentication for our page and then let's do one other so this is going to be eventually our page that's protected by roles so only an admin eventually we'll be able to go to this page so let's create a create user folder and then inside of that let's create a new file called page. jsx and then r a c control shift L and we will call this create user we'll say only admins now this is eventually it's not going to work like that out of the gate but we have our structure in place I think that's most of the pages that we're going to need in this project as well so we should good there let's create another folder so let's say new folder we're going to use uh open parentheses and then components o compon like that and then new file let's do our navigation. jsx I'm going to use a capital N with this this will just be our navigation bar up top that we can get set up now we can do our normal rafc that all looks pretty good now instead of here we're going to do a little more coding this time to get this set up and then we should be good to go let's do a header let's also do nav tags so for our header let's do class name we're not going to do we're going to do almost no styling but BG gray 600 and then text Gray 100 should be good and then on the nav side let's do class name is flex justify between items Center width is full let's do a px of 10 and finally a py of four that should be good let's close out of this terminal window for now just so it's a little less distracting and we'll go inside our nav tags here so for the first div let's just do my site and then for the second div and our only other component in here let's do a class name of flex gap of 10 that should be good then we're going to add in some links make sure you're doing the import as well so I'm going to tab complete here and that should do the import you'll see that it did import link from next link we need an href for this so we already created our homepage it's at slash we can call this home let's copy this so we got home we got create user member only client let's do a public page page so we got home then next let's do our create user page now remember eventually this will only be for admins so we'll do create user let's do our client member page so again this should be protected you have to be logged in you don't have to be an admin let's do our member page this is almost the exact same thing except it's rendered on the server instead of on the client side and then let's do a public page which is completely unprotected we'll do public here that looks pretty good now we can go ahead and go into our layout JS we're almost ready to get into nextjs this is the last tiny bit of setup here so let's delete out the Google fonts we don't care about that we don't care about that and then make sure you kill the reference to the Google fonts as well should be good and cleaned up you can change this if you'd like we're not worried about it here we got our HTML we got our body let's do a class name of BG gray 100 so this is just the background let's import our nav ation let's do nav like that make sure you do the import here so I'm going to tab you'll see it imported our component from above we can self close so slash and then our greater than sign and then let's just wrap this in a div as well this these children here just so we can do one other tiny bit of formatting div this class name let's do a margin of two on it should be good to go okay so we did some coding we got the structure set up we're going to work in next off next let's open our terminal just make sure this runs let's do mpm runev we got no errors that is a good sign let's check it out in the browser we're going going to go to local hoston 3000 dang look at us web development who says I can't style applications this is beautiful you can tell what page we're on by the our little reference that page so you see we have a create user client member member and our public page we didn't do anything with the public page let's fix that up and let's just check real quick we should have a denied one as well yes so we are all good there let's make a quick change to the public page just so we can reference that we're on it oh I didn't route to it at all did I yeah not found I didn't create the public page so new full folder let's do public inside here new file page. jsx rafc control shift L let's do public delete that out put our H1 tags just like we did for the others I didn't for the create user because we're going to do something else that we're actually going to create users towards the latter half of this okay so we should be all good we got all of our pages we don't have any authentication set up whatsoever but we're going to get into that next let's go ahead and jump into that so we know we need to create an API folder and that's going to be what next off looks for so let's create API folder inside of that we need to create another folder called op inside of that so I'm right clicking on off here new folder I'm going to use square brackets and then inside of those square brackets I'm going to do dot dot dot three dots next off and then inside of this you'll typically see one of two things so you might have a route well you need to have a route. JS and you might have an options. JS which are going to lay out the options of your project so we're going to follow that format so let's create a new file and let's do route. JS and then in the same name folder so inside that next off off folder we're going to create options. JS as well let's start with the route. JS just so we don't forget it is the simpler of the two because we're going to import in our options so let's do an import I'm going to close out my terminal just because it's distracting let's do import next off tab auto complete you can see I'm getting next Das off SL next I don't know that I want that let's delete out the slash next let's just do next off from next o and let's do import options plural from SL options so this is going to import our file from our other directory Zu const Handler equals next off options and then we're going to export Handler as get Handler as post now this is straight from the next off or aujs documentation so we're just setting this up basically how they have it set up I'm going to close out of these other tabs I actually think we're done with route. js2 I'll close out of that and now we can set up our options here so this options file is going to be where you import and set up how you want people to be able to authenticate with your application so we're going to start with two and these are builtin providers by next off so we don't have to do or we don't have to do very much setup with them so let's do import get Hub Provider from next off/ providers slash GitHub let's copy that paste it below let's do this is a capital G Google provider and we're going to do the same thing except at the end it's going to be Google as well then let's do export const options equals providers colon square brackets so here we can add an array of the different providers that we'd like to use in our case we want to use the GitHub provider parentheses curly brackets and then inside of here we can set up anything that we would like for our GitHub so we can add extra roles we can add extra features or we can leave it as plain Jane as we want and just ship it that way but we are going to show you how you can add rolls as well while we're doing this so let's go ahead and add in a profile and we're going to be passed a profile back for we're going to get a profile back then we can do curly brackets and inside of here we can add extra logic so let's say console.log let's log out our profile let's make sure we know what it is too so we can say profile of GitHub and then we can log that now we want to add extra stuff to our session so one thing that we can do we can add extra logic that allows us to give specific roles to specific users now my user that we can use in this that I'm going to sign up for the application with is Jake Clarity coders docomo role is going to be GitHub user so let's do let user roll equal GitHub user so this is going to be the role for everybody but me but I'm going to say if my profile exists and it has an email and that email is equal to Jake Clarity coders dcom and you want to use your email here an email that you can actually test this at your current location to give yourself admin rights to to our test application so Sub in your email here so if our email equals Jake at Clarity go.com or whatever your email is then our user Ro is going to be upgraded to admin then we will return our new profile we're going to do dot dot dot so everything that was in the profile before we want to still be in the profile however we want a new role of our user role and that's it you see I controlled s there it got the formatting all right thank you prettier this is our GitHub provider so let's copy this so we're copying everything on the GitHub provider and let's paste it below and then let's set up our Google provider so for this one we're going to handle things pretty close to the same the only thing we don't want any extra logic so let's change this and let's say this is is our Google profile and you don't have to log these out this is just so you can see what's on them and that sort of thing so we're going to console.log that out no special roles for this and one small change with the Google profile we need an ID field and the Google profile does not provide one so let's set our ID equal to profile. sub this is going to be the idid that they pass back make sure to add a comma after this as well so we should be set up there as well now for each of these we have to have a client ID and a client secret that we're going to set up with these providers so we can utilize them in our application so on the level of the profile here after that profile we're going to hit enter here and for our GitHub one we're going to have a client ID colon and we're going to set it equal to process. EnV dog hubor ID let's copy this now these are environmental variables that we're going to set up that are not set up yet so this is going to be our client secret and this will be GitHub unor secret make sure to put commas after these and then we can copy them and down here on the Google one so we're after the profile we're going to add these in here except this will be a Google ID and a Google secret perfect so now these are set up that is looking good and we're going to make one more change out of the box here to ensure that we have our Ro available for us in this application we're going to set up some custom callbacks and this will essentially add our roll to the Token so we can utilize it in our programs so notice I'm after the square bracket comma I'm going to enter some callbacks here we are going to do async JWT parentheses curly brackets we're going to get a token and we're going to get a user and from that we can say if we have a user let's say the token. roll is equal to the US user. roll so this will allow us to add that token add that Ro onto our token so we can utilize it on the server side however we also want to be able to utilize this on the client side as well so we will do async session and here we can use session and our token and here we're going to essentially do the same thing we're going to say if we have a session. user let's set session. user. roll equal to token. roll and this will allow us to use it there then of course we need to return our session so we have it and then up here as I have forgotten let's also return our token and of course comma here awesome awesome so now we should have this set up so we got our providers set up we got our sessions set up everything looks great there now we need to set up our provider on the provider side so let's create a new file and this is going to be at the base level so it should be at the same level as your Tailwind config or the readme or whatever let's set up a new file let's go Dov dolal in here we can set up our environmental variables so remember they're going to look like this we want to utilize the same verbiage here so let's do Google ID Google secret like that and these are going to have equals afterwards we're also going to need a GitHub ID and a GitHub secret as well so we're going to set both of these up now all right so now if you are logged into your GitHub account you can go to github.com setting apps from here we're going to select oo apps and then we can create a new oo app we can name it whatever we would like so we can do next off video tutorial we can set up a homepage for it so we're going to do HTTP colon localhost colon 3000 and then we also need to utilize a callback URL so we're going to copy that paste it down below here it's going to be 3000i off callback SL GitHub you need to type it exactly like I did here and then we can register our application now now from here we're going to get a client ID and a client secret ensure that you do not use mine that won't work and make sure you don't have anything weird any spaces or whatever so we're going to copy this client ID and remember this is GitHub don't get them confused so we're going to do our client ID there and then let's generate a new client secret you might have to authenticate I'm going to copy that secret and then paste that as well so we now have our GitHub provider set up that's really it it's relatively easy and then we're going to do the same thing on the Google side of things so you're going to go to Google's developer console so it's console. developers.google.com and then from here we can go to credentials and we can create credentials and we're going to do an oo client ID we can say web application I don't know if it really matters we'll do a next off video tutorial don't miss this so we need an authorized redirect URI let's add that as you can guess it is HTTP col localhost colon 3000 SL API SLO SL callbacks call back rather slash gooogle API off call back Google let's go ahead and create so here you can see our client ID and our client secret let's go ahead and grab those so let's grab our client ID paste that in and let's do the same with the secret so we'll grab that and paste that in as well awesome so we should be all set up to authenticate with our application with whatever user we would like however we don't currently have any Authentication set up on the individual pages so we don't really have a way of knowing if we're authenticated or not and we also don't have a way to log into our application yet so let's go ahead and set that up first so inside of get server session down here tab complete from next off and then we can utilize that to see if we have an ongoing session right now at the moment so what we can do is right in here we can say const session equals await get server session and then we need to pass in our options so you see I'm going to autocomplete here but these are inside our API a blah blah blah that whole directory you can see it imported correctly and it's mad because I'm using an async function so I up here need to add a sync perfect so now we should have a session if we have a session which we don't right now because we haven't logged in so after the public page let's add curly brackets and let's check to see if we have a session so if we have a session we want to add in a link and we want the hre to equal and this is going to be our log out functionality remember if we have a session we're logged in let's do slash API SL off slash sign out and I'm going to add this so I'm going to add question mark call back Capital URL a capital u and then lowercase RL equals slash so this means when we sign out it's automatically going to send us back to the root of our directory let's close that link tag and we can call this log out now we're doing conditional rendering here so it's only going to render this again if we have a session so now we need to handle if we don't have a session which is what we currently have so let's do colon and then let's paste this in I'll save it so it wraps and you guys can see a little better so if we don't have a session then we want to be able to log in so we're going to go to the same page we're going to go to API SLO sign in this time so now we should be able to tell if we have a session because we'll either have a log in or a log out button we should not have both hopefully so let's go ahead and check this out so now back on our site so we have our site here loaded up you'll see we we do have a log in button we do not have a log out button which makes sense right because we do not currently have a session let's hit log in you'll see we get this nice built in now you can customize this that's not what we're going to cover in this tutorial but you can customize this but you see we got our two providers that we're able to log in with now remember if I log in with GitHub I am authenticated with my Jake at Clarity coder so that's going to be assigned in admin the other one will be a normal session it won't be my admin session so let's authenticate with GitHub you're going to have to authorize the first time you do it and you'll get redirected back to your application if this didn't happen correctly double check that you added that call back URL correctly to GitHub and likewise when you test it with Google the same way there you're going to have to make sure that you have a valid session there as well so now you'll notice that I did log in that did work correctly but I still have my login options so it's not showcasing a session at the moment so we did have the terminal still open you can see what our issue is it's throwing all kinds of Errors so what it's saying here more or less is that we haven't provided a token for our session so we have no secret in order to verify that this person is correctly signed in with our application and they didn't just create some bogus session themselves so what we need to do is inside ourv dolo we need to add a next off secret here so this is going to be called all capitals let's do next oore secret and we will set this equal to and then we're going to create one now you can type in random characters here and that would be fine but we want to make sure that we have a certain level of security here so open up your terminal if you don't you can kill your session if you're running it still from before and let's generate that secret so let's do open SSL Rand base 64 and we want 32 and then here you can see we generated a nice little secret don't use mine just create your own and then we have our next off secret here so we should be good now once you have that we can go ahead and spin up our server again so let's do mpm run Dev so now back on our site if you get any weirdness make sure you're shutting down your server turning it back on you can also try reloading this page and one other thing that I have to do from time to time when I'm playing around with cookies sessions and things like that hit control shift I if you're on Chrome and here you can go to the application Tab and under local storage session storage and cookies you can clear those out and that will sometimes help if it's cash in and air anything like that that's happened in the past I didn't have it this time but just so you know you can go through that process obviously we don't have a session right because we didn't have that next off Secret in here so that aired out so let's go ahead and try and log in again you can do it with whatever provider you would like I'm going to try with my GitHub again and you'll see that now we have a log out so we do have a session here which is awesome so if we go we don't have any protected page is right now at the moment so you can see our client member our server session we can still get to we can obviously still get to public let's go ahead and try and log out sign out and that goes back to the home directory and I have my log in so everything looks good but nothing is protected so let's get into protecting our routes we're going to do this in three ways right now so I'm going to quickly show you how to protect a server side page a client side page and then with our create user we're going to protect it with with middleware for right now and then we'll expand that to protect it to make sure you're an admin on top so let's go to it's really not that difficult let's go to Our member page first remember this is our member server side session so let's take a look here and we can set up a session so we're going to need to check to see if there is a session so we need to make sure you're logged in so session equals a wait get server session we'll do the Auto Import so I'm going to tab here and then I'm going to spit in our options remember let's tab complete here so it did those two Imports for us this also needs to be a sync that looks great then below here what happens if we don't have a session so if we don't have a session in this case so if there is no session then let's do a redirect and slide down so let's use the one from next navigation make sure you're looking at the redirect from next navigation we'll import that and we can redirect to SL API slof SL sign in question call back Capital URL equals SL member so what this is going to do it's going to redirect us to the login it's going to leave the call back URL so if they do log in they'll come back to this member page P so that's going to be a nice look nice and easy look so below here let's do just a little more let's add a P tag and let's say inside of here let's do curly brackets so if we're here we do have a session so let's say session question mark. user question mark. email so we'll spit out the email let's do that again and this time let's say roll so remember inside of our options on all these we're setting up a role of some sort so for our Google provider we are not setting up one so that's going to cause an error I'm going to minimize this so here we're setting up a user roll on our GitHub side of GitHub user unless you're me Jake at Clarity coders and then you're going to get an admin roll on the Google one we didn't so luckily we didn't try to O off with that if you did I'm sorry and we can paste in let user roll and let's say Google user paste that down there and now this should be working as well we'll test out Google just to make sure it works here down the road um but for right now that should be good and on the member page we should be protected now let's try it so let's go to our application you see we can go to public if we try to go to member it asks us to log in now make sure you're not already logged in um in this case let's do something different let's sign in with Google just to make sure that works since I did just find out that it probably isn't for you guys pick a Google account and you can see that our member session it has my email address and Google user there as well great so that works let's go to our client session now let's protect this it's going to be a little different because this is rendered the JavaScript is rendered on the client session on my client browser so we can't use the server side get that we were using before and I'll show you why before we go there I'm going to copy these two P tags let's go to our client member page we can paste them below so this will be if we have a session let's do get server session so if we do that you can see that we get all kinds of crazy errors well part of it's probably because I use this let's control slash I'll just comment this out for right now and then let's navigate to that page we'll go to create user and then I'm going to go back to client member session so now if we actually try to use get server session to get our session so let's do const session equals await get server session pass in our options you see we need to do an async function so let's do async and we save it we can uncomment this save that and let's go to our client member and you'll see we get an error a sync AWA is not yet supported in client components okay so we see our problem there that's why we can't do it the same so we can't do it in this format which is fine we have other options here so instead of of this so let's do import use session and we're going to do from next off SL react so this is going to be how we grab our session and then here we can grab const we're going to set data equal to session we're going to do equals use session parentheses curly brackets required equals true and then on unauthenticated so what do we want to do when we're unauthenticated we want to redirect make sure you're using next navigation again for your import redirect and we're going to do something very similar to what we did on the other page so we're going to do slash API SLO SL sign in question call back Capital URL equals SL client member just like that so we're good and if we control save this you'll notice that we're getting new errors right Ed session must be wrapped in a session provider member so this is a little complicated so the use session needs a session provider however the session provider has to be a client component as well so let's create a new file inside of our components and we will call this o provider. JS and this is going to use clients we are going to import session Provider from next o react so you'll see it did the Auto Import for me and we're going to do const off provider equals we're going to pass in our children then inside of here we're going to return our session provider and don't worry kids putting you right back in there we need to export default off provider like that so now we have our session provider in a client component so we're good to go there and we can go back to our layout page and here's where we need to wrap this bad boy to get our session on the client side now remember this is only if you need to do authentication on the client side if you want to do it on server side we're good already so here let's utilize our off provider this should be coming from components directory and then we're going to wrap this around our children div here like so now I don't have to wrap my nav in it because I'm not using client side on that you could certainly it might even be better actually to wrap this around your entire body just in case we can do that I didn't need to for mine but you might down the road so we can wrap this off provider I believe around the whole body like that and that should function as well and then if you have any client rendering here on the nav side you can do that now again shy away from client side rendering if you can but if you have to um you can go that route so now we have an off provider here so our client member should have a session now um and it should you should need to be authenticated so let's go back to this let's just go back to Local Host you'll see we got home uh we are logged in so if you go to the member you can see that we're still my email a Google user if I go to client member now you'll see it has the the same both member server session and client session are the same I'm both authenticated form now if I log out and I go to client member it is protected now so that is good okay what's middleware so if we don't want to protect our Pages inside of each page we can set up mid middleware on our project and that will allow us to add authentication rules in one spot that we can easily find so let's create a new file this is going to be on the same location ASV dolo and let's call it middleware DJs we can do export and then default this is not what we're going to stick with but we can do export default from next off SL middleware so this right now will protect everything so everything on our page will be protected then we can export config equals let's do a matcher and then we can pass in an array of URLs that we want to test and here we can protect create user okay so right now we have it set up so our create user should be protected now you can see that's a lot easier than adding it on the page or anything like that and if we go here let's go ahead and log in just with my Gmail so remember I'm a regular user right now okay now back back to our application let's see if our create user is now protected so you'll remember we're still logged in so make sure you're authenticated if you're not you can tell because you have your printout here let's go to create user and you'll see that I can get to it now I'm not on my admin account but we haven't done that yet so it's just protected from normies so let's go ahead and log out sign out and now we don't have any session so if I go to member it tries to loog Lo me in if I go to create user now it tries to log me in so that is great so we've successfully protected this with middleware however we still are not protecting it from normal users we only want this to be admin so let's make that change let's go ahead and log out and then we'll go back to our code here so we're going to do some new Imports so let's say with off I'll tab here you can see my import that I'm going to get with o above and let's also do next response and this is coming from next server now we should have all of our Imports We need oh my gosh I was on the wrong page don't do that so let's leave our create user alone if you had that open I apologize let's close out of all of these I don't make that mistake again so we're back on our middleware page so on our middleware page we're going to do those same two Imports that we just did so we're going to do with off and next response so let's save that and you can see that we got our two Imports done and then we're going to make some changes to this file I'm going to leave the matcher on here because I only want this to apply to that page I'm going to delete this out and start fresh so I'm going to do X Port default with off now inside of this I want to create a function for my middleware and I'm going to get a request when I visit a page and we can console log out some information here that might help you with future requests or things that you want to do custom wise so let's console.log let's do our request. next url. PATH name name so this will show you what our path is so if you're trying to do some logic here that may help and then let's also use or at least log out next request. next off. token. roll and that could help us do some troubleshooting as well now let's actually Implement our logic so remember again you can you can do any customization you want here um anything that makes sense with you but this is what we're going to do to protect this one create user page and make it only admins so let's say if in here we want to use our path name so let's copy this we're going to say if request. paath name so if we add other paths it might not you know might have different logic or whatever so let's say if it starts with create user and we want one other test here and we want to make sure our roll does not equal admin then let's do curly brackets let's save this just so it formats I'll fix that okay so here's our logic here's our if statement so we want to say if we're going to the create user page and you're not the admin so if you're not the admin and you're trying to go there let's just return next response. rewrite let's do a new URL and we'll go to the denied page request.url so what we're going to do is we're going to send them to that denied page we created earlier now we could send them to a login page but they're already logged in this is for if they don't have the correct role so they shouldn't probably shouldn't be able to just log into a different account so if that is the case we're going to send them to the deny page if not this will continue on and they will be authorized so let's add a comma here let's do call backs colon curly brackets let's say they are authorized if they have a token and that token is not null so we want to make sure they have some sort of a some sort of a token here we actually need to wrap this in curly brackets as well I believe I'm going to highlight this wrap it in curly brackets and save and you should have something that looks like this so now we have our callback function set up we have our middleware all set up actually so we should be good let's take a look let's go back to our project we got all kinds of Errors let's refresh So currently it does not look like we're logged in let's go ahead and log in with a nonadmin account so if we log in with our Google account in my case yours might be different we go to member you can see that our role is Google user if we go to create user you'll see that now we get a denied let's log back out and this time I'm going to log in with GitHub you'll see that I do have an admin session here which is great and if I go to create user you can see that I do in fact get to the create user page so we should be good there so what we have now is we have ooth provider set up for GitHub and Google and we have rolebased authentication for both server rendered pages and client rendered Pages as well as robased Authentication so we are good there now you might be asking yourself well what if I have a database already or what if I want to create a database of users that allows people to either use their email or pick a username and a password and set that up that isn't covered in a lot of these tutorials because it's a little more advanced and you have to factor in things like validating email or whatever it might be but I'm going to show you how you can set that up connect it to a database relatively quickly and get it at least spun up and in place we are not going to cover validating emails so you need to keep that in the back of your mind that this is more like a username not necessarily an email address I can pick Jake gmail.com even though that is not my email address let's go ahead and kill our terminal and then we'll do the remaining Imports for this project so let's do mpmi mongod DB mpmi mongus and MPI B Crypt awesome now we got that set up let's go ahead and sign up for a mongod DB Atlas database now this is free so if you have haven't used it already go ahead and sign up for a mongod DB Atlas account you should come to a page like this you can authenticate with very similar providers to what we're setting up you can see how popular they are so I'm going to go ahead and log into mine now if this is your first time you might get some popups wanting to spin up a database right away blah blah blah you can skip all that hopefully eventually you'll come to a page like this and what we want to do is up in in at least right now in the top left is to create a new project we're going to call this next off video tutorial in my case I'm the project owner let's create our project then once you get that created we can create a deployment so let's do create you can do the free tier and then hit create you're going to want to set up a username and password here so on the next screen it gives you an option to set up a username and password note these down so inside your EnV you can note these down I have admin and then a password below so if I go back to my code inside. EnV let's just paste these in here for right now let's say admin and then our password you'll want to add your current IP address as well so we're going to add that ah I forgot to hit create user Make sure you hit create create user and then finish and close go to overview and now you should have your database set up so we're going to go ahead and hit connect if you don't have this there should be a connect button somewhere or you might have to let provisioning finish so once that's finished you can hit connect we're going to hit drivers and then we're going to copy this string down here now back in our code we're going to paste that string in here pretty long you'll notice it already has admin switch that out for your username if you didn't use admin I did so I'm not going to change it and then we're going to copy our password and paste in our password use your password not mine obviously and then here we're going to call this in all caps mongod dbor urii we're going to set that equal to this string if we slide to the back I'm going to delete this back half so after the question mark and I'm just going to call this app DB like that that should be it so our EnV is set up there that looks good we can go ahead and close out of that now let's create a new folder so in parenthesis we're going to say models inside of here we're going to create a new file called capital u user.js so we're going to find what a user looks like in our system so we're going to import and curly brackets scheme a from mongus and we're going to use mongus doc connect process. env. mongod dbor mongus do promise with a capital P equals global. promise then let's do const user schema equals new schema do curly brackets so let's just have a name and that's a string an email and that's a string a password you guessed it that's a string after this curly bracket let's do parentheses this is something I always do with my models let's do timestamps equals true this handles the create at and updated at dates so it's there for you if you ever need it and then let's create our user model so cons user equals mongus models. user or so this is if it's already defined or we use mongus dood and create the user from our user schema and let's export that so export default user spell default correct that looks good okay so we got our model we got our database set up now all we need to do is create our API for creating a user and then I'll show you how you can verify against your existing users as well so all we have left to do is to create the frontend form that can submit a new user then we'll create the API to add a user to our database when someone submits the form and then we'll add the credentials provider and show you how to validate that password let's create our user form now this is a little unique because we want this form to use client side rendering because a form interacts with the user with the JavaScript so you might have validation on the front end or whatever it might be user form. jsx X inside of our components directory and then on this user form we are going to use client we're going to import use router from next navigation not next router this mixes me up sometimes so let's change that to navigation then we're going to import react and use state from react const user form equals recreate our function like that and then at the bottom we'll export I didn't use my short keys I wondered what was weird about this export user form see I can do it guys all right then inside this we are going to have a con router equals use router we have a const form data this is where we're going to store all of our form data and we'll have a set form data we'll set that equal to use state with curly brackets inside so our form data is just going to be an empty object originally then we'll do const error message so we're not going to do much here but I will check to see if that user already that email is already in our database and then we can send a duplicate user type of error response back so we have an error message and a set error message equals use State this will just be a blank string to start out that makes sense we need to handle our change in our form and if you've done this before it's pretty straightforward we're coding it so it's it's pretty Dynamic doesn't really matter what our form values are I always do const value equals e. target. value copy that and I'll do const name equals e. target. name and then I will do set form data I'm going to pass in the previous state we want another set of parentheses there and then open curly brackets that looks better so when we change our state so this is anytime the state changes we're going to say previous state we're going to expand that so it's going to take everything from the previous state before and we're only going to overwrite the one change that we're making so whatever field on our form we're changing and whatever value we're setting it to we're going to override it with and that's our handle change that's it now from here we can do a const handle submit this equals an async function we're going to do e. prevent default we're going to reset our airor message so if we previously had a airor message we're going to set it back to blank at the start of submitting our form basically starting with a clean slate we're going to get a response from our own API that we haven't created yet so we're going to do con response equals a weit fetch then we're going to do API slash users with a capital u remember we're creating this in just a moment parenthesis nope sorry comma and then curly brackets we'll do our method equals post we're going to create a new user our body is going to equal json.stringify we're going to pass in the form data just like that we'll do content type and that equals application sljs okay almost done believe it or not so we're going to check to see if our response has an air so if our response does not equal okay then we want to get what the actual error was we're going to pass back an error here so we'll wait our response. Json and then we will set airor message to whatever was in our response. message and we'll show you how we're going to set that in just a moment so we're going to pass back some sort of an error we're going to catch it here and then we're going to set our error message this is only for an error remember we'll add an else so otherwise we want to do router. refresh and router. push and we'll push to the root directory so this is just going to send us back home and that's it so pretty straightforward nothing crazy here let's continue on and here we're going to do a return and let's do open and close let's do form tags inside of those our form is going to be pretty straightforward we're going to do onsubmit and we've done all the leg work now we're going to do handle submit that we already created our method equals post and our class name just a few Styles here going to equal Flex Flex call let's save this just so it formats and that's my prettier extension that helps me do that Flex Flex call Gap three let's do a width of a half let's do inside of this let's do H1 let's say create new user then below that we can start creating our inputs don't worry they're going to be very short let's do a label and that label is going to be full name then we'll have an input let's say input our ID equals name our name equals name on change equals handle change like so let's make it required equals true add another my closing tags there and then I also need a value which equals form data. name saving that so it formats beautiful and last but not least let's do a class name and we're going to copy this so M2 BG of slate 400 rounded watch any of my videos I'm not very good at styling so I just round corners like crazy I'm going to copy the label and the input paste it below this one is going to be our email so let's do email for an ID email for the name change the form data. email here as well everything else looks good so that should be good to go let's copy all of it again paste it below let's do password ID of password email form data and this actually has a type of password let's add that in these probably should have a type as well let's do a type equal to text for our email and also for our name okay that should be good to go there the last piece is our submit button so let's do input the type equals submit MIT the value will equal create user and the class name let's stylist just a tiny bit blue 300 with a hover of BG blue 100 selfclosing tag so we'll do slash like that slide over so you can see again so we got our input button in the form we got the form you might have wondered why I wrap these all in closing tags remember the whole return has to be wrapped in some sort of tags and I'm actually going to do something below the form here so that's why I did that let's do p tags and then inside of here let's just print out our air message now this will print out a blank string um when there is no error but that's not a big deal to me so we're going to leave that there and then we'll change it to text red 500 this looks good think we're pretty good there should have closed out of that terminal a long time ago we got our user form created let's create the API so inside this API directory you see we have API off and then next off inside of API so I'm going to rightclick on API I'm going to create a new folder and inside this new folder I'm going to call it users and inside of that user folder I'm going to create cre a new file called route. JS now we're only going to do one function in here just to show you how a post would work I'm going to pull in next response from next server I'm going to use our user model so I'm going to pull that in as well you can see how it does it up here with the at symbol tab that now we got our user model and then finally we have to do a encrypt before we store it so we want to do import B Crypt from bcrypt now remember this you know we're not validating an email so in my mind this is like I run a company and I'm inputting a user that I know has access to that email address and that sort of thing you wouldn't want to do this in like a SAS application without validating the email address because someone could steal someone's email address that they don't have access to so let's export a sync function post and we're going to get a request let's do this all in a try catch and for our catch let's console.log our error that might help us if we make a mistake I'm sure we won't let's return um next response. Json in here we're going to use that message so we're going to use message and then err also return the error that looks good got a comma here another set of curly brackets let's also do a status of 500 if something goes wrong okay that looks good now our Tri block we're going to grab our body so we're going to const body equals await request. Json so we're going to pull off the information we're going to do const user data equals body. form data let's confirm that our data exists the fields that we need so we want to say if we do not have user data. email or if we do not have user data. password so if we don't have those fields we are going to return a message so we want to copy this we'll paste it in here we're going to say a status of 400 and then our message can be let's not send the error our message can be all fields are required so this shouldn't happen because we're sending it with that one form but down the road you change something now you'll know if you're getting information missing information so let's check for duplicate emails now so let's do a const we'll call it duplicate equals a wait we're going to use our model from above so user find one so we're going to see if we can find any email that has our you user data. email do lean and execute now we can check so if there is a duplicate then we want to send another response and we're doing kind of meaningful responses here too right so that's uh that's kind of a cool setup that we have going we can do a status of 409 and we can do duplicate email now it's probably worth noting here that we're also you might want to be careful and make sure that you're using um that you're checking all your emails case insensitive so you might want to lowercase all of them before you add them to the database or something like that because right now you could have unique emails that just have capitalization differences or whatever it might be so keep that in mind CL this that looks better so now for here we know we don't have a duplicate user we know we have all the fields we need let's create our hash password equals await bcrypt do and then we're going to pass in user data. password you can do as many salt rounds as you want I always see 10 so you probably shouldn't use 10 but that's what what we'll use const and then user data. password so now I'm overwriting the plain text password with our new hash password here so now our user data contains our hash password we shouldn't be saving plain text passwords and we can await user. create and we can pass in our user data dang was longer than what I thought but we got her done so we create created the user data let's copy a response we still want to send a response our message delete this can be user created and our status can probably be 2011 awesome so this should be all we need to create a user so let's go ahead we've done a lot let's go ahead and test that make sure user gets created successfully and then we can try and authenticate with that user after we add the credential provider which we haven't done either so mpm run Dev okay so we got our website here I got to see who I'm logged in as I am logged in as an admin so if you've added this authentication and it's Ro based you have to have admin now to go to create user if you haven't done this you can assign admin to someone else else I'm going to go to create user this is only admins duh because I didn't update that so back on our create user page instead of only admins let's render our user form see it did the import for me self closing tags that is pretty who says I can't style okay so let's create a new user Bob Bobby Bob bob.com password test of course and create user kind of looks like it worked Google does not like my password it's been used in a security breach so that's worth noting um but it looks like it worked okay so let's go back to our database and I will click on database now we didn't name our collection so it's probably going to give a test collection which is fine oh no we did appdb we have a user you can see we do have a user now awesome so we have Bob Bobby Bob bob.com and a nice hashed password so one step left here we have to be able to authenticate with Bobby now so let's log out we don't have a credential provider at all so we can't log in with a username and password let's change that so we're going to open up options let's go ahead I'm going to shut down this terminal just because I'll forget it's running and then we'll be on the wrong thing and close out all these just for you guys so below our Google provider let's do a credentials provider yeah let's do a manual import though let's copy this one delete off the Google let's do credentials provider just being careful so I spell things correctly can cause some weird errors and then this isn't Google this is credentials with a lower case C okay so now we should have a credentials provider to use down here let's use that credentials provider let's do parentheses and then curly brackets so inside of here we need to First tell our credentials provider what they're going to use to log in so let's call it credentials then let's set our credentials equal to they're going to enter an email could be a username could be whatever you want labels going to be this is just like filling out the form honestly they're just going to generate it for us so we can label it email we can say the type is text and the placeholder is your email put a coma below that I'm going to copy this change this to password and we'll say we want a password and then your password and the type I bet we can put password here too let's try that so we got a form that it's going to create when we try to log in with credentials provider of email and password and then we have to explicitly tell it how we're going to authenticate so we could say async authorize you're going to get credentials and then we'll do curly brackets okay the one thing that I recommend here right away is when you're creating your authentication put it in a try catch block because if you don't nexo is going to spit you out a generic error on the login form that would be meant for the end user we don't want that so at the end of this if we don't return a user if at no point in this try catch do we are we successful at the very end we want to return null which means means they're not going to be authenticated and then inside of here inside of the air let's just do console.log and then we'll do air for that one so now we should get an air if we mess up while we're creating it right now that sort of thing so what we can do is then we can use const found user so the first thing we need to do is based on the email someone tries to log in with we need to see if it exists so we're going to do user which we're going to import so I'm going to Tab and it's going to do the import at the top see we got our model so we're going to wait user. find one we're going to pass in email or we're going to look for an email that has that is from credentials. email same as before we can do lean Dot EXC like that so this should find the user now if it doesn't so if we have a found user we can move on to the next step if it doesn't find a user it's going to go down to this return null and we're going to just give that air that the credentials are incorrect we don't want to give too much information you know we don't want to say oh we couldn't find that email address or whatever so we're just going to say that the credentials provided were not valid regardless of if it's a bad email bad password whatever so inside a found user then for your sake our sake we can say the user exists you want to remove this after you're done testing we do const match so now we're going to test to see if we have a good password so let's bcrypt remember it's an encrypted password and they're obviously going to type the plain text one so we'll do bcrypt do compare we're going to compare credentials. password to the found user. password it looks something like this bp. compare so this is going to use our salt and compare it we need to import that as well so we're going to import bcrypt from bcrypt we're real close now guys so if we have a match so if match so if our passwords do match then we can console. log good pass again this is just for us remove it after you're done and I also want to delete from our found user the dot password we don't really need that anymore so I'm not even going to keep it around and then we can give our found user a roll just like everyone else and this equals just a reminder I know I've overstated this but this is an unverified email user and then only if all that's successful we return our found user that should be it guys so that looks pretty good let's open up our terminal mpm runev that looks good remember I'm not logged in right now so and I don't want to be because I'm just going to test my credentials let's hope I can remember this so it's Bob bob.com lowercase and then test lowercase sign in with credentials you see it looks like it's good so if I go to client member you can see Bob bob.com unverified email and then create user it's denied I'm not an admin so that makes sense awesome this looks great this is functioning let me know if anything's missing from this video in the comments and I'll certainly make a followup adjusting and giving you whatever you would like to see remember inside this authentication you can do whatever you want so you could even hardcode these somewhere these users somewhere if you wanted to give out secret passwords to your application or whatever it is is be careful play around uh see what it's like before you go a full production app let me know in the comments any other videos you want programming applications anything you want to see that you haven't seen around let me know I'll create it if you haven't been to the website check it out we have a cyborg blog as well it has posts that are half human half me we're creating articles doing reviews thanks for watching and until next time keep coding
