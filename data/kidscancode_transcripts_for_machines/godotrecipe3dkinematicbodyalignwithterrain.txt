welcome back to another good recipe in this video we're going to take the threed kinematic body that we did in a previous recipe which you can see the link for below and we're gonna learn how to align it with a surface so that can climb up hills and drive over terrain smoothly to create my terrain I've downloaded the modular terrain pack which you can find on hgo again I'll put the link below and this is a path has all sorts of terrain models in it for a lot of different things I'm not gonna be using most of this for this demo but you know it lets you create a lot of a lot of different environments and they're modular so it's basically broken up into pieces that you kind of snap together like Legos so so I drop those into my project and I've used them to create a little bit of terrain and so I want my tank to be able to drive you know climb up this hill and drive around just like it does on the flat surface okay so if we try it out with our tank as it exists with the code to drive around you'll see they'll be a few problems one is when we climb up the slopes our tank doesn't rotate so it looks like it is floating in air if you're off the side right on a corner like this or something right the other problem we have or another problem we have is that if you stop moving on your way up a slope you get a little bounce if you can see that and because the the Y velocity remains and lifts us up off the slope like that and then the last one is that if I remain still with no input I'm slowly sliding down the slope so these are the things we need to address to get the tank movement to look better when dealing with terrain so to begin with we could add the stop on the slope parameter here to move in slide that's not going to stop our bouncing for that we're going to need to change to move and slide with snap and what that'll let us do is snap to the surface we've got to change the parameters a little bit we give it our velocity then we need to give it the snap vector and we're gonna use vector three dot down and we'll multiply it by two to make it two units long and then vector three dot up is still our up vector and then true for stop on slope so now that'll take care of some of that incorrect movement all right when I stop on the slope I don't bounce and when I let go of it I'm not sliding down the slope okay so that takes care of the keeping the body attached to the slope so in order to orient our tank with the terrain we need to consider the surface normal and what that means is on every mesh there are faces and since this is low poly terrain meaning low number of polygons we can easily see the faces this will work on high poly terrain as well but this makes it easier for us to see a little bit so you see on this slope there's one face here there's one face here there's a small face here and then there's the flat one on the top right and each face of a mesh has a normal which is a vector a normal vector and a unit vector or the same thing so it's a unit length one length vector that's pointing perpendicularly out of the surface and it helps you understand which way the surface is facing right so this one's gonna have one pointing out diagonally like this this one will be at a steeper angle the one on the ground points straight up right and so when you collide with the collision mesh of this terrain you can get the normal of the mesh where you collided and we want to take that normal and use that to set our tanks direction as well now our tank has a make sure we're in local mode right our tank has a local transform and that controls its orientation right and the normal of the slope where we hit is what we want the tanks Y basis to be all right so if it's going up a hill it needs to I'm rotating the head if it hits if it hits a hill and starts going over we need to rotate this Y vector so that the Y vector matches the normal of the slope and if it's going to the side you know it'll be tilted and so on so in order to do this we're going to need to understand a vector operation called the cross product so here I have two vectors that are located in space and I want to take the cross product of these two vectors and when I do I get this alright so the cross product of two vectors is a third vector that is perpendicular to both of them and it's length is actually proportional to the angle between them so you see if I rotate the X vector as it gets closer and closer to the green vector the cross product gets shorter as it gets farther away again see I'm on the other side it's now extending in the opposite direction and and so on so a cross product with what you really need to remember is a cross product gives you a vector that's perpendicular to the two vectors that you crossed now we're gonna use that to get our new orientation of three perpendicular axes for our tank okay so here's another example so we have our tank with its transform basis of the three vectors as it's sitting flat on the ground and we've collided with a slope and this gray vector represents the normal of that slope so we need to rotate this tank so that this green arrow is pointing along the gray arrow and that the blue and red arrows rotate along with it right these three things stay perpendicular so the first thing we could do is we could just set the basis dot y equal to the gray vector which would move the green arrow there I'm leaving a dimmed version of the original axis you can see where they started so now our Y axis is pointing this way but this is a problem because now they're not orthogonal right they're not all perpendicular to each other so the engine will try and orthonormal eyes or make them perpendicular and the result you get is that now these are perpendicular again now but all we've done is we've rotated this portion to point upwards but we haven't rotated to the side so we need to get our we're going to need to change our X as well and the way we're going to figure out what the new X needs to be is we're going to take the cross product of this normal with the Z and when we do that we get a new X which you see the new X now points that direction we orthonormalized one more time and now the Y matches so now we have completed our transformation we've rotated the Y to point along the new normals vector and the X and Z have changed and notice too that the Z has only changed vertically it hasn't changed left and right so our tank will still be pointing in the same direction right because the negative Z is our forward direction but we will have changed orientation and we'll do a quick transform here so you can see that right that's what the new tanks orientation will be and so that's we're going to write some code to do that it's basically three steps as you saw change the Y change the X and then you get the result so here's our tank code and we're going to write a function to do those steps that I'm going to call a line with why and you pass it a transform and you pass it a new Y vector in our case that new Y will be the normal of the slope so we take our transform and we set its basis dot y equal to the new Y which is what we did we set the transforms basis X equal to the negative Z crossed with the new Y and that was the second step that we saw and then the last thing we have to do is orthonormal eyes it and there's a command for that basis dot orthonormalized and then we just return that new transform and so this is our handy little function to take any transform and align it with some new up vector now note that there is a function builtin to the spatial node called look look at the problem with look at is look at will rotate a body to align its negative Z with some vector so we would have had to calculate what the new Z would be and it wouldn't have saved us any time actually would have been a little bit more difficult so this is gonna make it pretty easy so now we need to check if we collided right so after we move so we have to say get slide count get slide collision all right so we get the collision we get the slide collision that occurred and that's going to have a normal in it so we're gonna then set our global transform equal to a line with Y the global transform comma occlusion dot normal okay and so that'll line our tanks why let's see how that looks okay here we go we're gonna go climb up the hill okay now some problems right see that it is changing orientation but it's very there we go it's a little bit of a problem right the problem is happening have you figured it out because we've got we're touching more than one slope at the same time so it's trying to align with both of them and that is a big problem right we don't want that what we really want is to align with whatever one face is right under us see if we're only touching one face we're aligned correctly but as soon as we're touching more than one it's a problem so what we're gonna do to fix that is on our tank we're gonna add a ray cast and we're just going to make sure that Ray Ray cast is enabled and we're gonna point it downwards negative two and it's just pointing straight down from the center of the tank and we'll use that to get our normal so that it doesn't matter if the treads are touching more than one slope will basically get the average we'll get the one that's in between we'll get the one face that's directly beneath the tank all right back over to our code we can get rid of the slide stuff we're not going to use the we're not going to use the Kennebec body collision to get our normal we're gonna use the ray cast so we're gonna say the normal is the raycast get collision normal and then we will use that in our align with why to align just with the normal of the raycast C's so let's see how that looks okay so here we go now as I go up the slopes I am NOT going to stutter when I'm hitting more than one but we are still getting some snapping right because as soon as I cross from one to another I snap to that face which looks very awkward right I'm not getting the chittering back and forth between multiple faces but it is very jerky because the transitions between the phases are very sudden but we can fix that with a little bit of interpolation so instead of taking the global transform and assigning it right away we're going to we're going to take this align with why that returns a a transform right so let's just get the one that was returned and then we're gonna tell our global transform we're gonna set that equal to its self interpolated with the new transform and by how much depends on you I found 0.2 to be a pretty good value right but this is just like any other kind of interpolation this is how much to interpolate this transform towards this one so we're doing about 20% smaller numbers will make it go more slowly but what you'll see when is the result is that everything is a lot more smooth right our tank is very smooth at going over the faces and it transitioning between them because we're not snapping it all the way to the new face in one frame all right and that's it that's how you get a body that will align itself with a surface and this will work if your this work just as well if you're on a sphere or any other kind of mesh that has a lot more normals than this low poly terrain but I think it looks pretty good driving over this rough surface all right I hope this was a helpful tutorial to get your 3d projects going leave your comments and questions in the comment section below and I will see you in a future goodo recipe thanks for watching this tutorial is part of my nugudo recipes website the goal is to collect all the best tips and lessons to help make you a better go to a developer if you like this video I hope you'll go and check out the site and make sure to hit subscribe so you'll be notified whenever I release new videos thanks for watching