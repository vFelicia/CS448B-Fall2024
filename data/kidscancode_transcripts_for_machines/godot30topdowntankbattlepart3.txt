welcome back this is part three of the Godot topdown tank battle game and in this installment we're gonna be making an enemy tank and setting it up to patrol around the map and aim its cannon at the player okay to get started I have made an enemy tank scene this is another inherited scene from the basic tank so I've added that and I've decided to use red for the tanks color and I've got the turret here that I've chosen from the spreadsheet now the way we want the enemy tanks to move can vary but to start with we go over here to the map I'm gonna set them up to just patrol around like for example I might have it go along this little rectangular path here so I wanted to drive along the road and to do that we're gonna use path to D and we'll be able to set up and draw as many paths to DS as we like on the map and then attach enemy tanks to them so they can follow them so let's zoom in here and look at the location where I want to draw the path up close so I wanted to go around this path now I'm gonna add a node to D container that's gonna be paths just to hold these all under there and keep them organized main reason is because I'm gonna draw a lot of them I don't want my node list to get too long I can collapse that list if I want and I'm gonna add a path to D now drawing a path to D hopefully you've done this before if you've done any of the other Godot tutorials I put a path to D in the beginner tutorial if you click on the plus you click and start placing your points now one thing I noticed when I was playing around with this is the light blue color that's used to draw the path is really hard to see against this road and grass background and it actually isn't something that's adjustable I went and hunted around for that it's hard coded in the Godot source code at the moment so so what we can do is on the ground I'm going to temporarily go down to the visibility and I'm going to darken it just so that it'll be easier to see my path when I draw it so let's say I wanted to start here and I want to go to this corner I want to go to here to here to here here and then I'll click the close curve now I have a path going around this little area that my enemy tank can just patrol on alright let's go over to our enemy tank and we're gonna add a script that extends the tank script again and for that once again we need to override the control method so we're gonna control and that's going to be where we put our code for controlling the tank again I might want to do some other ways of enemy tanks moving so they might not always be they might not be always attached to a path followed to D so I'm gonna say we're gonna get the parent so that we can test to see if it's a path follow which I just remembered we need to add over here on our map our path to D needs a path follow to D child there we go now back over on our enemy tank so if parent is path follow to D so if the tank detects that it is attached to a path follow then it's going to do the path follow code and to follow a path you just have to set the offset of the path follow so a parent set offset and then we want to get my parent get offset we want to get the current offset and add whatever the speed times Delta is and then I'm going to have an else in here where we say other we're gonna put other movement code if the tank is doing another kind of movement so let's see what that looks like I set the enemy tank speed to 150 so if I go over here doing my map and I stick an enemy tank as a child of the path fellow there it is let's put our let's put our grounds visibility back up again and let's see what it looks like where oh I just remembered we started over here where we can't see our enemy tank driving so we need to get over here to where we drew him there he is so he's driving along the path now of course one problem we have is that these corners are very sudden and it's gonna make these really sharp turns which don't look particularly attractive I don't like the 90degree snap there so I want to make it look a little bit more natural so we're gonna alter the path a little bit okay so I'm going to redraw my path here so instead of starting at the corner I'm gonna actually start right there and I'm gonna go short of the corners and do a diagonal across the corner like that whenever I have a corner that I want to go through I'm gonna go across there there and to there and close that so now what the path looks like is that and actually you're got an extra one in there delete yeah okay so now I have it going around and that's gonna look better but it's still not gonna be exactly what I want actually I'll show you what it looks like now real quick we'll go in here and run the scene just so you can see oops I hit the enemy tank so now when it reaches those corners it's going to turn right and that's a little bit better still not exactly perfect right and so the way we're gonna improve that even more is by using the path to these control points so this button right here will let you select the control points and what control points on a curve do is let you round the path so see as I pull out there or if I pull out in this direction I can round it here and so I can take these control points and I can I can wrong side and I can round the edges so that these sharp corners will be a little more smooth and the tank will look a little more natural moving along these paths so I'll finish that up and then show you the end result alright here's my nice rounded smooth path that kind of follows the centerline of the road and now when I run it my tanks movement is going to look a lot nicer when it takes those turns all right now the other thing we have the other problem we have though is this these tanks are both kinematic bodies and so when that tank is moving if I get in front of it it can't really go right but now what happens is it's still trying to follow the path so it has now become offset from the path and it's still trying to follow it and that is going to be a big problem it looks very weird so we want to make sure that the path followed to D which is the thing that's moving around the path and the enemy tank keep the same position we want the enemy tank to keep on the path follow so we need to make sure and set our position to zero zero right which is relative to the parent all the time okay and what that's gonna do is if we get in the way of the tank I'll get over here and get in front of it again right it's gonna push me out of the way which is a nice side effect but it's also gonna remain locked to that path follow okay and for a first version of the tank collision that is good enough for me right now now the other thing I want this enemy tank to be able to do is shoot at the player so I needed to be able to turn its turret and point it at the player and shoot but I also don't want the enemy to have you know infinite range so we're also gonna add a visibility ring around the enemy tank so that it can only it only shoots at the player when the player is close enough to be seen so on the enemy tank we're gonna add an area to D and this area to D I'm gonna call the detect radius and that is going to have a collision to shape to D of a circle and we pull that out and we can make that whatever size we want I actually think we'll probably make it a variable so we can make different enemy tanks have different sized detect radiuses but that'll be what it looks like and then we're just going to detect if the player is inside of this circle it will be shot at so in the tank script we're gonna add a couple more variables we're going to add a afloat for turret speed because I want to control how quickly that turret can rotate to turn and point at the player is its if it's slow then the player has a chance to you know navigate around behind the tank and and keep from getting fired at if it can stay away from the aim of the turret and then we're also going to have a radius for the detect rate for the detect so that we can insert whatever we want there so we want to take this variable whatever this one is and let's let's set it so we have a default value to say 200 turret speed I'm going to make it 1 we'll see how that goes so I wanted to take this value and set the collision shapes radius to that and I want to do that at runtime so I'm gonna put that in the ready and I want to get the collision shape it's shape dot radius and set that equal to detect radius and if we turn on visible collision shapes that should let us go over here and see when we run it that we have our detect radius and that's a little bit on the low side I'm gonna actually we can leave two hundred as the default but I'll double it on this guy so that we have yeah that's better so anytime you're inside of that circle that's when we want this turret to turn to point at you but I don't want it to just snap to instantly pointing at you like ours is doing with the mouse right if it goes across it just instantly rotate 180 degrees I wanted to have a maximum speed that it can turn and point towards you so in my enemy tank I'm going to connect the detect radius is body entered and body exited signals body entered and body exited all right and so both of these will detect when a body enters or not now on body entered we're gonna say if body is the player so if it's the player that entered then we're going to set target to the body so now we know what node we are following and then when the body exits now this could be any body exiting so if body equals target target equals null so we want to drop the target if the target leaves the area so now we have our target we've acquired our target when it's inside the circle now we need to aim towards it all right and so we can use the process function for this we're going to if there's a target aim the turret so first we need to know what's the direction to the target what's our direction vector pointing towards the target well that's target global position minus our global position dot normalized and then what is the current direction well that I want a direction vector for what direction the turret is currently pointing well that's a unit vector rotated by whatever the rotation is actually the turrets global rotation we want what it is pointing to in world space not in body space and so the angle that we want to set our turret to is going to be a linear interpolation between those two directions and so we can say turret global rotation is equal to current direction so we want to start with the current direction use linear interpolate to the target direction and the amount we want to go is by whatever turret speed times Delta is and then we want to take the angle of that because that that will return a vector and so we want to take the angle of that vector and that's what our global rotation will be kind of a long line but there you go so let's run this on the map and see what happens when the tank sees okay see the tanks turret is not moving but now it is now if I get over here see how it's turning to point towards me let's try this from an angle where it's not pointing towards me alright so as I go around it's pointing at me it's pointing at me I'm only a little bit faster than this tank but see how it's can't quite rotate fast enough to keep up with me if I'm on the opposite side like this it rotates around alright and so we can change that turret speed to adjust that later okay I'm going to turn off the collision shapes so we can see it more naturally okay that's working pretty well so now we have our enemy tank patrols around it can aim towards us and we can aim towards it so I think you can guess what the next part is gonna be about we're gonna add some shells to fire out of our cannons thanks for watching and I'll see you next time you