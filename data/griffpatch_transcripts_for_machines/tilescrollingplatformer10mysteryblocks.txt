hello fellow scratchers i'm griff patch and welcome back to a very exciting part 10 of our series creating a tile scrolling platformer in scratch today we'll focus on the much requested mystery blocks these are really interesting because of how interactive they are you can walk on them head bump them for coins or possibly for other special lucky items and yet they also have this other use for dispatching unlucky gumbas who are innocently walking above them so i can safely say we have quite a lot to cover but i just know you're going to enjoy this one because well it's just so satisfying but before we dive in we have a quick bug fix from episode 9. it was pointed out that when you reset a level in the level editor by pressing the r key there's a bug where the enemies are not cleared see oh man well this is an easy one to fix click on the editor sprite and find the when i receive generate level see here we are already deleting all of tile grid so we need to delete all from object index and from object type lists this will prevent our enemies accidentally being left behind after each level is cleared and yeah there we go great so back to mystery blocks so here i am bumping my head on a mystery block so quite a lot of things are going to need to trigger off this action what we'll do first is make a record of the tile that was head bumped click into the mario sprite and find the when i receive move player script create a new variable named bump index for all sprites we'll store which tile was head bumped in this but first we'll make sure to reset it to the empty value before we begin moving our player each game tick vertical collisions occur in the move sprite y block here and when we bump our head we currently set jumping to 99. let's make a new custom block named bump head and drop it in to the same place this is going to be relatively simple we want to check what tile is directly above us we can use get tile at xy with an x of mario's x variable and a y of y plus height to get the top of mary's head but then we'll also add 8 to it i just picked this number here so if the tile above mario's head is costume 20 it's a mystery block then we set bump index to tile index yes that records which tile we head bumped we can test that this works as i jump and head bump the mystery block you can see bump index flashes a value great that's all we need now to trigger all the animations and actions from this block the first thing we'll do is make the mystery tile react to being bumped switch to the tile sprite code and find the when i receive position tiles script look down towards the bottom and see where we are handling animating blocks here this includes mystery blocks that is costume 20. so for starters we can check whether this tile has been bumped by comparing the new bump index with the tiles tile index variable if it matches then it has just been bumped so we can replace the bumped tile in tile grid with a simple gold block that would be costume 9. run the project and i can now head bump these tiles to change them to simple gold blocks that's good but to be really good we need the tile to jump up and down too in response to being bumped we'll use a little math trick for this effect make a new variable named bumped for this sprite only and set it to 180 when bumped 180 degrees is half a circle we are going to trace the curve of a half circle up and down to simulate the jump of the tile so before switching costume add in an if checking whether bumped is greater than zero immediately subtract 30 degrees and then change the y position of the sprite by 24 multiplied by the sine of bumped this offsets it up from its real position while bumped is still greater than zero and we test the project again now when i bumped my head the block gives a satisfying little jump very nice next up we shall add the default jumping coins animation this occurs on any mystery block that does not contain any special object when a block is head bumped a coin should bounce up into the air from the block come down and vanish the player does not need to collect it so it's really just there to look nice giving the player some great feedback because of this i would classify the coin as a particle effect click into the particles sprite at present these only support dust smoke particles that are cloned at mario's feet this is going to need an upgrade to support more particle types okay click back into the mario sprite finding the make skid smoke oh man this typo is still there i'll just rename it correctly there make skid smoke right we are no longer going to create a clone here this is too limiting without a way of saying what type of particle we are generating instead make a new list naming it particles for all sprites this acts like an instruction list of the particles we want to generate we first add the type of particle smoke then the x position and finally the y position that will be y minus 20 to position it at mario's feet as before now back to the particle sprite start by deleting all the particles under the green flag the when i receive position tiles scripts are all about animating smoke particles at present we'll need to diversify this so make a new custom block named tick smoke and move the smoke handling scripts into there that's everything after the first if statement we can then pop the tick smoke block in their place now what about this new particles list we want to loop through it to create the new particles start by making another custom block naming it spawn particles make sure to tick the run without screen refresh and we'll use it here when frame equals the empty value only cloned sprites have the frame set so this ensures this is only run on the original sprite not a clone so we repeat until the length of particles list equals zero we'll be removing the items as we go so once it's empty we'll have finished processing them we can begin by setting the type x and y variables from the particles list just as we'd put them in a moment ago from the item one two and three next just create clone of myself to spawn the particle with these variables finally delete those first three rows from the list and then allow the repeat loop to continue in case there are more particles to be spawned almost there just come back to the when i start as clone and remove the old set x and set y blocks from here as these are now set before we clone the sprite and we are good to test we should hopefully see the clouds of dust still appearing at mario's feet but now we have a much better system of for particles that we can extend to support other types so let's add a coin particle click into the tile sprite and we are still editing the when i receive position tile script right here after setting bump to 180 we want to also spawn a coin particle we do this by adding to the particle list first the particle type of coin then the x position tile x and the y position tile y but to ensure the coin spawns above the block we add 32 to it now click into the tiles costumes and we'll copy in order the four coin costumes across to the particle sprite dropping them like so we'll also copy the big costume costume one while we're at it switch back to the particle sprite and it's time to code the coin particle type in the when i start as clone check for a type of coin you want to give this particle some vertical velocity to jump it into the air so make a new variable speed y for this sprite only and set it to 12. that will give it a nice big vertical bounce next to handle its actual movement under the when i receive position tiles check for a type of coin and then make a new custom block naming it tick coin we'll run this for the coin particle not forgetting to stop this script to prevent it continuing to run the smoke script below now this will be a pretty standard movement script for the coin we change speed y by 1 for gravity then and this is a little different we check whether the speed y is less than minus 12. since we began the coin with a speed of 12 once it has reached a speed of 12 it will have gone up and come all the way back down again so we can delete this clone now change the y of the particle by speed y next we need to position the particle on the screen and set its costume so we are doing this already for the smoke particle above perhaps we can rationalize this with yet another of my favorite custom blocks make a new block naming it position with costume with an input of costume and we can move the go to xy switch costume and show script from the smoke script into here leave behind the change frame and bring in a new position with costume here now this floor of frame is specific to the dust particle so move it back to the costume input here and replace with the costume input variable from the define block now it would be good idea to add a switch costume to big at the top to allow these particles to move off screen this is more likely to occur for coins than it did for dust particles as coins are jumping up high so now we can use this script again for our coin particle duplicate the position with costume and the change frame and bring it down here but we'll switch the 0.4 to a 0.5 for a slightly faster coin rotation now the coins costume run from costume 3 through to 6. we can allow the looping through using the frame below with the math 3 the first coin costume plus mod four as there are four costumes and the floor of frame on the left of the mod that should do it cool are you ready for a quick test run the project and jump into a mystery block yeah that's what i'm talking about the coins ping up nice and high spinning and return back down before despawning that looks good don't you think what's great is that we are also all set to add even more particle effects going forward right then spawning coins from mystery blocks is cool but well they wouldn't be mystery boxes if they didn't sometimes contain more interesting objects for our consumption our next task therefore is to be able to place a powerup of our choosing inside a mystery block click into the enemy sprite and look at the costume tab right at the bottom you'll find a mushroom named life it may seem off to count this as an enemy but except for the fact that it won't kill you the live sprite will share a lot of the same game code as a goomba and we have already added the ability to place these sprites over other tiles in the level editor this is super useful for what we're about to do start then by copying the live costume to the tile sprite i'll just check in the tiles and there it is costume number 30. we should map this to a key in the level editor so click into the editor sprite and make the tile key map visible add a new item for costume 30. and we'll map it to key 9. that's the enemy category do you remember this is special for placing enemies over other tiles make sure to click off the item to save it in the list if i run the project and enter the level editor i can press the 9 key twice to select the mushroom tile i want to be able to drop this on a mystery tile although i can click it nothing appears that's okay though we should have expected this this tile will have been recorded in the object lists but we have yet to write any code to spawn this type of enemy in the enemy sprite so let's do that click into the enemy sprite and find the define spawn type script this script is responsible for spawning enemies which at present is solely gumbers we need to extend this to cater for more enemy types specifically a life mushroom at this time we are going to make a custom block again for the scripts that are shared for all spawning naming it set type with an input type then a label and an input both named costume a label input width and a label and input for height start by moving the set type to goomba and everything below into the new define script then replace it with the new set type custom block the type costume width and height inputs must be filled out the same as they were for the gumba so i'm just copying and pasting the values from the set variable blocks that then allows us to link the input variables up to their matching set variables as a quick way to set all four of them in future next we'll take the top four set x and y scripts and move these into the define set type script too i'll pop them just under the set height block i just noticed we can safely remove the set type and hide block from there as this was left over from when we spawned goombas with the g key the enemy spawning loop already takes care of this at the end right so now we can more easily add a new type of enemy sprite to be spawned type 29 was a goomba so duplicate the if and instead look for a tile type of 30 our mushroom lifestyle we can fill out the set type block with the input values of life for the type and also as it happens the costume name too and both a width and height of 16 pixels now where the life differs from goomba is that it doesn't want to be activated when it moves onto the screen we did this by setting frame to the empty value so instead let's set frame to 1 before the set type block this will be our new way of indicating that an enemy sprite is hidden until we say otherwise to make this work come to the bottom of the define set type custom block and surround the show with an if block put in an or then on the left we always show the sprite if we are in the level editor that is editor is greater than zero the other condition where we show right away is when frame is equal to the empty value that way when the frame is 1 like we just set it it will stay hidden except of course when in the level editor which is just how we want it let's run the project so no mushroom is visible yet did i manage to place one i'll enter the level editor ah great there is the mushroom i placed earlier it did work so that special frame of 1 is working but i can still headbutt this mystery block containing the mushroom and get a coin that isn't right we need to turn off the coin particle for the tiles containing objects click into the tile sprite we are still in the when i receive position tile script now add in an if around three add particle blocks to check whether a tile has an object in it we just need to refer to the objects lists use the item hash of object idx and look for tile index to see if we can find that index in the list if there is no object at the location then the result is zero so we then allow it to spawn the coin as normal we should test that again just to confirm that the last mystery block is no longer spawning a coin particle yep perfect but now for the more complex job of triggering the mushroom sprite to appear instead click into the enemy sprite and find the when i receive move enemy script now scroll down the script to where we check for frame being less than zero if you remember this is triggered for idle enemies that is looking for them when they're about to come on screen well now this is also going to be triggering for our hidden enemies too we need to handle these hidden ones specifically so add in a new if as the first block within that if checking for a frame of minus 1. these tiles should be activated not when they come on screen but when they are bumped so if bump index equals the enemy sprite's spawn index that's where the enemy sprite spawned on the level then we show the sprite make sure to add or stop this script under the if so that hidden sprites don't process any further now let's give this a test ok this is a good start the mushroom is indeed showing when we head bump the tile but this isn't quite the desired behavior we need the mushroom to emerge from behind the mystery block so remove the show block and instead we will set frame to zero this means the enemy sprite is no longer inactive we'll also point in direction although this isn't really used yet setting it to the same direction as the mario sprite lastly and i have to say i was in two minds about how to go about this to get the sprite to appear behind the mystery block we will tell the sprite to go to the back layer handling sprite ordering in scratch is a pain and deserves a tutorial video all of its own so watch out for that okay we'll also add a go forward block add a new variable named layers background and we'll use this in the go forward this is here ready for when we add in a scrolling background as we will then be able to set this variable to the number of background sprites that we should stay in front of now scroll down to the bottom of the script where we are handling the processing of goomba with a gumba tick block let's duplicate it changing the if to look for a type of life remove the tick number and we'll make a new custom block named tick life run without screen refresh and pop it back within the new if followed by the stop this script i'll move this into some space okay well pop the show block back in here so that we can see what's going on and run the project now head bump that block did you see that the mushroom block appeared behind the block now but you can only just see it before the mystery block returns and covers it up again to avoid it being seen we'll need to delay it appearing for a few frames after the bump occurs and only then show it before allowing it to rise up out of the block below to change frame by one and then check if it is less than 16. if it is then stop this script that will prevent the mushroom appearing for around half a second next bring in an if else block checking for frame being less than 48 then we show the sprite and slowly move it upwards by changing y by 1. now how did we get the value 48 here we need to slowly move the mushroom up by 32 pixels that's a full tile but frame is already at 16 before we start moving so 32 plus 16 is yep 48 cool let's give it a test going straight for the mushroom block and oh yeah that is looking really exciting excellent work you've all been waiting patiently a long time to see this mechanic working now although we are not going to implement any actual powerups in this episode we might as well allow the player to pick it up so after the mushroom is finished rising up in the else here check whether it is touching mario and then we'll simply delete this clone for now this is also where we'll be able to trigger any special powers future and let's see yeah that works for me so how much time do we have left can we fit in goomba flipping from above a bump block i don't feel the episode would be complete without it yeah let's go for it in the enemy sprite make a new custom block naming it check flip if bump index is less than one then no tile has been bumped and we can just stop this script there's simply nothing more to do so if a block has been bumped is it one of the tiles under the sprite's feet let's check the tile under gumba's left foot first using a get tile at x y with an x minus width for the y position we'll use y minus height but then also subtract 8 pixels more to ensure we are looking at the block below now if the tile index of this tile we are checking is in fact not equal to bump index then we know the left foot was not bumped so we might as well check the right one instead duplicate the get tile and if block and replace the x minus width with an x plus width if the tile index is again not a match for a bumped tile then this gumbo is safe and we stop this script but if we got past these two if checks then gumba must have one foot on a bump tile either left or right so set their speed y to 14 to bounce them up into the air and then set speed x to the direction of mario divided by 45 that should be a good speed although i'm wondering in retrospect whether we should not have set the speed x at all and just left it as it was feel free to check for yourself which looks best okay almost ready to test but we haven't yet used this new check flip block find the define tick goomba script and pop it right at the end like this now run the project i'm quite excited about this already and take that gumba oh yeah let's do it again oh man this is too much fun to make it authentic we just need to flip the sprite upside down and let them fall off screen scroll back to the end of the define check flip script and set type to flip this will work like our squish type we made in a previous episode we want to make the sprite appear upside down so set the rotation style to all around and finally point in direction minus 90 negative 90. now find the when i receive move enemy script and add a new if type equals flip just above the type equals squish check we just want a simple gravity motion here so change x by speed x change speed y by 1 change y by speed y lastly we'll find out when they fall off the bottom of the screen with an if y is less than camera y subtract two hundred and then we delete this clone we should just drop in and stop the script to conclude the flip sprite script and that's it job done episode complete smash that green flag and watch that gumba fly wonderful look at how he flips upside down and falls off screen it just works so well and it's so satisfying that we have got this far we have certainly covered a lot of ground today and having the mystery blocks functioning really livens up the game a lot so pleased it wouldn't take much to add all sorts of different items to pop up from these blocks now so do feel free to mess around and add your own also why not try adding some powers to mario or a life counter there's still so many directions we could take things and although i am basing the tutorial heavily around mario mechanics that's only because mario does them so well you can of course make any platformer you wish from the same game engine just let your imaginations run wild well i do hope you've been able to follow along and that your projects are looking amazing in the next episode i'm expecting that we'll look at the player losing a life and perhaps adding some other visual eye candy like the scrolling backgrounds but we'll have to see as i know there are many other highly sought after features yet to be covered if you've enjoyed this tutorial then smash the like button and don't forget to subscribe to the channel to avoid missing my next exciting video so thank you for watching and scratch on guys