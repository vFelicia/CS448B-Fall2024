foreign scratchers welcome to part three of our tutorial creating an RPG game in scratch last week we ended on a bit of a cliffhanger managing to create a scrolling tiled map but at the expense of super lag but don't panic this was because we were painting the entire level each and every tick of our game Loop but today we are going to blow all those problems away and Achieve silky smooth scrolling goodness by implementing a viewport that is a scrolling window into the level where we only Stamp Those tiles that are actually on the screen we just need to be careful with our maths to ensure everything stays lined up and if all goes to plan well stick around to see what a transformation this will bring I'm so excited to get started come on guys let's get scratching load up your projects from episode 2 and while we're at it save them as a new copy for this is episode three we ended up setting the map size back down to a width and height of 32 tiles gmax of 32 however you will probably have noticed that this has issues of its own and we are still not able to scroll much further than yeah this not to worry though this too we will fix this episode so we'll Begin by clicking into the tile Sprite you can see the width and height of the grid of tiles being stamped is specified by gmax in these two repeat blocks so that's the entire grid width and height remove these so that we begin by reducing the view window back to 10 by 10 tiles but if we run the project now you'll see our level is looking rather messed up and that's because we are still assuming this tile is the one that follows this one and boy is this not true any longer to fix this we need to skip all these items how many is that it's a full row gmax subtract however any tiles we've already stamped so at the bottom of this Loop change gidx by and we subtract from G Max this number 10. do this right before we loop around to the next row and as if by Magic smash that green flag pow we are back in business but rather than a scrolling window into the level our window of tiles is not staying put it's just scrolling off with the tiles we need to keep Shifting the window back into view like we did with the original scrolling background remember how we did that where we previously subtract cam y we now replace it with Cam y mod 32. and similarly replace cam X with Cam X Mod 32. so what effect does this have on our running project what have we done this looks like a big step backwards Don't Panic the good news is that the stamped tile window is now staying in position and not scrolling away the bad news is that our window is restricted to the top quarter of the screen and we'll fix that later but more importantly we don't appear to be able to escape the bottom corner of our level no surprise there though after all we always begin painting by setting gidx to 1. now we need to ask scratch to begin painting from the tile we have scrolled across to well let's start with walking left and right how can we tell how many tiles across we walked we simply divide the X position by 32. the tile width let's see cam x divided by 32 is 1.4 that's more than one tile and means I need to increase gidx to start painting from the next tile gidx needs to be a whole number though so bring in a floor block the floor of camex divided by 32 is 1. nice we rounded the number down so let's just add this to the initial grdx setting G idx to the sum of the original one and this new offset calculation time to give that a try if I walk off to the right yes I've escaped to the left edge of the level let's see if I can get back again oh cool loving that so how about up and down uh nope we are only accounting for the camex thus far bringing a change gidx by and we can duplicate the floor of block but we need to switch out the Chemex for a cam why but not so fast this will tell us we've scrolled up by one two three tiles but to start painting from a whole row above us we need to add not one but G Max right so multiply this floor value by G Max and put it all back together I'm excited to see this in action pump that green flag and yes we have it in the bag we can scroll up and down left and right and the viewport moves with us it's probably worth noting if we take a walk further left we begin to see our level wrapping around and that is expected and nothing to worry about our level Grid list wraps around after all and inevitably so does the stamping if we let it great I think it's time we expanded our scrolling view to fill the screen the 16 here is the vertical starting position we need to move it downwards by half of the screen height that's 180. so using a subtract block take the number 16 and subtract 180. pop that back into the set Y block and we do the same with the set X block 16 subtract but this time 240 that's half the width of the screen good run the project nice the level is offset from the bottom left corner now how many tiles wide should it be just to cover the screen 1480 divided by 32 is 15 but we always need one more for when the screen is midscrolled so 16 for the inner loop for the vertical we need 360 divided by 32 that's 11.25 well we round that up to 12 but add 1 for the extra tile and that is 13 tiles okay you'll note our level painting has gone awry again and that's because we have a 10 here that is supposed to be the viewport width we up this from 10 to 16 so change that here too popular 16. good that is looking sweet so nice to have the whole screen filled but hold on restart the project shouldn't we be starting standing at the bottom left of the level as before yes we should we shifted where we began drawing the tiles but we didn't shift what we were drawing that will require a change to the initial value of gidx our index into the level Grid list so if you look here gidx is calculated from cam X and Y that's the center of the camera view on our level map but we want to draw from this point we'll calculate this and store it in two new variables create them now GX for this Sprite only and gy also for this Sprite only then set GX to 240 less than cam X that is Chemex subtract 240. and set gy to cam y subtract 180 brilliant this is our new starting point now we simply replace each Chemex below with a GX and cam y with a g y sweet guys it's Flag crushing time are we positioned back at the bottom left as expected and yes we are that is such good news of course this now amplifies the issue of the wrapping level so perhaps it's time to address that next click into the player Sprite and find the when I receive tick player script see this is where we set the Chemex and Y variables all we need to do is prevent these going out of bounds if cam X is less than now this should be half a screen from the left edge of the level that's 240. then we set kamex back to 240. now it can't go any further left than that run the project and note we have indeed begun right on the far left of the screen we can't see the wrap around level anymore scrolling only kicks in as we move further over to the right I'm loving that let's do the same for the bottom Edge if Cam y is less than 180 then set cam y to 180 that's half a screen yep now we can't scroll down off the bottom of the level either that's beautiful there is of course the right and top margins to consider too okay if cam X is greater than so what is the full width of our level in pixels multiply gmax by 32 our tile width oh it's 1024 but we also need to subtract half a screen width from this so drop that in the left of a subtract and take away 240 from the total then set cam X to the same number duplicate the G Max times 32 all subtracted by 240 into there and does it work it sure does nice one last boundary to consider the top boundary duplicate that last if check and change the cam X4 cam y and 240 for a 180. the Chemex for a cam Y and again 240 for the 180. and we are really on a winner now great work I just love zipping around this level gotta say starting at the bottom corner is now looking a bit weird let's move them further out find the when flag clicked and set player X to 240 and player y to 180 and that should do the trick great wow this episode is nearly over but just before we finish I want to bring us back full circle you see how our bushes are missing any grass behind them a lot of the Overworld tiles need grass behind them to make them look complete and this is why we have a large background grass Sprite ready to go if we can display this behind everything then we can save ourselves drawing a whole screen of smaller grass tiles first click into the level store Sprite since this tile of 44 is a grass tile we can replace it with an empty tile all blank tiles will soon be replaced by grass anyhow so click back into the tiles right now what do you think will happen if we try to switch costume to an empty value from our list well it will fail so the costume will stay as the big costume which in our case just happens to be transparent so running the project this does actually work okay however it's much more efficient and that is fast if we don't stamp these blank costumes at all so bring in an if block and check if greater than and is this item of grid greater than the empty value we can place the change Y and change gidx blocks below the if and the switch costume stamp and switch costume back they all go inside this if there now we only do this extra work if the tile is not a blank tile this makes a scrolling engine hyper fast I mean really really fast all that's left is to bring back the large scrolling grass Sprite behind all of this for that to work we need to scroll up to the top of the paint script and remove this arrays all block otherwise this would just erase the background grass before drawing the tiles on top now click into the background Sprite you might wonder why we can't just make this background Sprite visible nope that won't work you see a Sprite always appears over the top of any stamped Sprites so our level will disappear the only way to get this behind the stamped costumes is to stamp the background costume too so drop a stamp block at the end of the paint background script oh yeah right away I can see that looks great but I am aware yours might not look the same and this is because if your background Sprite happens to be ordered behind your tile Sprite then the tiles get drawn first and this background is stamped on top so to ensure things work correct use a go to front to ironically paint the background first and have it appear behind the tiles drop that in to our green flag script for good measure right guys things are looking good but just how fast is this new engine we've built perhaps you'd like a comparison simple click back into the level store Sprite and put gmax back up to 100 tiles across and up yes that's a 10 000 tile map once more and you remember what happened last time we've run the project and wow yes it's not a problem anymore we can walk the level without a stutter what an improvement right in fact if we turn on turbo mode by shiftclicking the green flag then we can see just how fast this project can now run oh my word look at that I can run across the entire map in a second that is super fast what this means is that we have Oodles of processing power to spare which is great news of course you could argue that this is because our level is pretty sparse and we aren't drawing much yet well okay shall we Spruce it up just a little before we finish find our add to grid custom block this is where we are adding tiles to our map I want to drop in a few random bushes we can do this by randomly replacing any otherwise empty tile so bring in an if else condition around the ad block and while we are thinking about it duplicate that Adblock so that in both cases we will be adding to the grid list so that extra tile I want to add a bush and that'll be tile costume number 79 so pop that in there now for the condition to switch to the bush we need an and operator and the first condition is that the tile being inserted should have been an empty space the blank value but so as not to replace all empty space with bushes the second condition is to compare a random value between 1 and 10 with the number one this means one in every 10 empty tiles will be replaced by a bush get it let's give it a run and see nice now we can see the scrolling map much clearer with all these bushes to keep us company you can play with the random number to add greater or fewer bushes to add more just reduce the 10 down to three or two half of the three space is now bush but perhaps we'd like a little more variety than just these bushes if we check out the tile costumes I'm looking for the long grass blades ah here they are 76 and 77 just before the bushes in fact in the level store we can drop a pick random into the add to grid block itself and choose between 76 and 77. now that's cool it's fun just playing with these settings I wonder what you guys can figure out one thing we could do is extend all the way from 76 up to 79 and that would include the two bushes too yeah it's like we are in this huge Meadow if you really want to push this thing why not just fill the level with a completely random tiles from 20 to 400 and I mean every tile so one of one equals one ah crazy yet I love it this really shows what the stamping engine is capable of in fact why don't we test this with the turbo setting too oh yes look at this now it is slower than the previous test but well it's still way way faster than we need it so this is truly excellent great work indeed so we have a very robust and Speedy scrolling stamped child engine I hope you're as happy as me with these results I'll just return my level generator to its previous settings because this is the end of the video now but while you wait for episode 4 why not play around with the level generation code 2 it sure is a blast if you enjoyed watching then please smash that like button that's right smash it only carefully so as not to miss it and then make sure you're subscribed to the channel so as not to miss the next epic episode you know Bell icon and all because if you've seen the level editor I've got planned then you won't want to miss it indeed if you can't wait then you might consider joining the Early Access membership or even the Inner Circle membership to gain access to the projects themselves but on that note we must finish so thank you for watching have a great week ahead and scratch on guys foreign list wraps around after all and inevitably so does the stamping if we let it