this video is brought to you by our own Metta thank you so much for donating if you want to support breakage yourself you can go to patreon.com/scishow cheese thanks for tuning in at brac ease hello everyone and welcome to this video and creating a multiplayer fears in unity today we will do a bunch of different stuff so we'll be fixing some box we'll get rid of some warnings we'll be adding a cursor lock to the game so when we're not in some kind of menu and we're in actually playing we will get rid of the cursor and censored in the middle of the screen so it won't get in the way and we'll also be adding a joint room timeout so if you try to join a room but for some reason you aren't successful it will just count down from X amount of setting seconds and when it reaches zero it will just stop and say failed and you can try and join another one so yeah some exciting stuff also will mention that since the last video I have created a the first video in game theory which is patreon funded because we reached level two and I think it turned out really well this one is on vectors so if you're interested in that you can click the link now and without further ado let's jump right into it so you can see that I'm community and the first thing that I want to get rid of it's just all of these annoying warnings that are there as soon as we put up our projects and these are because of the crossplatform input initialized script that is part of the standard assets that we've imported so let's just double click that and basically in Visual Studio and this is super nice it underlines all of the all of the parts that we can just go ahead and get rid of so everything with these Green Wave's under them we're just going to remove that we can get rid of this one and these one and basically this doesn't really matter but if you want to get rid of the warnings this is the way to go it's because some of these like the vp8 and blackberry are obsolete so let's just save that and you can see that that should clear out our console so that's really nice and another warning that I want to get rid of is when we go in here and create a game here and he created room you can see it says the reference script and this behavior is missing and that is just because if we go to our and find our prefabs and then the I believe it's the fire it's much it might not be under our prefab so let's just doubleclick this and it should select it so this is also under standard assets we should just go ahead and remove this empty script right there and I believe that that should fix both of them so now when we clear out the console here hit play and try and create another room here you can see that we have serial warning so that is perfect so the next thing that I wanted to do and I've actually gone ahead and compiled a little list here of things that I wanted to do so that was the warnings it's fix the host game disconnect buck and that basically means that if we try and hit play here and we want to create a room room and we hit create room and we then leave this room and try to host a new one test create room you can see nothing is happening here and the reason why is that we have now lost the connection from our modules host game create room button here you can see that the on click event here doesn't have any connection to any object and the reason why is that the functionality for that sits on our network manager and our network manager is transferred on to the next scene and so when we go back here it has lost that connection so what we will do instead is we'll just copy this host game component and remove it from the network manager and create an empty game object that will just reset the transform on and whoops if I can stop dragging out the lighting there and we will call this one host game and we can then just paste that component back in as new just the way that we did it with our join game and you can of course make those on the same object but I'll just go ahead and separate them out into two different ones and then under our canvas modules host game create room button we can now drag host game under that on click event go under host game and here create room and we'll have to do the same with the room name input so you can see there's also an on value changed here dragon host game go host game and then let's select the set room name as a dynamic string so we will pass in whatever is in the input field so that should indeed get rid of that bug there so now if we try and create a first room hit create room and we leave that room and try and create a second room here you can see that that now just simply works except it took a bit of time there but it actually works so that's fine cool so the next thing that I wanted to go ahead and do is fix the spawn bug and I'm actually going to add another thing here and that is the spawn menu continue button I think we should have one of those so now let's begin by fixing this spawn bug and what I'm talking about here will become very much more apparent if we go and find our main menu and we have the nice level here and we take find our spawn points here so focus in on those you can see that we have one on the ground here we have one another one on the ground here and then we have one on top of these platforms and it is when we spawn on top of these platforms that this bug becomes very apparent so let's just try and disable all of the other spawn points except that except for the third one here and let's see what happens if we now go back into our lobby and try and create a game let's try and create a test room here and you can see that we spawn on top of this but you can see that currently we are flying a lot higher above the ground that we normally would so we have this weird kind of offset position and the reason why is actually really simple it is that if we find our player and find our configurable joint component you can see that we have currently set it to auto configure connected anger and that means that the kind of the anger point from where we do all of our configure will join our calculations will be set depending on where I respond so if we spawn at a higher point it will be set higher and that is not something we want we want this to be fixed so we'll just remove that all right uncheck that and then we'll have the connected anger be zero one zero so that we will be anchored at one unit above the surface so if we now try and hit play here and this should actually work so let's just create a room here and you can see that we're now standing on the platform correctly and we jump down and everything seems to be working cool so that got rid of that bug and that was all for that cool so now we can go ahead and add a spawn menu into our or that is not correct I wanted to say add pause menu continue there we go so right now when we are in our game here if we go under our main level and we need to reenable all of our spawn points here and we drag in our prefab player UI and we enable our past menu and let's shift to 2d mode and hit F to focus in on this you can see that we only have one button which is the lead room I basically want to add just another button that very simply continues the game instead of leaving so that we don't have to use the Escape key in case the user I don't know forgets or accidentally opens the boss menu and yeah it's just a cleaner way to do UI to have a button there as well so the first thing I want to do here is just bump down the redness of this button I think it's a bit too much something like that looks better and now let's duplicate this and we can rename this one to continue button and we can take this and drag it up to be right above and we can change the color here to something darker like a dark gray and let's go ahead and change the text as well here to continue we can select both buttons and we can maybe drag them down to center them and then we can take our continue button move it up here and let's now change this on click event so under our past menu is where we currently call a function called Lee room but we don't have a function in here for toggling the spawn menu or post menu I keep doing that on and off that's actually sits under I'll play a UI script so under I'll play UI you can see we have a toggle pass menu and all we really need to do is make this public for us to be able to go to a continue button and access it from there so if we're now dragging our player UI and going to play a UI and then whoops not send match message upwards I want to go toggle pause menu and it should actually be that symbol so if we now hit apply on this and remove the player UI again and hit and we cannot hit play directly we have to go through the lobby here so let's find a lobby here hit play and let's create a test room and when we now and we just have to wait for it to actually join here okay so okay I forgot to disable the post menu here so let's say find our player UI let's find our pass menu and we'll just have that disabled by default so let's hit play again here and try that out so create a room and when we go into the past menu now you can see that we can continue or leave the room and if we decide to continue we just jump right back into the game however you can see multiple problems with this at the moment one is that we are able if we open the past menu while holding down a key we'll keep moving that in that direction and also the same with the mouse so if I drag around here and over the past menu you can see that we don't lose that momentum so let's fix that along with adding in a cursor lock which was also the next point here cool so in order to do this what I want to bring up is our player and find the player controller so in Hue undo our update method we have a check to see if the past menu is currently on what I want to do is right below this that means whenever we aren't past I want to check to see if our cursor is locked and if it is not then we should go ahead and lock it right away so I'm going to go if and then we can go cursor dot a lock state and if that is not equal to cursor lock mode dot locked and you can see we have three options here we have confined which means that well the curse is confined to the game and window but it can move anywhere inside the game window we have locked which basically just sets it to the center of the game we know and we have none which means that it can move as it wants to so if it's not locked then we want to say cursor dot lock state equals cursor mode or cursor lock mode locked there we go and if we are past so if past menu dot is on well then we can go ahead and disable that so let's we still want to return from all of this but right before we return we can say if cursor lock mode or cursor dot lock state is not equal to cursor lock mode none well then we want to set cursor dot lock state equal to cursor lock mode dot none there we go so and of course this check is somewhat unnecessary you could just go ahead and set it but it's just a bit cleaner not setting it every single frame but one thing that we will have to set every single frame is motored odd move is what we can then say and then we can pass in vector 3.0 and that just means that we will stay in place and we'll do the same with motor rotate vector 3.0 and remember we also had a separate function for rotating the camera up and down so we'll have a motor rotate camera and that only takes in a float which is going to be serum so this will allow us to stay in place so if we now try and hit play here and join a room and test room you can see our cursor immediately disappears so that's perfect if I escape here it comes back and you can see that that just works and also if we try and move our camera here you can see that immediate stops when we hit the passkey and if we try and move it the same thing happens so that is perfect and that is working cool so I believe that was all we wanted to do with the cursor the last thing that I wanted to add in this video is a joint game timer because currently we are using the matchmaking system that unity gives us the Unity matchmaker and that's working fine however one annoying thing is that when you try and when you create a room and you the host then leaves making that room not joinable and you then try to reconnect or other clients try to reconnect just after the host leaves the room won't be cleaned up so it will still appear under the join room list here but it's not actually joinable and it won't cost any errors but it will just say joining joining joining pretty much forever until you hit the refresh button and I think that is bad UI so instead we should tell the user what is going on by having some kind of countdown and when it reaches 0 will say failed and then we'll return to everything to normal so the way to do this is by going on to our joint game script and double click that and we will find the function down here called join room and this is basically called whenever we hit one of the whenever we select one room that we want to join this this here is cold and we can see that we join the match we tell the network manager dot match maker to join the match then we clear the room list and we set status text equal to joining so let's expand upon this a bit and in order to give ourselves some more control with waiting and stuff like that let's also go up here and use our import system dot collections so this allows us to use an ienumerator so let's do that so let's create an enumerator here and let's call this on wait for join and in here we can clear the room list and we can set the status text and we can also make sure to call it here's let's say start coroutine wait for join whoops wait for join there we go and basically I want to go in here and say wow and we want to do this using an integer so let's have an integer with the countdown and we'll let the Ryan alpha testing will set this to five but I definitely recommend that you go at least 10 seconds and my experience is that at least for joining on the same network unit normally waits at least 5 seconds before joining that is a bit of time but that just means that you have to adjust for it inside of this variable so if you set it to 5 it is going to say failed and then join and that's going to be weird so instead just put at least 10 seconds in here is what I recommend so we'll have this countdown that starts off at 5 and we'll say that we want to continue trying to join while the countdown is greater than zero so when we haven't reached zero we want to keep on counting and status that text here let's move that into the wall and then what we can do here is we can add a bit of code so we can say joining and then we can input the countdown variable so we'll just put a an open parenthesis we'll have the countdown and then we'll have a closed parenthesis and and that is going to look just fine and then we'll have to of course subtract the count down here so minus minus so that we will subtract by one and we'll also have to wait a bit in here so let's put in a yield return new wait for seconds and we'll just wait one second exactly so to explain what's going on here we call join match we start this enumerator we clear the room list we set and we create an integer variable that starts at 5 then we say while this countdown variable hasn't reached zero we want to display the countdown and tell the user that we're currently trying to join and then we want to wait a second and then we want to subtract one and then we want to go back here so then display again wait a second subtract by one until we reach zero at which point if we haven't connected we failed and if we have well then we don't reach this part of the code then we have transitioned to a new scene so that is not something we have to account for so if we get reach this place down here we actually failed to connect and we can show this in multiple ways one way is to just go status dot text equals and then failed to connect and let's just make sure that we display this for a little while so that the user will be able to notice what is going on so let's just wait one second after that and then we can refresh our room list there we go so this should actually work just fine and my cat demands some attention so I would be right back look here he was kind of getting mad because he couldn't jump on the table by himself so now he's up here I might jump on the keyboard at some point but we'll continue the video so we should actually be able to test this inside of unity now so if we go back into unity and hit play and try and host a new game here so let's just call the room test hit create room and let's leave that room and then let's try and rejoin which shouldn't be able to happen so we can see it says joining five four three two one and then it should say fail to connect and it's going to refresh that list however it might say failed to connect and refresh the list but the request that we sent for joining the match might still be running in the background now it's not specified by unity exactly how they handle these requests but it might still be running and you can see there it dropped the connection on its own right to the room and you can see that actually also comes with an error so what we'll do here is we'll make sure to drop the connection and we'll make sure to check if our matchmaker is running to get rid of weird behavior so um in order to do this let's use the code inspired by our past menu for leaving the room so we'll just take this here and copy it inside of our drawing game right before we refresh our room list here so if we fail to connect we want to get some matching flow from the UH network manager and we want to input an if statement here is saying if match info is not equal to null because this might actually be equal to null and if it is we don't want any weird behavior and if it's not equal to null meaning that we do have some match info we want to drop the connection to that using matching photon network ID matching for node ID and then calling network manager dot on drug connection and then we also want to make sure to stop the host so um let's just save that code and that should work just fine however one thing that we still need to do is get rid of this weird behavior here when refreshing the room list so up by where we refresh room list here we clear the room list and then we go on to list the matches but what we really want to do is we want to make sure that if network manager done matchmaker is equal to null then we want to start the matchmaker so the matchmaker might have been terminated at this point and we need to make sure to restart it in case that happens so start matchmaker and there we go so that should actually take care of all of this for us and you can see it's basically the same code as we wrote up here and now everything should run smoothly so we can maybe set this count out to ten instead so that everything works properly and let's now try and build this out and see if we are totally errorfree on both clients so let's build the player here and I think this will work I'm pretty sure this will work and let's try to play on the unity editor here create a test room and that is working that's now of course we have to login on our client here so let's just log in with test123 it log in there and we should transition over to the lobby we can join this game just fine and you can see it's attempts to join here and it says six five and then it should join there we go and we can disconnect from this and we can rejoin if we want to or let's say that we try and leave this room and then try and reconnect here so let's try and reconnect on these two you can see it's still there so we can still attempt to connect but um it's not going to happen and it's going to reach zero here and it's going to say failed to connect and it's going to refresh the list and you can see that the game is still there but it will be cleaned up in a second and if we keep on doing this for about thirty seconds we should see at last that the game disappears but it might just take a little while so it says fail to connect again here and you can see at the moment now if we had refresh it says no roams at the moment because the room has now been cleaned up so that is a much much cleaner way of doing things we cannot help unity clean up these rooms but we can at least make sure that people don't get stuck trying to connect to a room that isn't there so that's basically all I wanted to show for this video I hope you enjoyed it and I will see you in the next video thank you so much to all of the awesome patreon supporters who donated in August and the special thanks to our own Metta Robert Roach James Calhoun vixen P and Andrew Kate