hello welcome to a special coding train Earth Day coding challenge so today I'm going to attempt to make my own version a p5gs version of the climate spiral this is a visualization designed by climate scientist Ed Hawkins from the University of reading so take a look at Ed hawkins's website many other data sets and visualizations of those data sets all around climate so in the spiral what you are seeing are monthly Global temperature anomalies starting with the year 1880 all the way up to 2022 so what is a temperature anomaly it's a fancy way of saying a change a difference a deviation from a longterm global average so what's a longterm global average well we need to pick something so for this climate spiral the period from 1951 to 1980 is used so that that 30year approximately 30year period the global surface temperature for those years is used as a baseline anything else you're seeing is relative to that Baseline line so in the Years prior you probably see a lot of whites and blues which are showing cooler temperatures lower than that Baseline and as the years go on the oranges and reds in the visualization show warmer temperatures global warming the temperatures themselves the data set is from the NASA Goddard Institute for space studies surface temperature analysis they publish an estimate of global surface temperature change and what I want to do here in this coding challenge a is show you how to download and parse a data set using p5.js and by recreating that climate spiral it's giving us an example visualization that communicates and tells a story about a particular data set now there are many other data sets around climate one that you might take a look at right now is the average temperature of the ocean's surface preliminary data from the National Oceanic and Atmospheric Administration or NOAA recently showed that the average temperature at the ocean surface has been at 21.1 1 Celsius since the start of April which is beating the previous high of 21 degrees Celsius set in 2016. a very alarming change the data is clear the Earth is warming helping people to see that and communicate around that data is absolutely a challenge I hope that this video might give you the tools to start thinking about that and maybe you'll be inspired to create your own data visualization around climate all right so first stop is the NASA website uh here we've got an explanation all about the jss surface temperature analysis you can see the latest update here March 15 2023 scrolling down I've got the various data sets that I can download and I'm going to use the global mean monthly seasonal and annual meets 1880 to the present now there are two formats here txt and CSV my assumption is the txt is a tab delimited meaning the data points in the file are separated by tabs and the CSV is a comma separated values or the data points are separated by commas I could use either in P5 but I generally have an easier time working with csvs so let's download that file I can take a quick peek at it just with Mac preview and there we go every year every month and the variation from the Baseline average temperature let's open the file in Visual Studio code this way we can see it without the Mac preview formatting first thing I want to do I think is remove that first row it's important it says what it is Land Ocean Global means but I don't want to have to parse that in P5 I do want the second row there though because those are the column headings for the data all right so the next step would be to bring this file into P5 but I do want to say again whenever you're working with a data set you want to take the time to read the documentation about how the data was collected who collected it and what type of analysis and various other types of things were done in preparation and publication of that data I'll be sure to link to both the 2010 and 2019 Publications that give more background and info around the data collection and Analysis process the other thing I want to do just to make my life a little easier is rename the file I'll call it giss data and I'm going to say April 11 2023 in the file name just as a note to self of when I downloaded it now here I am in the P5 web editor I can upload that data file to use with my sketch open up the file browsing menu click upload file and drag the CSV in I can also click on it and see that raw data here in the P5 web editor as well there's also an excellent FAQ page which covers a lot of the questions that you might have around this data set starting with why it's important to look at a variation from a baseline why are you looking at an anomaly versus the absolute temperatures themselves all right how am I going to get this CSV into my P5 code so it just so happens there's a wonderful function in P5 called load table and this function takes a file name to load into a table object the load table function does all of the string parsing for you so it figures out that the first row are column headers it knows where the commas are and it's going to allow us to parse through and run through that data much more easily and to figure out all the different kinds of things we can do with the table that we've loaded we need to look at the P5 table documentation so the table has baked into it an array called columns which has all the names of the columns as well as an array of all the rows so each individual row of data is stored as its own object so in our data set I think the columns are something like the year and then the name of the months and then each row is a row of data for any given year so I'm going to want to figure out how to write some kind of for Loop where I can look at every single Row one at a time and then iterate over all of the months now when calling load table I also want to give it not just the file name but a string that says what file format in this case CSV and another string with the keyword header in it which will indicate that there is in fact a single row that has column headers so now I have everything loaded into a variable called data and I'm using the preload function in P5 so that it's ready by the time I get to setup now I want to make sure the data seems all right so a couple things I could do one is let me look at get column count and get row count just to see that I have everything there so I have 146 rows but only one column I forgot what I said before that I need to do which is to additionally give it the format and the fact that there is a header aha so by telling it the format it now knows that there are 19 columns that fixes that and then let me also make sure it knows that there's a header row now it knows that there's only 144 rows because that first one is just the headers now generally speaking when I'm working on a project like this I might use a temporary smaller amount of data like just a file that has the first five rows and I also very much want to make sure that I'm looking at the first five rows of data as well as the last five rows to make sure things look copacetic and I can see here that when I get to 2023 I'm only going to want to take January and February so I'm going to need to build something into the code that knows to ignore these stars or knows where I need to end when I'm doing the visualization or analysis but I'm not really going to take my advice here right now I'm just going to dive in and see what I can get to work in the code itself with the full data file let let's try examining just the first row of data the get row function gives me any given Row from the data set 0 being that first row now I can look at the P5 table row object and see what kind of functions I can call there set set num set string get get num get string okay what do I want to do maybe I want to just get the year and the January temperature anomaly great so we can see that from the row I can pull out a piece of data using the get function so the get function is probably going to always give me back the data as a string as text and since I do want the temperature to be a number I will switch this one to get num and you can even see in the console now it's a different color because it's logging it as a number as a floating Point number rather than its raw text all right I think I understand what I need to do because I'm going to need to go through every year and draw a spiral based on those values all right so using Ed hawkins's website as a basis let me see if I can even just set up the months and the various temperature indicators as a baseline as a sort of background before I draw the spiral over top of it I'm going to translate to put 0 0 in the middle all right I'm picking arbitrary numbers right now we can finesse it later but let's use a diameter of 100 for a zero degrees or did we get the data in Celsius all right looking at the txt version of the same data I downloaded it specifically says Celsius at the top so I'm working with Celsius so now I have a circle to show for zero degrees and one to show for one degree I think I'm going to need a bigger canvas and I need one more Circle to put the month labels around so putting the month labels will be a little tricky but thank goodness for all of the videos I've made over the years that use the concept of polar coordinates I'll give you a quick primer here but I will link to many many videos where I've covered this in great depth so if this is my P5 canvas and I'm considering the center to be zero zero based on that call to translate that I did then normally whenever I talk about a point I'm going to talk about its X Y position but if I want to describe a set of points that are following a radial path around that Center I'm going to want to talk about them in terms of their radius and angle relative to the horizontal axis the distance from the center radius that angle using the Greek letter Theta is a common way to notate it so if I want to place the month January over here maybe that's an angle of 60 degrees with a certain distance from the center but I actually need to know the X Y to be able to draw it in P5 and the formula for doing that which I derived in other videos is x equals R times cosine of that angle and y equals R times side of that angle I realize I could also just use translated rotate maybe that would make more sense it's always a question of whether you want to calculate and do the math yourself or use transformations in P5 and by the way I also have videos around transformations in P5 I'm going to think about this as I walk back over there and by the time I get there I'll have picked one method of doing this all right I'm going to use polar coordinates because that's really what I'm going to need when I start doing the spiral of temperatures themselves but as an exercise you might try placing all the labels without polar coordinates and just use translate and rotate I also want to get the labels from the CSV file itself so let me make a array called months well it'll just be a variable called months and I'm going to say months equals data dot columns let's just see console log months we can take out these console logs okay so that's giving me an array with those it does have year in it so why don't I make a copy of it with DOT slice and then months dot splice let me take out that first element splice is a function where you remove an element from an array so now I have an array with all the months in it and let's start the first one at the top which would be zero negative 250. so all the months are being drawn right on top of each other so I need to start moving them according to Polar coordinates so I need to map I which is counting through the array which goes from 0 to the number of months to an angle and if it's relative to the horizontal axis the top is going to be negative pi divided by 2 which is radians for negative 90 degrees I think this is going to be easier to work out if we just think of it from 0 to 360 degrees or 0 to 2 pi and then I'll shift it if I need to and also I just realized that I don't need to use slice and then splice so if you were shouting at the screen earlier I'm now going to fix that I could just actually say slice and give it one which will give me a copy of the array starting with the second element or index one so now X is 250 times cosine of the angle and Y is 250 times sine of the angle oh look at that so I'm not paying attention to the details of my data set there's actually 18 column headers but there's not 18 months so why don't I say from 1 to 13 that's going to give me all 12 months and you can see it's working but January is off to the right so let's just say that angle is everything minus pi divided by 2 whoops not there not the map after minus pi divided by 2 and in the original version December is at the top so let's actually make that happen how would I do that all right so there's probably some clever ways that I could do this but how about I just type out the months in the order that I want them and actually in that sense I don't need to do this shift because I just want to have March be the first one oh they don't line up at the top wait March June July oh I've left out September all right so mine doesn't look exactly but oh no I forgot February no wonder there we go everybody we kind of get all 12 months in people I'm just checking to see if you're paying attention that's all something that would also might be nice is I can rotate the text to line up with that Circle there we go we now have a base pattern for the climate spiral okay it's time for some data let's start by drawing one ring for one year so remember I can get the first row with get row index 0. then what I want to do is use my month's array to get the anomaly value for every single month let's add no Loop and console log that just to see that it works P5 is telling me there is a reserved word value so I'll change that to anomaly and I also could look at the year and the original design put the year in the center so let's draw it there so now I just need a way to draw the spiral and in fact I can use the same exact polar coordinate math to place a data point around this radial path in the same way that I did the months now I need to remember that 90 degree offset because I'm starting from the top and let's try to place the points along the zero degrees right now okay so you can see what I've done is in the same way I placed all the months around the outer ring I've now placed a DOT around the inner ring that is where zero degrees that Baseline temperature is indicated so something I should really do here when I was setting this layout initially I just hard coded a lot of values but now it's very important that I know that zero degrees means 50 pixels from the center and one degree means 100 pixels from the center 150 pixels from the center so let's set up some Global variables I'll call it the zero radius and the one radius maybe the distance between the center and zero needs to be equal to the distance between zero and one so how about 75 and 150. so zero degrees is at zero radius plus some offset for the text maybe 10 pixels this one degrees is at one radius then I need to size those circles correctly and now the X and Y positions of these dots are going to be mapped to the actual data so to figure out what values need to go in the map function I just need to look at what are the pixel values associated with specific degree values zero degrees and one degree are associated with pixel 75 and 150. it's important to note that the math function is really special you don't have to know the specific minimum and maximum of your range you just need to establish some corresponding values between two ranges which I have right here so even if I have negative values it's going to figure out where to place those correctly below pixel 75 and values that are greater than one degree Beyond pixel 150. so those are all the values for 1880. if I pick a different year like row 50 which is 1930 those are the values 1980 and so 2020 would be row 140 great so I believe that this mapping is now accurate but I'm not just looking to place dots I'm looking to connect everything with a spiral pattern so I'm going to add begin shape an end shape and say no fill stroke 255 and instead of a circle I'm going to set a vertex and right now I'm going to put close so that it connects the last point to the new point so what should I do next let's see if we can add another loop to Loop through every single row every year all at once get row count is going to give me the total number of rows so now I have an outer loop going through every row let me bring this in so now instead of hard coding row 140 for the year 2020 I can put in j um undefined let's simplify things for a moment by not drawing the year because I might need to do that in a different way this is maybe the most unhelpful error message I've ever seen my suspicion is there might be some elements of the data set that are actually null or empty we saw those asterisks and that could be messing things up let's see if we can debug this let's put in a console log for the anomaly all right let's try doing just two years that worked three four 100 all right so I must be right it must be getting to some point in the data where there is no anomaly reading and I can see that that happens right there at the end of the data set where the asterisks appear the quick scan I see some asterisks up here but that's additional data that I'm not using so I think we're okay I wonder if the get num will give me undefined so let me just see if anomaly it's not equal to undefined what if I don't use get numb but instead just use get oh oh wow it's able to interpret it as a number even with just get that's interesting oh I was going to say then I could check to make sure it's not a star star and then I thought what I would need to do is say anomaly equals number anomaly but that doesn't seem to be necessary so I'll just leave that commented out sometimes JavaScript is just such a friendly place to be it's like I don't know if it's a string but you want to use it as a number I'll just figure out I kind of get what you want and I'll make it work so look I think we just drew the entire climate spiral there a couple things I think it would make more sense to expand the range so we don't have a lot of values Beyond one degree so maybe I should increase that radius now weirdly it didn't change did I hard code the numbers in the map function I did I did didn't I okay I like this a little bit better it just gives me a little bit more space to work with I'm just checking again to see if you're paying attention I'm pretty sure I misspelled anomaly yeah I did it's with an a oh and I definitely don't want clothes anymore do I want to connect the end of the previous year to the next one I guess that makes sense as long as I don't have clothes at the end why are there so many lines going across the center though that's a little bit weird should I work on animating it first or adding color maybe I should animate this first because that's going to help us see that this is working and what it's doing what I wanted to do so right now the code has two for Loops one Loop to go through every single row and one Loop to go through every single month let's start by doing the years one at a time so I think a better name for this variable would be current row then we get rid of this Outer Loop in fact I'm just going to delete it and then the row is the current row so that's that first row 1880. I can get rid of no Loop and I can start to increase the row ah okay so I'm seeing each year one at a time eventually I get to the end and it's an error and I just realized that I'm not seeing the previous one so maybe what I should actually do well there's so many different ways I could approach this so I could just draw the base background and then let the different years build up but because it's not a lot to draw just give me full flexibility I do want to put that loop back in so the row I want to get is J but I only want to iterate from zero all the way up to that current row so we can see them layering very quickly because I'm doing remember the whole year all at once let's see if we can do one month at a time so now I need a current month and this Loop should be just all the way up to the current month so first let me fix it so that when it gets to the end it doesn't just crash current row equals current row plus one if current row equals data dot get row count then no Loop that'll stop it great that worked what happened to the months oh I put current month there that's the wrong place I put current month in drawing the months I want to see all the months no wonder that didn't work I want to do current months here so every frame current month should go up by one if current month gets to the end that's when the row increases count up all the months oh and then the month has to go back to zero well it's like a little weird radar thing ah clearly I have my begin shape and N Shape in the wrong place let me slow down the frame rate oh oh no no no no no no no no okay the current month is only the current month for the current year so basically if J is less than current row minus one then let total months well I could just say total months is always the length of the array but if J is the last one current row minus one total months equals the current month and then I'm iterating to the total months that's probably a better way to do this let's try that again now there we go that's what I wanted to see okay I think things are good now I would like to move the zero further out to leave more space in the middle because the negative numbers are getting very very close you can up the frame rate now I'm going to move zero even further out I'm also going to make the text alignment uniform for everything and just put text align Center at the beginning of draw all right I want to put what year we're currently on in the center let's make that year a little bit bigger oh no there's another big mistake here which is that the values are starting from the bottom because my angle is offset by pi over 2 so it should start at the top only it really starts at January the first data point is January so it's minus pi divided by 2 plus pi divided by three oh dear minus pi divided by 3. yeah that's right okay so I did this in a terrible way and I'll leave that as an exercise to the viewer to refactor this if you will to be a little bit more consistent about how I'm drawing and reading the data but I do have everything I believe aligned correctly right now and I can add color so I want to do something similar in the same way I'm mapping the distance from the center to that anomaly value I want to map color maybe zero degrees is white and anything less than that is a blue tone and greater than that is a red tone will lerp color work for me oh but the line segments hmm so this is tricky I think I have to draw these as individual line segments now to change their color I think I have to manually connect these I'm going to slow down the frame rate here so I just noticed that with a frame rate of one I have to wait for like a whole empty year because my current row is zero which isn't actually the current row it's the current row cut off which should really be one to start and I guess I could do the same thing with month so for me to draw a color I need to draw each one of those lines individually so I can no longer use begin shape and N Shape instead I need to have the previous anomaly so let me make a variable call it previous anomaly R is the current anomaly and PR is mapping the previous anomaly then I need X1 y1 and X2 Y2 draw a line between both of them this is interesting what do I have here oh because previous anomaly is always zero so as soon as I get the new anomaly now right before I get the new anomaly no no right after okay so after I do this so I just need to save the previous one oh but they need the previous angle but I could calculate that is it silly because I could just look up what was before but maybe it's helpful to store it because then I don't have to deal with like the end points you're really going to make this better after you watch this aren't you please okay let's see here oh I don't have the angle sure let's let's put this inside the if statement there's no reason to save the anomaly if it's bad data oh this is very strange why is there an extra line I guess it's very silly to just store the previous one I know that they're all offset by 30 degrees or pi divided by 6. in the previous one is minus I can't do this for the first value I oh as long as it's not the very first okay this is still working correctly but I'm gonna have a Boolean variable that says first value is false and as long as it's not the first value draw the line and then say first value is true oh is false the first value is true this is the first value so don't draw the line there we go I'm really making a mess with this I think this is correct now I'm drawing them a separate line segments let's get rid of this previous angle concept they don't need that let me up the frame rate so we can kind of I still want to be able to watch it somewhat slowly think it's working Let's uh max out the frame rate I just want to see what happens at the end all right didn't get an error I'm not entirely sure it was hard for me to see if it ended properly because I don't have any color differences to to help me understand visually what's going on but I think it's all all right I think I can finally add color right if I just insert a stroke here like for example with red now all of the lines are red obviously if I add some blue they're all going to be pink and I can put any color in here I want and I'm going to see that color but if we look back at the original reference visualization the colder anomalies less than zero had blue tones the warmer anomalies greater than zero had red tones let's use the Whiteboard for a second to map this out so we have an anomaly let's just say for the sake of argument that the anomaly is somewhere between negative 1 degrees and positive one degree with zero degrees being in the center and I want to have a color that's red over here and I want to have a color that is blue over here so if I ever have a scenario like this the thing that I always think about is linear interpolation or lurk the idea of lerp is I have some minimum value and some Maximum value or they don't it doesn't actually have to be lower and bigger but I have some starting value and ending value and I want to interpolate between them as if from zero percent maybe to a hundred percent so the lerp function in P5 typically takes three arguments a b and an amount the amount being a value between 0 and 1 this corresponding to a and this corresponding to B there is in fact in P5 lerp color so lerp color will do exactly the same thing as lerp it will just lurp the r value the G value and the B value all by the same amount so in essence I could just use the anomaly value as the amount that wouldn't work exactly though because the amount should be between 0 and 1 and my anomalies are positive and negative also if I look back at the original climate spiral the one that Ed Hawkins made at zero the color is actually White so I think what I want to do is have two lerps I want to have a lerp for any negative values that goes from Red to White and alert for any positive values that goes from white to Blue let's see how that goes so in the code I need three colors cold which I'll just arbitrarily set to pure blue I mean we could be more thoughtful about the color palette but I'm not going to be warm which should be red and then I'm just going to call it zero I mean there's a better variable name but they'll have four letters and I love how they line up like that so zero will be just pure white then my lerp should happen between cold and zero or zero and warm depending on if the average anomaly is positive or negative so if average is less than zero my color oh so I need a default color I'll just call it line color well it'll be white if something goes wrong but if average is less than zero then the line color will lurp from cold to zero the bigger the averages all the way to zero oh wait wait wait wait wait wait but average is a negative value zero to a hundred percent zero to a hundred percent just flip the negative to a positive so zero all the way to cold based on the absolute value of that average value stroke line color average is not defined oh I have to make the average I want the average of the anomaly but if it's a line segment I have two values I want the color to be the average of these two values so I do need to calculate that oh no oh no we've got a problem a few different issues one is I'm not using lerp I'm using lerp Color the regular lerp is going to fail but this also isn't working and I think I know what the problem is remember a while ago when I was saying how JavaScript is just so friendly to us it's going to figure it out sometimes JavaScript is just such a friendly place to be it's like I don't know if it's a string but you want to use it as a number I'll just figure out I kind of get what you want and I'll make it work this averaging of the two values is actually concatenating the string so I really do need to convert that to a number and this uh I think parse float might make more sense doesn't really matter those are same parse float is a function that will take a string and parse it into a floating Point ah so you can see it's working now so I should be able to then say if I the average is now greater than zero go between zero and the warm value and let's have this go up by more than just one month at a time so I can see it happening faster how about four months at a time oh because I'm checking if it's equal and current month starts at zero so the one so currently started at zero for it to for four to be divisible into twelve okay this is looking pretty good now it's a lot more red than blue but that's simply because of the of the mappings are equivalent and we're not getting as far to negative one as we are as we didn't we didn't start we don't have a lot of cooler temperatures than the Baseline but boy is the Earth getting warmer which is actually showing now design wise I'm sure there could be quite a few improvements here you can see some of the layout improvements there's actually oh there's actually a ring for negative one that kind of makes sense maybe I should adjust that I'll leave as an exercise to you to think about how you might visually improve this and also I'm looking at this original version right now and as soon as it gets to the end we can speed it up and see what happens you're going to be very excited to see what happens our weights the year is also changing color as it's going to get to the end here comes and look at that all along the Rings were separated by a z position and now we see them as this amazing stack so I would have to do a lot to my code to get there but I think this is if if I don't say so myself a decent version of the climate spiral there are probably imperfections there are many visual design improvements that you could make but I wanted to give you a baseline to look at how you would get through this whole story of downloading a data set parsing that data set and connecting it to visuals so now you if you feel so inclined please take this code refactor it to make it more organized maybe you have a different thought Beyond just Rings maybe you want to add the 3D component change the whole Paradigm of how it's being visualized also I referenced the global C Surface temperatures which are rising at an alarming rate right now I won't include a link to downloading that data that if you want to look at visualizing that data leave a question or thought in the comments about how I could improve this I hope you enjoyed this coding Challenge and that you spend some time enjoying nature and the Earth today which is what I'm going to do right now after I blow the train whistle pop up